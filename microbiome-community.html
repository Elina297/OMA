<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Chapter 9 Community composition | Orchestrating Microbiome Analysis</title>
  <meta name="description" content="Chapter 9 Community composition | Orchestrating Microbiome Analysis" />
  <meta name="generator" content="bookdown 0.24 and GitBook 2.6.7" />

  <meta property="og:title" content="Chapter 9 Community composition | Orchestrating Microbiome Analysis" />
  <meta property="og:type" content="book" />
  <meta property="og:url" content="https://github.com/microbiome/OMA" />
  
  
  <meta name="github-repo" content="microbiome/OMA" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Chapter 9 Community composition | Orchestrating Microbiome Analysis" />
  
  
  




  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="community-similarity.html"/>
<link rel="next" href="community-typing.html"/>
<script src="libs/header-attrs-2.13/header-attrs.js"></script>
<script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fuse.js@6.4.6/dist/fuse.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />








<link href="libs/anchor-sections-1.1.0/anchor-sections.css" rel="stylesheet" />
<link href="libs/anchor-sections-1.1.0/anchor-sections-hash.css" rel="stylesheet" />
<script src="libs/anchor-sections-1.1.0/anchor-sections.js"></script>
<script src="libs/kePrint-0.0.1/kePrint.js"></script>
<link href="libs/lightable-0.0.1/lightable.css" rel="stylesheet" />
<script src="libs/htmlwidgets-1.5.4/htmlwidgets.js"></script>
<script src="libs/plotly-binding-4.10.0/plotly.js"></script>
<script src="libs/typedarray-0.1/typedarray.min.js"></script>
<link href="libs/crosstalk-1.2.0/css/crosstalk.min.css" rel="stylesheet" />
<script src="libs/crosstalk-1.2.0/js/crosstalk.min.js"></script>
<link href="libs/plotly-htmlwidgets-css-2.5.1/plotly-htmlwidgets.css" rel="stylesheet" />
<script src="libs/plotly-main-2.5.1/plotly-latest.min.js"></script>


<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

<style type="text/css">
/* Used with Pandoc 2.11+ new --citeproc when CSL is used */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
}
.hanging div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}
</style>

<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">Orchestrating Microbiome Analysis</a></li>

<li class="divider"></li>
<li><a href="index.html#welcome">Welcome<span></span></a></li>
<li class="part"><span><b>I Introduction<span></span></b></span></li>
<li class="chapter" data-level="1" data-path="intro.html"><a href="intro.html"><i class="fa fa-check"></i><b>1</b> Introduction<span></span></a></li>
<li class="chapter" data-level="2" data-path="containers.html"><a href="containers.html"><i class="fa fa-check"></i><b>2</b> Microbiome Data<span></span></a>
<ul>
<li class="chapter" data-level="2.1" data-path="containers.html"><a href="containers.html#data-science-framework"><i class="fa fa-check"></i><b>2.1</b> Data science framework<span></span></a></li>
<li class="chapter" data-level="2.2" data-path="containers.html"><a href="containers.html#data-containers"><i class="fa fa-check"></i><b>2.2</b> Data containers<span></span></a>
<ul>
<li class="chapter" data-level="2.2.1" data-path="containers.html"><a href="containers.html#assay-data"><i class="fa fa-check"></i><b>2.2.1</b> Assay data<span></span></a></li>
<li class="chapter" data-level="2.2.2" data-path="containers.html"><a href="containers.html#coldata"><i class="fa fa-check"></i><b>2.2.2</b> colData<span></span></a></li>
<li class="chapter" data-level="2.2.3" data-path="containers.html"><a href="containers.html#rowdata"><i class="fa fa-check"></i><b>2.2.3</b> rowData<span></span></a></li>
<li class="chapter" data-level="2.2.4" data-path="containers.html"><a href="containers.html#rowtree"><i class="fa fa-check"></i><b>2.2.4</b> rowTree<span></span></a></li>
<li class="chapter" data-level="2.2.5" data-path="containers.html"><a href="containers.html#alternative-experiments"><i class="fa fa-check"></i><b>2.2.5</b> Alternative experiments<span></span></a></li>
<li class="chapter" data-level="2.2.6" data-path="containers.html"><a href="containers.html#multiassayexperiments"><i class="fa fa-check"></i><b>2.2.6</b> MultiAssayExperiments<span></span></a></li>
</ul></li>
<li class="chapter" data-level="2.3" data-path="containers.html"><a href="containers.html#loading-experimental-microbiome-data"><i class="fa fa-check"></i><b>2.3</b> Loading experimental microbiome data<span></span></a>
<ul>
<li class="chapter" data-level="2.3.1" data-path="containers.html"><a href="containers.html#import-from-external-files"><i class="fa fa-check"></i><b>2.3.1</b> Import from external files<span></span></a></li>
<li class="chapter" data-level="2.3.2" data-path="containers.html"><a href="containers.html#conversions-between-data-formats-in-r"><i class="fa fa-check"></i><b>2.3.2</b> Conversions between data formats in R<span></span></a></li>
</ul></li>
<li class="chapter" data-level="2.4" data-path="containers.html"><a href="containers.html#example-data"><i class="fa fa-check"></i><b>2.4</b> Demonstration data<span></span></a>
<ul>
<li class="chapter" data-level="2.4.1" data-path="containers.html"><a href="containers.html#package-data"><i class="fa fa-check"></i><b>2.4.1</b> Package data<span></span></a></li>
<li class="chapter" data-level="2.4.2" data-path="containers.html"><a href="containers.html#experimenthub-data"><i class="fa fa-check"></i><b>2.4.2</b> ExperimentHub data<span></span></a></li>
<li class="chapter" data-level="2.4.3" data-path="containers.html"><a href="containers.html#other-data-sources"><i class="fa fa-check"></i><b>2.4.3</b> Other data sources<span></span></a></li>
</ul></li>
<li><a href="containers.html#session-info">Session Info<span></span></a></li>
</ul></li>
<li class="chapter" data-level="3" data-path="packages.html"><a href="packages.html"><i class="fa fa-check"></i><b>3</b> Packages<span></span></a>
<ul>
<li class="chapter" data-level="3.1" data-path="packages.html"><a href="packages.html#package-installation"><i class="fa fa-check"></i><b>3.1</b> Package installation<span></span></a></li>
<li class="chapter" data-level="3.2" data-path="packages.html"><a href="packages.html#some-available-packages"><i class="fa fa-check"></i><b>3.2</b> Some available packages<span></span></a></li>
<li><a href="packages.html#session-info-1">Session Info<span></span></a></li>
</ul></li>
<li class="part"><span><b>II Focus Topics<span></span></b></span></li>
<li class="chapter" data-level="4" data-path="datamanipulation.html"><a href="datamanipulation.html"><i class="fa fa-check"></i><b>4</b> Data Manipulation<span></span></a>
<ul>
<li class="chapter" data-level="4.1" data-path="datamanipulation.html"><a href="datamanipulation.html#tidying-and-subsetting"><i class="fa fa-check"></i><b>4.1</b> Tidying and subsetting<span></span></a>
<ul>
<li class="chapter" data-level="4.1.1" data-path="datamanipulation.html"><a href="datamanipulation.html#tidy-data"><i class="fa fa-check"></i><b>4.1.1</b> Tidy data<span></span></a></li>
<li class="chapter" data-level="4.1.2" data-path="datamanipulation.html"><a href="datamanipulation.html#subsetting"><i class="fa fa-check"></i><b>4.1.2</b> Subsetting<span></span></a></li>
<li class="chapter" data-level="4.1.3" data-path="datamanipulation.html"><a href="datamanipulation.html#additional-functions"><i class="fa fa-check"></i><b>4.1.3</b> Additional functions<span></span></a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="5" data-path="quality-control.html"><a href="quality-control.html"><i class="fa fa-check"></i><b>5</b> Exploration and quality Control<span></span></a>
<ul>
<li class="chapter" data-level="5.1" data-path="quality-control.html"><a href="quality-control.html#abundance"><i class="fa fa-check"></i><b>5.1</b> Abundance<span></span></a></li>
<li class="chapter" data-level="5.2" data-path="quality-control.html"><a href="quality-control.html#prevalence"><i class="fa fa-check"></i><b>5.2</b> Prevalence<span></span></a>
<ul>
<li class="chapter" data-level="5.2.1" data-path="quality-control.html"><a href="quality-control.html#prevalent-microbiota-analysis"><i class="fa fa-check"></i><b>5.2.1</b> Prevalent microbiota analysis<span></span></a></li>
<li class="chapter" data-level="5.2.2" data-path="quality-control.html"><a href="quality-control.html#plotting-prevalence"><i class="fa fa-check"></i><b>5.2.2</b> Plotting prevalence<span></span></a></li>
</ul></li>
<li class="chapter" data-level="5.3" data-path="quality-control.html"><a href="quality-control.html#quality-control-1"><i class="fa fa-check"></i><b>5.3</b> Quality control<span></span></a>
<ul>
<li class="chapter" data-level="5.3.1" data-path="quality-control.html"><a href="quality-control.html#top-taxa"><i class="fa fa-check"></i><b>5.3.1</b> Top taxa<span></span></a></li>
<li class="chapter" data-level="5.3.2" data-path="quality-control.html"><a href="quality-control.html#library-size"><i class="fa fa-check"></i><b>5.3.2</b> Library size<span></span></a></li>
<li class="chapter" data-level="5.3.3" data-path="quality-control.html"><a href="quality-control.html#contaminant-sequences"><i class="fa fa-check"></i><b>5.3.3</b> Contaminant sequences<span></span></a></li>
</ul></li>
<li><a href="quality-control.html#session-info-2">Session Info<span></span></a></li>
</ul></li>
<li class="chapter" data-level="6" data-path="taxonomic-information.html"><a href="taxonomic-information.html"><i class="fa fa-check"></i><b>6</b> Taxonomic Information<span></span></a>
<ul>
<li class="chapter" data-level="6.1" data-path="taxonomic-information.html"><a href="taxonomic-information.html#assigning-taxonomic-information."><i class="fa fa-check"></i><b>6.1</b> Assigning taxonomic information.<span></span></a>
<ul>
<li class="chapter" data-level="6.1.1" data-path="taxonomic-information.html"><a href="taxonomic-information.html#dada2"><i class="fa fa-check"></i><b>6.1.1</b> dada2<span></span></a></li>
<li class="chapter" data-level="6.1.2" data-path="taxonomic-information.html"><a href="taxonomic-information.html#decipher"><i class="fa fa-check"></i><b>6.1.2</b> DECIPHER<span></span></a></li>
</ul></li>
<li class="chapter" data-level="6.2" data-path="taxonomic-information.html"><a href="taxonomic-information.html#functions-to-access-taxonomic-information"><i class="fa fa-check"></i><b>6.2</b> Functions to access taxonomic information<span></span></a>
<ul>
<li class="chapter" data-level="6.2.1" data-path="taxonomic-information.html"><a href="taxonomic-information.html#generate-a-taxonomic-tree-on-the-fly"><i class="fa fa-check"></i><b>6.2.1</b> Generate a taxonomic tree on the fly<span></span></a></li>
</ul></li>
<li class="chapter" data-level="6.3" data-path="taxonomic-information.html"><a href="taxonomic-information.html#data-agglomeration"><i class="fa fa-check"></i><b>6.3</b> Data agglomeration<span></span></a></li>
<li class="chapter" data-level="6.4" data-path="taxonomic-information.html"><a href="taxonomic-information.html#data-transformation"><i class="fa fa-check"></i><b>6.4</b> Data transformation<span></span></a></li>
<li class="chapter" data-level="6.5" data-path="taxonomic-information.html"><a href="taxonomic-information.html#pick-specific"><i class="fa fa-check"></i><b>6.5</b> Pick specific<span></span></a>
<ul>
<li class="chapter" data-level="6.5.1" data-path="taxonomic-information.html"><a href="taxonomic-information.html#abundances-of-all-taxa-in-specific-sample"><i class="fa fa-check"></i><b>6.5.1</b> Abundances of all taxa in specific sample<span></span></a></li>
<li class="chapter" data-level="6.5.2" data-path="taxonomic-information.html"><a href="taxonomic-information.html#abundances-of-specific-taxa-in-all-samples"><i class="fa fa-check"></i><b>6.5.2</b> Abundances of specific taxa in all samples<span></span></a></li>
</ul></li>
<li><a href="taxonomic-information.html#session-info-3">Session Info<span></span></a></li>
</ul></li>
<li class="chapter" data-level="7" data-path="community-diversity.html"><a href="community-diversity.html"><i class="fa fa-check"></i><b>7</b> Community diversity<span></span></a>
<ul>
<li class="chapter" data-level="7.1" data-path="community-diversity.html"><a href="community-diversity.html#estimation"><i class="fa fa-check"></i><b>7.1</b> Estimation<span></span></a>
<ul>
<li class="chapter" data-level="7.1.1" data-path="community-diversity.html"><a href="community-diversity.html#richness"><i class="fa fa-check"></i><b>7.1.1</b> Richness<span></span></a></li>
<li class="chapter" data-level="7.1.2" data-path="community-diversity.html"><a href="community-diversity.html#diversity"><i class="fa fa-check"></i><b>7.1.2</b> Diversity<span></span></a></li>
<li class="chapter" data-level="7.1.3" data-path="community-diversity.html"><a href="community-diversity.html#faith-phylogenetic-diversity"><i class="fa fa-check"></i><b>7.1.3</b> Faith phylogenetic diversity<span></span></a></li>
<li class="chapter" data-level="7.1.4" data-path="community-diversity.html"><a href="community-diversity.html#evenness"><i class="fa fa-check"></i><b>7.1.4</b> Evenness<span></span></a></li>
<li class="chapter" data-level="7.1.5" data-path="community-diversity.html"><a href="community-diversity.html#dominance"><i class="fa fa-check"></i><b>7.1.5</b> Dominance<span></span></a></li>
<li class="chapter" data-level="7.1.6" data-path="community-diversity.html"><a href="community-diversity.html#rarity"><i class="fa fa-check"></i><b>7.1.6</b> Rarity<span></span></a></li>
<li class="chapter" data-level="7.1.7" data-path="community-diversity.html"><a href="community-diversity.html#divergence"><i class="fa fa-check"></i><b>7.1.7</b> Divergence<span></span></a></li>
</ul></li>
<li class="chapter" data-level="7.2" data-path="community-diversity.html"><a href="community-diversity.html#visualization"><i class="fa fa-check"></i><b>7.2</b> Visualization<span></span></a></li>
<li><a href="community-diversity.html#session-info-4">Session Info<span></span></a></li>
</ul></li>
<li class="chapter" data-level="8" data-path="community-similarity.html"><a href="community-similarity.html"><i class="fa fa-check"></i><b>8</b> Community similarity<span></span></a>
<ul>
<li class="chapter" data-level="8.1" data-path="community-similarity.html"><a href="community-similarity.html#explained-variance"><i class="fa fa-check"></i><b>8.1</b> Explained variance<span></span></a></li>
<li class="chapter" data-level="8.2" data-path="community-similarity.html"><a href="community-similarity.html#community-comparisons-by-beta-diversity-analysis"><i class="fa fa-check"></i><b>8.2</b> Community comparisons by beta diversity analysis<span></span></a></li>
<li class="chapter" data-level="8.3" data-path="community-similarity.html"><a href="community-similarity.html#other-ordination-methods"><i class="fa fa-check"></i><b>8.3</b> Other ordination methods<span></span></a></li>
<li class="chapter" data-level="8.4" data-path="community-similarity.html"><a href="community-similarity.html#visualizing-the-most-dominant-genus-on-pcoa"><i class="fa fa-check"></i><b>8.4</b> Visualizing the most dominant genus on PCoA<span></span></a>
<ul>
<li class="chapter" data-level="8.4.1" data-path="community-similarity.html"><a href="community-similarity.html#testing-differences-in-community-composition-between-sample-groups"><i class="fa fa-check"></i><b>8.4.1</b> Testing differences in community composition between sample groups<span></span></a></li>
<li class="chapter" data-level="8.4.2" data-path="community-similarity.html"><a href="community-similarity.html#checking-the-homogeneity-condition"><i class="fa fa-check"></i><b>8.4.2</b> Checking the homogeneity condition<span></span></a></li>
</ul></li>
<li class="chapter" data-level="8.5" data-path="community-similarity.html"><a href="community-similarity.html#further-reading"><i class="fa fa-check"></i><b>8.5</b> Further reading<span></span></a></li>
<li><a href="community-similarity.html#session-info-5">Session Info<span></span></a></li>
</ul></li>
<li class="chapter" data-level="9" data-path="microbiome-community.html"><a href="microbiome-community.html"><i class="fa fa-check"></i><b>9</b> Community composition<span></span></a>
<ul>
<li class="chapter" data-level="9.1" data-path="microbiome-community.html"><a href="microbiome-community.html#visualizing-taxonomic-composition"><i class="fa fa-check"></i><b>9.1</b> Visualizing taxonomic composition<span></span></a>
<ul>
<li class="chapter" data-level="9.1.1" data-path="microbiome-community.html"><a href="microbiome-community.html#composition-barplot"><i class="fa fa-check"></i><b>9.1.1</b> Composition barplot<span></span></a></li>
<li class="chapter" data-level="9.1.2" data-path="microbiome-community.html"><a href="microbiome-community.html#composition-heatmap"><i class="fa fa-check"></i><b>9.1.2</b> Composition heatmap<span></span></a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="10" data-path="community-typing.html"><a href="community-typing.html"><i class="fa fa-check"></i><b>10</b> Community typing<span></span></a>
<ul>
<li class="chapter" data-level="10.1" data-path="community-typing.html"><a href="community-typing.html#dirichlet-multinomial-mixtures-dmm"><i class="fa fa-check"></i><b>10.1</b> Dirichlet Multinomial Mixtures (DMM)<span></span></a>
<ul>
<li class="chapter" data-level="10.1.1" data-path="community-typing.html"><a href="community-typing.html#pcoa-for-asv-level-data-with-bray-curtis-with-dmm-clusters-shown-with-colors"><i class="fa fa-check"></i><b>10.1.1</b> PCoA for ASV-level data with Bray-Curtis; with DMM clusters shown with colors<span></span></a></li>
</ul></li>
<li class="chapter" data-level="10.2" data-path="community-typing.html"><a href="community-typing.html#community-detection"><i class="fa fa-check"></i><b>10.2</b> Community Detection<span></span></a></li>
<li class="chapter" data-level="10.3" data-path="community-typing.html"><a href="community-typing.html#additional-community-typing"><i class="fa fa-check"></i><b>10.3</b> Additional Community Typing<span></span></a></li>
<li><a href="community-typing.html#session-info-6">Session Info<span></span></a></li>
</ul></li>
<li class="chapter" data-level="11" data-path="biclustering.html"><a href="biclustering.html"><i class="fa fa-check"></i><b>11</b> Biclustering<span></span></a>
<ul>
<li class="chapter" data-level="11.1" data-path="biclustering.html"><a href="biclustering.html#taxa-vs-samples"><i class="fa fa-check"></i><b>11.1</b> Taxa vs samples<span></span></a></li>
<li class="chapter" data-level="11.2" data-path="biclustering.html"><a href="biclustering.html#taxa-vs-biomolecules"><i class="fa fa-check"></i><b>11.2</b> Taxa vs biomolecules<span></span></a></li>
<li class="chapter" data-level="11.3" data-path="biclustering.html"><a href="biclustering.html#taxa-vs-taxa"><i class="fa fa-check"></i><b>11.3</b> Taxa vs taxa<span></span></a></li>
<li><a href="biclustering.html#session-info-7">Session Info<span></span></a></li>
</ul></li>
<li class="chapter" data-level="12" data-path="differential-abundance.html"><a href="differential-abundance.html"><i class="fa fa-check"></i><b>12</b> Differential abundance<span></span></a>
<ul>
<li class="chapter" data-level="12.1" data-path="differential-abundance.html"><a href="differential-abundance.html#differential-abundance-analysis"><i class="fa fa-check"></i><b>12.1</b> Differential abundance analysis<span></span></a>
<ul>
<li class="chapter" data-level="12.1.1" data-path="differential-abundance.html"><a href="differential-abundance.html#examples-and-tools"><i class="fa fa-check"></i><b>12.1.1</b> Examples and tools<span></span></a></li>
<li class="chapter" data-level="12.1.2" data-path="differential-abundance.html"><a href="differential-abundance.html#prevalence-filtering"><i class="fa fa-check"></i><b>12.1.2</b> Prevalence Filtering<span></span></a></li>
<li class="chapter" data-level="12.1.3" data-path="differential-abundance.html"><a href="differential-abundance.html#aldex2"><i class="fa fa-check"></i><b>12.1.3</b> ALDEx2<span></span></a></li>
<li class="chapter" data-level="12.1.4" data-path="differential-abundance.html"><a href="differential-abundance.html#ancom-bc"><i class="fa fa-check"></i><b>12.1.4</b> ANCOM-BC<span></span></a></li>
<li class="chapter" data-level="12.1.5" data-path="differential-abundance.html"><a href="differential-abundance.html#maaslin2"><i class="fa fa-check"></i><b>12.1.5</b> MaAsLin2<span></span></a></li>
<li class="chapter" data-level="12.1.6" data-path="differential-abundance.html"><a href="differential-abundance.html#comparison-of-the-methods"><i class="fa fa-check"></i><b>12.1.6</b> Comparison of the methods<span></span></a></li>
<li class="chapter" data-level="12.1.7" data-path="differential-abundance.html"><a href="differential-abundance.html#confounding-variables"><i class="fa fa-check"></i><b>12.1.7</b> Confounding variables<span></span></a></li>
</ul></li>
<li class="chapter" data-level="12.2" data-path="differential-abundance.html"><a href="differential-abundance.html#tree-based-methods"><i class="fa fa-check"></i><b>12.2</b> Tree-based methods<span></span></a>
<ul>
<li class="chapter" data-level="12.2.1" data-path="differential-abundance.html"><a href="differential-abundance.html#group-wise-associations-testing-based-on-balances-with-fido"><i class="fa fa-check"></i><b>12.2.1</b> Group-wise associations testing based on balances with fido<span></span></a></li>
</ul></li>
<li><a href="differential-abundance.html#session-info-8">Session Info<span></span></a></li>
</ul></li>
<li class="chapter" data-level="13" data-path="multi-assay_analyses.html"><a href="multi-assay_analyses.html"><i class="fa fa-check"></i><b>13</b> Multi-assay analyses<span></span></a>
<ul>
<li class="chapter" data-level="13.1" data-path="multi-assay_analyses.html"><a href="multi-assay_analyses.html#cross-correlation-analysis"><i class="fa fa-check"></i><b>13.1</b> Cross-correlation Analysis<span></span></a></li>
<li class="chapter" data-level="13.2" data-path="multi-assay_analyses.html"><a href="multi-assay_analyses.html#multi-omics-factor-analysis"><i class="fa fa-check"></i><b>13.2</b> Multi-Omics Factor Analysis<span></span></a></li>
<li><a href="multi-assay_analyses.html#session-info-9">Session Info<span></span></a></li>
</ul></li>
<li class="part"><span><b>III Appendix<span></span></b></span></li>
<li class="chapter" data-level="14" data-path="resources.html"><a href="resources.html"><i class="fa fa-check"></i><b>14</b> Resources<span></span></a>
<ul>
<li class="chapter" data-level="14.1" data-path="resources.html"><a href="resources.html#data-containers-1"><i class="fa fa-check"></i><b>14.1</b> Data containers<span></span></a>
<ul>
<li class="chapter" data-level="14.1.1" data-path="resources.html"><a href="resources.html#resources-for-treesummarizedexperiment"><i class="fa fa-check"></i><b>14.1.1</b> Resources for TreeSummarizedExperiment<span></span></a></li>
<li class="chapter" data-level="14.1.2" data-path="resources.html"><a href="resources.html#other-relevant-containers"><i class="fa fa-check"></i><b>14.1.2</b> Other relevant containers<span></span></a></li>
<li class="chapter" data-level="14.1.3" data-path="resources.html"><a href="resources.html#alternative-containers-for-microbiome-data"><i class="fa fa-check"></i><b>14.1.3</b> Alternative containers for microbiome data<span></span></a></li>
<li class="chapter" data-level="14.1.4" data-path="resources.html"><a href="resources.html#resources-for-phyloseq"><i class="fa fa-check"></i><b>14.1.4</b> Resources for phyloseq<span></span></a></li>
</ul></li>
<li class="chapter" data-level="14.2" data-path="resources.html"><a href="resources.html#r-programming-resources"><i class="fa fa-check"></i><b>14.2</b> R programming resources<span></span></a>
<ul>
<li class="chapter" data-level="14.2.1" data-path="resources.html"><a href="resources.html#bioc_intro"><i class="fa fa-check"></i><b>14.2.1</b> Bioconductor Classes<span></span></a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="15" data-path="extras.html"><a href="extras.html"><i class="fa fa-check"></i><b>15</b> Extra material<span></span></a>
<ul>
<li class="chapter" data-level="15.1" data-path="extras.html"><a href="extras.html#interactive-3d-plots"><i class="fa fa-check"></i><b>15.1</b> Interactive 3D Plots<span></span></a></li>
</ul></li>
<li class="chapter" data-level="16" data-path="acknowledgments.html"><a href="acknowledgments.html"><i class="fa fa-check"></i><b>16</b> Acknowledgments<span></span></a></li>
<li><a href="bibliography.html#bibliography">Bibliography<span></span></a></li>
<li class="divider"></li>
<li><a href="https://github.com/rstudio/bookdown" target="blank">Published with bookdown</a></li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Orchestrating Microbiome Analysis</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="microbiome-community" class="section level1 hasAnchor" number="9">
<h1><span class="header-section-number">Chapter 9</span> Community composition<a href="microbiome-community.html#microbiome-community" class="anchor-section" aria-label="Anchor link to header"></a></h1>
<script>
document.addEventListener("click", function (event) {
    if (event.target.classList.contains("rebook-collapse")) {
        event.target.classList.toggle("active");
        var content = event.target.nextElementSibling;
        if (content.style.display === "block") {
            content.style.display = "none";
        } else {
            content.style.display = "block";
        }
    }
})
</script>
<style>
.rebook-collapse {
  background-color: #eee;
  color: #444;
  cursor: pointer;
  padding: 18px;
  width: 100%;
  border: none;
  text-align: left;
  outline: none;
  font-size: 15px;
}

.rebook-content {
  padding: 0 18px;
  display: none;
  overflow: hidden;
  background-color: #f1f1f1;
}
</style>
<pre><code>## Loading required package: ecodist</code></pre>
<pre><code>## Warning in library(package, lib.loc = lib.loc, character.only = TRUE,
## logical.return = TRUE, : there is no package called &#39;ecodist&#39;</code></pre>
<pre><code>## Installing package into &#39;/__w/_temp/Library&#39;
## (as &#39;lib&#39; is unspecified)</code></pre>
<div class="sourceCode" id="cb227"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb227-1"><a href="microbiome-community.html#cb227-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(mia)</span>
<span id="cb227-2"><a href="microbiome-community.html#cb227-2" aria-hidden="true" tabindex="-1"></a><span class="fu">data</span>(<span class="st">&quot;GlobalPatterns&quot;</span>, <span class="at">package=</span><span class="st">&quot;mia&quot;</span>)</span>
<span id="cb227-3"><a href="microbiome-community.html#cb227-3" aria-hidden="true" tabindex="-1"></a>tse <span class="ot">&lt;-</span> GlobalPatterns</span></code></pre></div>
<div id="visualizing-taxonomic-composition" class="section level2 hasAnchor" number="9.1">
<h2><span class="header-section-number">9.1</span> Visualizing taxonomic composition<a href="microbiome-community.html#visualizing-taxonomic-composition" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<div id="composition-barplot" class="section level3 hasAnchor" number="9.1.1">
<h3><span class="header-section-number">9.1.1</span> Composition barplot<a href="microbiome-community.html#composition-barplot" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>A typical way to visualize microbiome composition is by using
composition barplot. In the following, relative abundance is
calculated and top taxa are retrieved for the Phylum rank. Thereafter,
the barplot is visualized ordering rank by abundance values and
samples by “Bacteroidetes”:</p>
<div class="sourceCode" id="cb228"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb228-1"><a href="microbiome-community.html#cb228-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(miaViz)</span>
<span id="cb228-2"><a href="microbiome-community.html#cb228-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Computing relative abundance</span></span>
<span id="cb228-3"><a href="microbiome-community.html#cb228-3" aria-hidden="true" tabindex="-1"></a>tse <span class="ot">&lt;-</span> <span class="fu">relAbundanceCounts</span>(tse)</span>
<span id="cb228-4"><a href="microbiome-community.html#cb228-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb228-5"><a href="microbiome-community.html#cb228-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Getting top taxa on a Phylum level</span></span>
<span id="cb228-6"><a href="microbiome-community.html#cb228-6" aria-hidden="true" tabindex="-1"></a>tse_phylum <span class="ot">&lt;-</span> <span class="fu">agglomerateByRank</span>(tse, <span class="at">rank =</span><span class="st">&quot;Phylum&quot;</span>, <span class="at">onRankOnly=</span><span class="cn">TRUE</span>)</span>
<span id="cb228-7"><a href="microbiome-community.html#cb228-7" aria-hidden="true" tabindex="-1"></a>top_taxa <span class="ot">&lt;-</span> <span class="fu">getTopTaxa</span>(tse_phylum,<span class="at">top =</span> <span class="dv">5</span>, <span class="at">abund_values =</span> <span class="st">&quot;relabundance&quot;</span>)</span>
<span id="cb228-8"><a href="microbiome-community.html#cb228-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb228-9"><a href="microbiome-community.html#cb228-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Renaming the &quot;Phylum&quot; rank to keep only top taxa and the rest to &quot;Other&quot;</span></span>
<span id="cb228-10"><a href="microbiome-community.html#cb228-10" aria-hidden="true" tabindex="-1"></a>phylum_renamed <span class="ot">&lt;-</span> <span class="fu">lapply</span>(<span class="fu">rowData</span>(tse)<span class="sc">$</span>Phylum,</span>
<span id="cb228-11"><a href="microbiome-community.html#cb228-11" aria-hidden="true" tabindex="-1"></a>                   <span class="cf">function</span>(x){<span class="cf">if</span> (x <span class="sc">%in%</span> top_taxa) {x} <span class="cf">else</span> {<span class="st">&quot;Other&quot;</span>}})</span>
<span id="cb228-12"><a href="microbiome-community.html#cb228-12" aria-hidden="true" tabindex="-1"></a><span class="fu">rowData</span>(tse)<span class="sc">$</span>Phylum <span class="ot">&lt;-</span> <span class="fu">as.character</span>(phylum_renamed)</span>
<span id="cb228-13"><a href="microbiome-community.html#cb228-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb228-14"><a href="microbiome-community.html#cb228-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Visualizing the composition barplot, with samples order by &quot;Bacteroidetes&quot;</span></span>
<span id="cb228-15"><a href="microbiome-community.html#cb228-15" aria-hidden="true" tabindex="-1"></a><span class="fu">plotAbundance</span>(tse, <span class="at">abund_values=</span><span class="st">&quot;relabundance&quot;</span>, <span class="at">rank =</span> <span class="st">&quot;Phylum&quot;</span>,</span>
<span id="cb228-16"><a href="microbiome-community.html#cb228-16" aria-hidden="true" tabindex="-1"></a>              <span class="at">order_rank_by=</span><span class="st">&quot;abund&quot;</span>, <span class="at">order_sample_by =</span> <span class="st">&quot;Bacteroidetes&quot;</span>)</span></code></pre></div>
<p><img src="21_microbiome_community_files/figure-html/unnamed-chunk-1-1.png" width="672" /></p>
</div>
<div id="composition-heatmap" class="section level3 hasAnchor" number="9.1.2">
<h3><span class="header-section-number">9.1.2</span> Composition heatmap<a href="microbiome-community.html#composition-heatmap" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Community composition can be visualized with heatmap, where the
horizontal axis represents samples and the vertical axis the
taxa. Color of each intersection point represents abundance of a taxon
in a specific sample.</p>
<p>Here, abundances are first CLR (centered log-ratio) transformed to
remove compositionality bias. Then Z transformation is applied to
CLR-transformed data. This shifts all taxa to zero mean and unit
variance, allowing visual comparison between taxa that have different
absolute abundance levels. After these rough visual exploration
techniques, we can visualize the abundances at Phylum level.</p>
<div class="sourceCode" id="cb229"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb229-1"><a href="microbiome-community.html#cb229-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb229-2"><a href="microbiome-community.html#cb229-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Add clr-transformation on samples</span></span>
<span id="cb229-3"><a href="microbiome-community.html#cb229-3" aria-hidden="true" tabindex="-1"></a>tse_phylum <span class="ot">&lt;-</span> <span class="fu">transformSamples</span>(tse_phylum, <span class="at">method =</span> <span class="st">&quot;clr&quot;</span>, <span class="at">pseudocount =</span> <span class="dv">1</span>)</span>
<span id="cb229-4"><a href="microbiome-community.html#cb229-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Add z-transformation on features (taxa)</span></span>
<span id="cb229-5"><a href="microbiome-community.html#cb229-5" aria-hidden="true" tabindex="-1"></a>tse_phylum <span class="ot">&lt;-</span> <span class="fu">transformFeatures</span>(tse_phylum, <span class="at">abund_values =</span> <span class="st">&quot;clr&quot;</span>, </span>
<span id="cb229-6"><a href="microbiome-community.html#cb229-6" aria-hidden="true" tabindex="-1"></a>                                <span class="at">method =</span> <span class="st">&quot;z&quot;</span>, <span class="at">name =</span> <span class="st">&quot;clr_z&quot;</span>)</span>
<span id="cb229-7"><a href="microbiome-community.html#cb229-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Melts the assay</span></span>
<span id="cb229-8"><a href="microbiome-community.html#cb229-8" aria-hidden="true" tabindex="-1"></a>df <span class="ot">&lt;-</span> <span class="fu">meltAssay</span>(tse_phylum, <span class="at">abund_values =</span> <span class="st">&quot;clr_z&quot;</span>)</span>
<span id="cb229-9"><a href="microbiome-community.html#cb229-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb229-10"><a href="microbiome-community.html#cb229-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Determines the scaling of colours</span></span>
<span id="cb229-11"><a href="microbiome-community.html#cb229-11" aria-hidden="true" tabindex="-1"></a>maxval <span class="ot">&lt;-</span> <span class="fu">round</span>(<span class="fu">max</span>(<span class="fu">abs</span>(df<span class="sc">$</span>clr_z)))</span>
<span id="cb229-12"><a href="microbiome-community.html#cb229-12" aria-hidden="true" tabindex="-1"></a>limits <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="sc">-</span>maxval, maxval)</span>
<span id="cb229-13"><a href="microbiome-community.html#cb229-13" aria-hidden="true" tabindex="-1"></a>breaks <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="at">from =</span> <span class="fu">min</span>(limits), <span class="at">to =</span> <span class="fu">max</span>(limits), <span class="at">by =</span> <span class="fl">0.5</span>)</span>
<span id="cb229-14"><a href="microbiome-community.html#cb229-14" aria-hidden="true" tabindex="-1"></a>colours <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;darkblue&quot;</span>, <span class="st">&quot;blue&quot;</span>, <span class="st">&quot;white&quot;</span>, <span class="st">&quot;red&quot;</span>, <span class="st">&quot;darkred&quot;</span>)</span>
<span id="cb229-15"><a href="microbiome-community.html#cb229-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb229-16"><a href="microbiome-community.html#cb229-16" aria-hidden="true" tabindex="-1"></a><span class="co"># Creates a ggplot object</span></span>
<span id="cb229-17"><a href="microbiome-community.html#cb229-17" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(df, <span class="fu">aes</span>(<span class="at">x =</span> SampleID, <span class="at">y =</span> FeatureID, <span class="at">fill =</span> clr_z)) <span class="sc">+</span></span>
<span id="cb229-18"><a href="microbiome-community.html#cb229-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_tile</span>() <span class="sc">+</span></span>
<span id="cb229-19"><a href="microbiome-community.html#cb229-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_gradientn</span>(<span class="at">name =</span> <span class="st">&quot;CLR + Z transform&quot;</span>, </span>
<span id="cb229-20"><a href="microbiome-community.html#cb229-20" aria-hidden="true" tabindex="-1"></a>                       <span class="at">breaks =</span> breaks, <span class="at">limits =</span> limits, <span class="at">colours =</span> colours) <span class="sc">+</span> </span>
<span id="cb229-21"><a href="microbiome-community.html#cb229-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">text =</span> <span class="fu">element_text</span>(<span class="at">size=</span><span class="dv">10</span>),</span>
<span id="cb229-22"><a href="microbiome-community.html#cb229-22" aria-hidden="true" tabindex="-1"></a>        <span class="at">axis.text.x =</span> <span class="fu">element_text</span>(<span class="at">angle=</span><span class="dv">45</span>, <span class="at">hjust=</span><span class="dv">1</span>),</span>
<span id="cb229-23"><a href="microbiome-community.html#cb229-23" aria-hidden="true" tabindex="-1"></a>        <span class="at">legend.key.size =</span> <span class="fu">unit</span>(<span class="dv">1</span>, <span class="st">&quot;cm&quot;</span>)) <span class="sc">+</span></span>
<span id="cb229-24"><a href="microbiome-community.html#cb229-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">&quot;Samples&quot;</span>, <span class="at">y =</span> <span class="st">&quot;Taxa&quot;</span>)</span></code></pre></div>
<p><img src="21_microbiome_community_files/figure-html/heatmap-1.png" width="672" /></p>
<p><em>pheatmap</em> is a package that provides methods to plot clustered heatmaps.</p>
<div class="sourceCode" id="cb230"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb230-1"><a href="microbiome-community.html#cb230-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(<span class="sc">!</span><span class="fu">require</span>(pheatmap)){</span>
<span id="cb230-2"><a href="microbiome-community.html#cb230-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">install.packages</span>(<span class="st">&quot;pheatmap&quot;</span>)</span>
<span id="cb230-3"><a href="microbiome-community.html#cb230-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">library</span>(pheatmap)</span>
<span id="cb230-4"><a href="microbiome-community.html#cb230-4" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb230-5"><a href="microbiome-community.html#cb230-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb230-6"><a href="microbiome-community.html#cb230-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Takes subset: only samples from feces, skin, or tongue</span></span>
<span id="cb230-7"><a href="microbiome-community.html#cb230-7" aria-hidden="true" tabindex="-1"></a>tse_phylum_subset <span class="ot">&lt;-</span> tse_phylum[ , <span class="fu">colData</span>(tse_phylum)<span class="sc">$</span>SampleType <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">&quot;Feces&quot;</span>, <span class="st">&quot;Skin&quot;</span>, <span class="st">&quot;Tongue&quot;</span>) ]</span>
<span id="cb230-8"><a href="microbiome-community.html#cb230-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb230-9"><a href="microbiome-community.html#cb230-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Does clr-transformation</span></span>
<span id="cb230-10"><a href="microbiome-community.html#cb230-10" aria-hidden="true" tabindex="-1"></a>tse_phylum_subset <span class="ot">&lt;-</span> <span class="fu">transformSamples</span>(tse_phylum_subset, <span class="at">method =</span> <span class="st">&quot;clr&quot;</span>, <span class="at">pseudocount =</span> <span class="dv">1</span>)</span>
<span id="cb230-11"><a href="microbiome-community.html#cb230-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Does z-transformation</span></span>
<span id="cb230-12"><a href="microbiome-community.html#cb230-12" aria-hidden="true" tabindex="-1"></a>tse_phylum_subset <span class="ot">&lt;-</span> <span class="fu">transformFeatures</span>(tse_phylum_subset, <span class="at">abund_values =</span> <span class="st">&quot;clr&quot;</span>, </span>
<span id="cb230-13"><a href="microbiome-community.html#cb230-13" aria-hidden="true" tabindex="-1"></a>                                       <span class="at">method =</span> <span class="st">&quot;z&quot;</span>, <span class="at">name =</span> <span class="st">&quot;clr_z&quot;</span>)</span>
<span id="cb230-14"><a href="microbiome-community.html#cb230-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb230-15"><a href="microbiome-community.html#cb230-15" aria-hidden="true" tabindex="-1"></a><span class="co"># Get n most abundant taxa, and subsets the data by them</span></span>
<span id="cb230-16"><a href="microbiome-community.html#cb230-16" aria-hidden="true" tabindex="-1"></a>top_taxa <span class="ot">&lt;-</span> <span class="fu">getTopTaxa</span>(tse_phylum_subset, <span class="at">top =</span> <span class="dv">20</span>)</span>
<span id="cb230-17"><a href="microbiome-community.html#cb230-17" aria-hidden="true" tabindex="-1"></a>tse_phylum_subset <span class="ot">&lt;-</span> tse_phylum_subset[top_taxa, ]</span>
<span id="cb230-18"><a href="microbiome-community.html#cb230-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb230-19"><a href="microbiome-community.html#cb230-19" aria-hidden="true" tabindex="-1"></a><span class="co"># Gets the assay table</span></span>
<span id="cb230-20"><a href="microbiome-community.html#cb230-20" aria-hidden="true" tabindex="-1"></a>mat <span class="ot">&lt;-</span> <span class="fu">assay</span>(tse_phylum_subset, <span class="st">&quot;clr_z&quot;</span>)</span>
<span id="cb230-21"><a href="microbiome-community.html#cb230-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb230-22"><a href="microbiome-community.html#cb230-22" aria-hidden="true" tabindex="-1"></a><span class="co"># Creates the heatmap</span></span>
<span id="cb230-23"><a href="microbiome-community.html#cb230-23" aria-hidden="true" tabindex="-1"></a><span class="fu">pheatmap</span>(mat)</span></code></pre></div>
<p><img src="21_microbiome_community_files/figure-html/pheatmap1-1.png" width="672" /></p>
<p>We can create clusters by hierarchical clustering and add them to the plot.</p>
<div class="sourceCode" id="cb231"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb231-1"><a href="microbiome-community.html#cb231-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(<span class="sc">!</span><span class="fu">require</span>(ape)){</span>
<span id="cb231-2"><a href="microbiome-community.html#cb231-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">install.packages</span>(<span class="st">&quot;ape&quot;</span>)</span>
<span id="cb231-3"><a href="microbiome-community.html#cb231-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">library</span>(ape)</span>
<span id="cb231-4"><a href="microbiome-community.html#cb231-4" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb231-5"><a href="microbiome-community.html#cb231-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb231-6"><a href="microbiome-community.html#cb231-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Hierarchical clustering</span></span>
<span id="cb231-7"><a href="microbiome-community.html#cb231-7" aria-hidden="true" tabindex="-1"></a>taxa_hclust <span class="ot">&lt;-</span> <span class="fu">hclust</span>(<span class="fu">dist</span>(mat), <span class="at">method =</span> <span class="st">&quot;complete&quot;</span>)</span>
<span id="cb231-8"><a href="microbiome-community.html#cb231-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb231-9"><a href="microbiome-community.html#cb231-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Creates a phylogenetic tree</span></span>
<span id="cb231-10"><a href="microbiome-community.html#cb231-10" aria-hidden="true" tabindex="-1"></a>taxa_tree <span class="ot">&lt;-</span> <span class="fu">as.phylo</span>(taxa_hclust)</span></code></pre></div>
<div class="sourceCode" id="cb232"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb232-1"><a href="microbiome-community.html#cb232-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(<span class="sc">!</span><span class="fu">require</span>(ggtree)){</span>
<span id="cb232-2"><a href="microbiome-community.html#cb232-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">install.packages</span>(<span class="st">&quot;ggtree&quot;</span>)</span>
<span id="cb232-3"><a href="microbiome-community.html#cb232-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">library</span>(ggtree)</span>
<span id="cb232-4"><a href="microbiome-community.html#cb232-4" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb232-5"><a href="microbiome-community.html#cb232-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb232-6"><a href="microbiome-community.html#cb232-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot taxa tree</span></span>
<span id="cb232-7"><a href="microbiome-community.html#cb232-7" aria-hidden="true" tabindex="-1"></a>taxa_tree <span class="ot">&lt;-</span> <span class="fu">ggtree</span>(taxa_tree) <span class="sc">+</span> </span>
<span id="cb232-8"><a href="microbiome-community.html#cb232-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">plot.margin=</span><span class="fu">margin</span>(<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">0</span>)) <span class="co"># removes margins</span></span>
<span id="cb232-9"><a href="microbiome-community.html#cb232-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb232-10"><a href="microbiome-community.html#cb232-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Get order of taxa in plot</span></span>
<span id="cb232-11"><a href="microbiome-community.html#cb232-11" aria-hidden="true" tabindex="-1"></a>taxa_ordered <span class="ot">&lt;-</span> <span class="fu">get_taxa_name</span>(taxa_tree)</span>
<span id="cb232-12"><a href="microbiome-community.html#cb232-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb232-13"><a href="microbiome-community.html#cb232-13" aria-hidden="true" tabindex="-1"></a>taxa_tree</span></code></pre></div>
<p><img src="21_microbiome_community_files/figure-html/pheatmap3-1.png" width="672" /></p>
<p>Based on phylo tree, we decide to create three clusters.</p>
<div class="sourceCode" id="cb233"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb233-1"><a href="microbiome-community.html#cb233-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Creates clusters</span></span>
<span id="cb233-2"><a href="microbiome-community.html#cb233-2" aria-hidden="true" tabindex="-1"></a>taxa_clusters <span class="ot">&lt;-</span> <span class="fu">cutree</span>(<span class="at">tree =</span> taxa_hclust, <span class="at">k =</span> <span class="dv">3</span>)</span>
<span id="cb233-3"><a href="microbiome-community.html#cb233-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb233-4"><a href="microbiome-community.html#cb233-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Converts into data frame</span></span>
<span id="cb233-5"><a href="microbiome-community.html#cb233-5" aria-hidden="true" tabindex="-1"></a>taxa_clusters <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">clusters =</span> taxa_clusters)</span>
<span id="cb233-6"><a href="microbiome-community.html#cb233-6" aria-hidden="true" tabindex="-1"></a>taxa_clusters<span class="sc">$</span>clusters <span class="ot">&lt;-</span> <span class="fu">factor</span>(taxa_clusters<span class="sc">$</span>clusters)</span>
<span id="cb233-7"><a href="microbiome-community.html#cb233-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb233-8"><a href="microbiome-community.html#cb233-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Order data so that it&#39;s same as in phylo tree</span></span>
<span id="cb233-9"><a href="microbiome-community.html#cb233-9" aria-hidden="true" tabindex="-1"></a>taxa_clusters <span class="ot">&lt;-</span> taxa_clusters[taxa_ordered, , drop <span class="ot">=</span> <span class="cn">FALSE</span>] </span>
<span id="cb233-10"><a href="microbiome-community.html#cb233-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb233-11"><a href="microbiome-community.html#cb233-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Prints taxa and their clusters</span></span>
<span id="cb233-12"><a href="microbiome-community.html#cb233-12" aria-hidden="true" tabindex="-1"></a>taxa_clusters</span></code></pre></div>
<pre><code>##                  clusters
## Chloroflexi             3
## Actinobacteria          3
## Crenarchaeota           3
## Planctomycetes          3
## Gemmatimonadetes        3
## Thermi                  3
## Acidobacteria           3
## Spirochaetes            2
## Fusobacteria            2
## SR1                     2
## Cyanobacteria           2
## Proteobacteria          2
## Synergistetes           2
## Lentisphaerae           1
## Bacteroidetes           1
## Verrucomicrobia         1
## Tenericutes             1
## Firmicutes              1
## Euryarchaeota           1
## SAR406                  1</code></pre>
<div class="sourceCode" id="cb235"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb235-1"><a href="microbiome-community.html#cb235-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Adds information to rowData</span></span>
<span id="cb235-2"><a href="microbiome-community.html#cb235-2" aria-hidden="true" tabindex="-1"></a><span class="fu">rowData</span>(tse_phylum_subset)<span class="sc">$</span>clusters <span class="ot">&lt;-</span> taxa_clusters[<span class="fu">order</span>(<span class="fu">match</span>(<span class="fu">rownames</span>(taxa_clusters), </span>
<span id="cb235-3"><a href="microbiome-community.html#cb235-3" aria-hidden="true" tabindex="-1"></a>                                                                 <span class="fu">rownames</span>(tse_phylum_subset))), ]</span>
<span id="cb235-4"><a href="microbiome-community.html#cb235-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb235-5"><a href="microbiome-community.html#cb235-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Prints taxa and their clusters</span></span>
<span id="cb235-6"><a href="microbiome-community.html#cb235-6" aria-hidden="true" tabindex="-1"></a><span class="fu">rowData</span>(tse_phylum_subset)<span class="sc">$</span>clusters</span></code></pre></div>
<pre><code>##  [1] 1 1 2 3 2 2 1 1 1 1 3 2 3 3 3 2 2 3 3 1
## Levels: 1 2 3</code></pre>
<div class="sourceCode" id="cb237"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb237-1"><a href="microbiome-community.html#cb237-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Hierarchical clustering</span></span>
<span id="cb237-2"><a href="microbiome-community.html#cb237-2" aria-hidden="true" tabindex="-1"></a>sample_hclust <span class="ot">&lt;-</span> <span class="fu">hclust</span>(<span class="fu">dist</span>(<span class="fu">t</span>(mat)), <span class="at">method =</span> <span class="st">&quot;complete&quot;</span>)</span>
<span id="cb237-3"><a href="microbiome-community.html#cb237-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb237-4"><a href="microbiome-community.html#cb237-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Creates a phylogenetic tree</span></span>
<span id="cb237-5"><a href="microbiome-community.html#cb237-5" aria-hidden="true" tabindex="-1"></a>sample_tree <span class="ot">&lt;-</span> <span class="fu">as.phylo</span>(sample_hclust)</span>
<span id="cb237-6"><a href="microbiome-community.html#cb237-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb237-7"><a href="microbiome-community.html#cb237-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot sample tree</span></span>
<span id="cb237-8"><a href="microbiome-community.html#cb237-8" aria-hidden="true" tabindex="-1"></a>sample_tree <span class="ot">&lt;-</span> <span class="fu">ggtree</span>(sample_tree) <span class="sc">+</span> <span class="fu">layout_dendrogram</span>() <span class="sc">+</span> </span>
<span id="cb237-9"><a href="microbiome-community.html#cb237-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">plot.margin=</span><span class="fu">margin</span>(<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">0</span>)) <span class="co"># removes margins</span></span>
<span id="cb237-10"><a href="microbiome-community.html#cb237-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb237-11"><a href="microbiome-community.html#cb237-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Get order of samples in plot</span></span>
<span id="cb237-12"><a href="microbiome-community.html#cb237-12" aria-hidden="true" tabindex="-1"></a>samples_ordered <span class="ot">&lt;-</span> <span class="fu">rev</span>(<span class="fu">get_taxa_name</span>(sample_tree))</span>
<span id="cb237-13"><a href="microbiome-community.html#cb237-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb237-14"><a href="microbiome-community.html#cb237-14" aria-hidden="true" tabindex="-1"></a>sample_tree</span></code></pre></div>
<p><img src="21_microbiome_community_files/figure-html/pheatmap6-1.png" width="672" /></p>
<div class="sourceCode" id="cb238"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb238-1"><a href="microbiome-community.html#cb238-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Creates clusters</span></span>
<span id="cb238-2"><a href="microbiome-community.html#cb238-2" aria-hidden="true" tabindex="-1"></a>sample_clusters <span class="ot">&lt;-</span> <span class="fu">factor</span>(<span class="fu">cutree</span>(<span class="at">tree =</span> sample_hclust, <span class="at">k =</span> <span class="dv">3</span>))</span>
<span id="cb238-3"><a href="microbiome-community.html#cb238-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb238-4"><a href="microbiome-community.html#cb238-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Converts into data frame</span></span>
<span id="cb238-5"><a href="microbiome-community.html#cb238-5" aria-hidden="true" tabindex="-1"></a>sample_data <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">clusters =</span> sample_clusters)</span>
<span id="cb238-6"><a href="microbiome-community.html#cb238-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb238-7"><a href="microbiome-community.html#cb238-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Order data so that it&#39;s same as in phylo tree</span></span>
<span id="cb238-8"><a href="microbiome-community.html#cb238-8" aria-hidden="true" tabindex="-1"></a>sample_data <span class="ot">&lt;-</span> sample_data[samples_ordered, , drop <span class="ot">=</span> <span class="cn">FALSE</span>] </span>
<span id="cb238-9"><a href="microbiome-community.html#cb238-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb238-10"><a href="microbiome-community.html#cb238-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Order data based on </span></span>
<span id="cb238-11"><a href="microbiome-community.html#cb238-11" aria-hidden="true" tabindex="-1"></a>tse_phylum_subset <span class="ot">&lt;-</span> tse_phylum_subset[ , <span class="fu">rownames</span>(sample_data)]</span>
<span id="cb238-12"><a href="microbiome-community.html#cb238-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb238-13"><a href="microbiome-community.html#cb238-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Add sample type data</span></span>
<span id="cb238-14"><a href="microbiome-community.html#cb238-14" aria-hidden="true" tabindex="-1"></a>sample_data<span class="sc">$</span>sample_types <span class="ot">&lt;-</span> <span class="fu">unfactor</span>(<span class="fu">colData</span>(tse_phylum_subset)<span class="sc">$</span>SampleType)</span>
<span id="cb238-15"><a href="microbiome-community.html#cb238-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb238-16"><a href="microbiome-community.html#cb238-16" aria-hidden="true" tabindex="-1"></a>sample_data</span></code></pre></div>
<pre><code>##         clusters sample_types
## M11Plmr        2         Skin
## M31Plmr        2         Skin
## F21Plmr        2         Skin
## M31Fcsw        1        Feces
## M11Fcsw        1        Feces
## TS28           3        Feces
## TS29           3        Feces
## M31Tong        3       Tongue
## M11Tong        3       Tongue</code></pre>
<p>Now we can create heatmap with additional annotations.</p>
<div class="sourceCode" id="cb240"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb240-1"><a href="microbiome-community.html#cb240-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Determines the scaling of colorss</span></span>
<span id="cb240-2"><a href="microbiome-community.html#cb240-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Scale colors</span></span>
<span id="cb240-3"><a href="microbiome-community.html#cb240-3" aria-hidden="true" tabindex="-1"></a>breaks <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="sc">-</span><span class="fu">ceiling</span>(<span class="fu">max</span>(<span class="fu">abs</span>(mat))), <span class="fu">ceiling</span>(<span class="fu">max</span>(<span class="fu">abs</span>(mat))), </span>
<span id="cb240-4"><a href="microbiome-community.html#cb240-4" aria-hidden="true" tabindex="-1"></a>              <span class="at">length.out =</span> <span class="fu">ifelse</span>( <span class="fu">max</span>(<span class="fu">abs</span>(mat))<span class="sc">&gt;</span><span class="dv">5</span>, <span class="dv">2</span><span class="sc">*</span><span class="fu">ceiling</span>(<span class="fu">max</span>(<span class="fu">abs</span>(mat))), <span class="dv">10</span> ) )</span>
<span id="cb240-5"><a href="microbiome-community.html#cb240-5" aria-hidden="true" tabindex="-1"></a>colors <span class="ot">&lt;-</span> <span class="fu">colorRampPalette</span>(<span class="fu">c</span>(<span class="st">&quot;darkblue&quot;</span>, <span class="st">&quot;blue&quot;</span>, <span class="st">&quot;white&quot;</span>, <span class="st">&quot;red&quot;</span>, <span class="st">&quot;darkred&quot;</span>))(<span class="fu">length</span>(breaks)<span class="sc">-</span><span class="dv">1</span>)</span>
<span id="cb240-6"><a href="microbiome-community.html#cb240-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb240-7"><a href="microbiome-community.html#cb240-7" aria-hidden="true" tabindex="-1"></a><span class="fu">pheatmap</span>(mat, <span class="at">annotation_row =</span> taxa_clusters, </span>
<span id="cb240-8"><a href="microbiome-community.html#cb240-8" aria-hidden="true" tabindex="-1"></a>         <span class="at">annotation_col =</span> sample_data,</span>
<span id="cb240-9"><a href="microbiome-community.html#cb240-9" aria-hidden="true" tabindex="-1"></a>         <span class="at">breaks =</span> breaks,</span>
<span id="cb240-10"><a href="microbiome-community.html#cb240-10" aria-hidden="true" tabindex="-1"></a>         <span class="at">color =</span> colors)</span></code></pre></div>
<p><img src="21_microbiome_community_files/figure-html/pheatmap8-1.png" width="672" /></p>
<p>In addition to <em>pheatmap</em> package, there are also other packages that
provide functions for more complex heatmaps, such as <a href="https://docs.ropensci.org/iheatmapr/articles/full_vignettes/iheatmapr.html"><em>iheatmapr</em></a>
and
<a href="https://academic.oup.com/bioinformatics/article/32/18/2847/1743594?login=true">ComplexHeatmap</a>.</p>
<p><a href="http://www.bioconductor.org/packages/release/bioc/vignettes/sechm/inst/doc/sechm.html">sechm</a>
package provides wrapper for <em>ComplexHeatmap</em>.</p>
<div class="sourceCode" id="cb241"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb241-1"><a href="microbiome-community.html#cb241-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(<span class="sc">!</span><span class="fu">require</span>(sechm)){</span>
<span id="cb241-2"><a href="microbiome-community.html#cb241-2" aria-hidden="true" tabindex="-1"></a>  BiocManager<span class="sc">::</span><span class="fu">install</span>(<span class="st">&quot;sechm&quot;</span>)</span>
<span id="cb241-3"><a href="microbiome-community.html#cb241-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">library</span>(sechm)</span>
<span id="cb241-4"><a href="microbiome-community.html#cb241-4" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb241-5"><a href="microbiome-community.html#cb241-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Stores annotation colros to metadata</span></span>
<span id="cb241-6"><a href="microbiome-community.html#cb241-6" aria-hidden="true" tabindex="-1"></a><span class="fu">metadata</span>(tse_phylum_subset)<span class="sc">$</span>anno_colors<span class="sc">$</span>SampleType <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="at">Feces =</span> <span class="st">&quot;blue&quot;</span>, </span>
<span id="cb241-7"><a href="microbiome-community.html#cb241-7" aria-hidden="true" tabindex="-1"></a>                                                        <span class="at">Skin =</span> <span class="st">&quot;red&quot;</span>, </span>
<span id="cb241-8"><a href="microbiome-community.html#cb241-8" aria-hidden="true" tabindex="-1"></a>                                                        <span class="at">Tongue =</span> <span class="st">&quot;gray&quot;</span>)</span>
<span id="cb241-9"><a href="microbiome-community.html#cb241-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb241-10"><a href="microbiome-community.html#cb241-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a plot</span></span>
<span id="cb241-11"><a href="microbiome-community.html#cb241-11" aria-hidden="true" tabindex="-1"></a><span class="fu">sechm</span>(tse_phylum_subset, </span>
<span id="cb241-12"><a href="microbiome-community.html#cb241-12" aria-hidden="true" tabindex="-1"></a>      <span class="at">genes =</span> <span class="fu">rownames</span>(tse_phylum_subset), </span>
<span id="cb241-13"><a href="microbiome-community.html#cb241-13" aria-hidden="true" tabindex="-1"></a>      <span class="at">assayName =</span> <span class="st">&quot;clr&quot;</span>, </span>
<span id="cb241-14"><a href="microbiome-community.html#cb241-14" aria-hidden="true" tabindex="-1"></a>      <span class="at">do.scale =</span> <span class="cn">TRUE</span>, </span>
<span id="cb241-15"><a href="microbiome-community.html#cb241-15" aria-hidden="true" tabindex="-1"></a>      <span class="at">top_annotation =</span> <span class="fu">c</span>(<span class="st">&quot;SampleType&quot;</span>), </span>
<span id="cb241-16"><a href="microbiome-community.html#cb241-16" aria-hidden="true" tabindex="-1"></a>      <span class="at">gaps_at =</span> <span class="st">&quot;SampleType&quot;</span>,</span>
<span id="cb241-17"><a href="microbiome-community.html#cb241-17" aria-hidden="true" tabindex="-1"></a>      <span class="at">cluster_cols =</span> <span class="cn">TRUE</span>, <span class="at">cluster_rows =</span> <span class="cn">TRUE</span>)</span></code></pre></div>
<p><img src="21_microbiome_community_files/figure-html/sechm-1.png" width="672" /></p>
<p>It is also possible to create similar heatmap by just using <em>ggplot2</em>.</p>
<div class="sourceCode" id="cb242"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb242-1"><a href="microbiome-community.html#cb242-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Add feature names to column as a factor</span></span>
<span id="cb242-2"><a href="microbiome-community.html#cb242-2" aria-hidden="true" tabindex="-1"></a>taxa_clusters<span class="sc">$</span>Feature <span class="ot">&lt;-</span> <span class="fu">rownames</span>(taxa_clusters)</span>
<span id="cb242-3"><a href="microbiome-community.html#cb242-3" aria-hidden="true" tabindex="-1"></a>taxa_clusters<span class="sc">$</span>Feature <span class="ot">&lt;-</span> <span class="fu">factor</span>(taxa_clusters<span class="sc">$</span>Feature, <span class="at">levels =</span> taxa_clusters<span class="sc">$</span>Feature)</span>
<span id="cb242-4"><a href="microbiome-community.html#cb242-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb242-5"><a href="microbiome-community.html#cb242-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Create annotation plot</span></span>
<span id="cb242-6"><a href="microbiome-community.html#cb242-6" aria-hidden="true" tabindex="-1"></a>row_annotation <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(taxa_clusters) <span class="sc">+</span> </span>
<span id="cb242-7"><a href="microbiome-community.html#cb242-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_tile</span>(<span class="fu">aes</span>(<span class="at">x =</span> <span class="cn">NA</span>, <span class="at">y =</span> Feature, <span class="at">fill =</span> clusters)) <span class="sc">+</span> <span class="fu">coord_equal</span>(<span class="at">ratio =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb242-8"><a href="microbiome-community.html#cb242-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb242-9"><a href="microbiome-community.html#cb242-9" aria-hidden="true" tabindex="-1"></a>        <span class="at">axis.text.x=</span><span class="fu">element_blank</span>(),</span>
<span id="cb242-10"><a href="microbiome-community.html#cb242-10" aria-hidden="true" tabindex="-1"></a>        <span class="at">axis.text.y=</span><span class="fu">element_blank</span>(),</span>
<span id="cb242-11"><a href="microbiome-community.html#cb242-11" aria-hidden="true" tabindex="-1"></a>        <span class="at">axis.ticks.y=</span><span class="fu">element_blank</span>(),</span>
<span id="cb242-12"><a href="microbiome-community.html#cb242-12" aria-hidden="true" tabindex="-1"></a>        <span class="at">axis.title.y=</span><span class="fu">element_blank</span>(),</span>
<span id="cb242-13"><a href="microbiome-community.html#cb242-13" aria-hidden="true" tabindex="-1"></a>        <span class="at">axis.title.x =</span> <span class="fu">element_text</span>(<span class="at">angle =</span> <span class="dv">90</span>, <span class="at">vjust =</span> <span class="fl">0.5</span>, <span class="at">hjust=</span><span class="dv">1</span>),</span>
<span id="cb242-14"><a href="microbiome-community.html#cb242-14" aria-hidden="true" tabindex="-1"></a>        <span class="at">plot.margin=</span><span class="fu">margin</span>(<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">0</span>),</span>
<span id="cb242-15"><a href="microbiome-community.html#cb242-15" aria-hidden="true" tabindex="-1"></a>        ) <span class="sc">+</span></span>
<span id="cb242-16"><a href="microbiome-community.html#cb242-16" aria-hidden="true" tabindex="-1"></a>      <span class="fu">labs</span>(<span class="at">fill =</span> <span class="st">&quot;Clusters&quot;</span>, <span class="at">x =</span> <span class="st">&quot;Clusters&quot;</span>)</span>
<span id="cb242-17"><a href="microbiome-community.html#cb242-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb242-18"><a href="microbiome-community.html#cb242-18" aria-hidden="true" tabindex="-1"></a>row_annotation</span></code></pre></div>
<p><img src="21_microbiome_community_files/figure-html/more_complex_heatmap1-1.png" width="672" /></p>
<div class="sourceCode" id="cb243"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb243-1"><a href="microbiome-community.html#cb243-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Add sample names to one of the columns</span></span>
<span id="cb243-2"><a href="microbiome-community.html#cb243-2" aria-hidden="true" tabindex="-1"></a>sample_data<span class="sc">$</span>sample <span class="ot">&lt;-</span> <span class="fu">factor</span>(<span class="fu">rownames</span>(sample_data), <span class="at">levels =</span> <span class="fu">rownames</span>(sample_data))</span>
<span id="cb243-3"><a href="microbiome-community.html#cb243-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb243-4"><a href="microbiome-community.html#cb243-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Create annotation plot</span></span>
<span id="cb243-5"><a href="microbiome-community.html#cb243-5" aria-hidden="true" tabindex="-1"></a>sample_types_annotation <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(sample_data) <span class="sc">+</span> <span class="fu">scale_y_discrete</span>(<span class="at">position =</span> <span class="st">&quot;right&quot;</span>, <span class="at">expand =</span> <span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">0</span>)) <span class="sc">+</span></span>
<span id="cb243-6"><a href="microbiome-community.html#cb243-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_tile</span>(<span class="fu">aes</span>(<span class="at">y =</span> <span class="cn">NA</span>, <span class="at">x =</span> sample, <span class="at">fill =</span> sample_types)) <span class="sc">+</span> <span class="fu">coord_equal</span>(<span class="at">ratio =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb243-7"><a href="microbiome-community.html#cb243-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb243-8"><a href="microbiome-community.html#cb243-8" aria-hidden="true" tabindex="-1"></a>        <span class="at">axis.text.x=</span><span class="fu">element_blank</span>(),</span>
<span id="cb243-9"><a href="microbiome-community.html#cb243-9" aria-hidden="true" tabindex="-1"></a>        <span class="at">axis.text.y=</span><span class="fu">element_blank</span>(),</span>
<span id="cb243-10"><a href="microbiome-community.html#cb243-10" aria-hidden="true" tabindex="-1"></a>        <span class="at">axis.title.x=</span><span class="fu">element_blank</span>(),</span>
<span id="cb243-11"><a href="microbiome-community.html#cb243-11" aria-hidden="true" tabindex="-1"></a>        <span class="at">axis.ticks.x=</span><span class="fu">element_blank</span>(),</span>
<span id="cb243-12"><a href="microbiome-community.html#cb243-12" aria-hidden="true" tabindex="-1"></a>        <span class="at">plot.margin=</span><span class="fu">margin</span>(<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">0</span>),</span>
<span id="cb243-13"><a href="microbiome-community.html#cb243-13" aria-hidden="true" tabindex="-1"></a>        <span class="at">axis.title.y.right =</span> <span class="fu">element_text</span>(<span class="at">angle=</span><span class="dv">0</span>, <span class="at">vjust =</span> <span class="fl">0.5</span>)</span>
<span id="cb243-14"><a href="microbiome-community.html#cb243-14" aria-hidden="true" tabindex="-1"></a>        ) <span class="sc">+</span></span>
<span id="cb243-15"><a href="microbiome-community.html#cb243-15" aria-hidden="true" tabindex="-1"></a>      <span class="fu">labs</span>(<span class="at">fill =</span> <span class="st">&quot;Sample types&quot;</span>, <span class="at">y =</span> <span class="st">&quot;Sample types&quot;</span>)</span>
<span id="cb243-16"><a href="microbiome-community.html#cb243-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb243-17"><a href="microbiome-community.html#cb243-17" aria-hidden="true" tabindex="-1"></a>sample_types_annotation</span></code></pre></div>
<p><img src="21_microbiome_community_files/figure-html/more_complex_heatmap2-1.png" width="672" /></p>
<div class="sourceCode" id="cb244"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb244-1"><a href="microbiome-community.html#cb244-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create annotation plot</span></span>
<span id="cb244-2"><a href="microbiome-community.html#cb244-2" aria-hidden="true" tabindex="-1"></a>sample_clusters_annotation <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(sample_data) <span class="sc">+</span> <span class="fu">scale_y_discrete</span>(<span class="at">position =</span> <span class="st">&quot;right&quot;</span>, <span class="at">expand =</span> <span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">0</span>)) <span class="sc">+</span></span>
<span id="cb244-3"><a href="microbiome-community.html#cb244-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_tile</span>(<span class="fu">aes</span>(<span class="at">y =</span> <span class="cn">NA</span>, <span class="at">x =</span> sample, <span class="at">fill =</span> clusters)) <span class="sc">+</span> <span class="fu">coord_equal</span>(<span class="at">ratio =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb244-4"><a href="microbiome-community.html#cb244-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb244-5"><a href="microbiome-community.html#cb244-5" aria-hidden="true" tabindex="-1"></a>        <span class="at">axis.text.x=</span><span class="fu">element_blank</span>(),</span>
<span id="cb244-6"><a href="microbiome-community.html#cb244-6" aria-hidden="true" tabindex="-1"></a>        <span class="at">axis.text.y=</span><span class="fu">element_blank</span>(),</span>
<span id="cb244-7"><a href="microbiome-community.html#cb244-7" aria-hidden="true" tabindex="-1"></a>        <span class="at">axis.title.x=</span><span class="fu">element_blank</span>(),</span>
<span id="cb244-8"><a href="microbiome-community.html#cb244-8" aria-hidden="true" tabindex="-1"></a>        <span class="at">axis.ticks.x=</span><span class="fu">element_blank</span>(),</span>
<span id="cb244-9"><a href="microbiome-community.html#cb244-9" aria-hidden="true" tabindex="-1"></a>        <span class="at">plot.margin=</span><span class="fu">margin</span>(<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">0</span>),</span>
<span id="cb244-10"><a href="microbiome-community.html#cb244-10" aria-hidden="true" tabindex="-1"></a>        <span class="at">axis.title.y.right =</span> <span class="fu">element_text</span>(<span class="at">angle=</span><span class="dv">0</span>, <span class="at">vjust =</span> <span class="fl">0.5</span>)</span>
<span id="cb244-11"><a href="microbiome-community.html#cb244-11" aria-hidden="true" tabindex="-1"></a>        ) <span class="sc">+</span></span>
<span id="cb244-12"><a href="microbiome-community.html#cb244-12" aria-hidden="true" tabindex="-1"></a>      <span class="fu">labs</span>(<span class="at">fill =</span> <span class="st">&quot;Clusters&quot;</span>, <span class="at">y =</span> <span class="st">&quot;Clusters&quot;</span>)</span>
<span id="cb244-13"><a href="microbiome-community.html#cb244-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb244-14"><a href="microbiome-community.html#cb244-14" aria-hidden="true" tabindex="-1"></a>sample_clusters_annotation</span></code></pre></div>
<p><img src="21_microbiome_community_files/figure-html/more_complex_heatmap3-1.png" width="672" /></p>
<div class="sourceCode" id="cb245"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb245-1"><a href="microbiome-community.html#cb245-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(<span class="sc">!</span><span class="fu">require</span>(reshape2)){</span>
<span id="cb245-2"><a href="microbiome-community.html#cb245-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">install.packages</span>(<span class="st">&quot;reshape2&quot;</span>)</span>
<span id="cb245-3"><a href="microbiome-community.html#cb245-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">library</span>(reshape2)</span>
<span id="cb245-4"><a href="microbiome-community.html#cb245-4" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb245-5"><a href="microbiome-community.html#cb245-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Order data based on clusters and sample types</span></span>
<span id="cb245-6"><a href="microbiome-community.html#cb245-6" aria-hidden="true" tabindex="-1"></a>mat <span class="ot">&lt;-</span> mat[<span class="fu">unfactor</span>(taxa_clusters<span class="sc">$</span>Feature), <span class="fu">unfactor</span>(sample_data<span class="sc">$</span>sample)]</span>
<span id="cb245-7"><a href="microbiome-community.html#cb245-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb245-8"><a href="microbiome-community.html#cb245-8" aria-hidden="true" tabindex="-1"></a><span class="co"># ggplot requires data in melted format</span></span>
<span id="cb245-9"><a href="microbiome-community.html#cb245-9" aria-hidden="true" tabindex="-1"></a>melted_mat <span class="ot">&lt;-</span> <span class="fu">melt</span>(mat)</span>
<span id="cb245-10"><a href="microbiome-community.html#cb245-10" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(melted_mat) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;Taxa&quot;</span>, <span class="st">&quot;Sample&quot;</span>, <span class="st">&quot;clr_z&quot;</span>)</span>
<span id="cb245-11"><a href="microbiome-community.html#cb245-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb245-12"><a href="microbiome-community.html#cb245-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Determines the scaling of colorss</span></span>
<span id="cb245-13"><a href="microbiome-community.html#cb245-13" aria-hidden="true" tabindex="-1"></a>maxval <span class="ot">&lt;-</span> <span class="fu">round</span>(<span class="fu">max</span>(<span class="fu">abs</span>(melted_mat<span class="sc">$</span>clr_z)))</span>
<span id="cb245-14"><a href="microbiome-community.html#cb245-14" aria-hidden="true" tabindex="-1"></a>limits <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="sc">-</span>maxval, maxval)</span>
<span id="cb245-15"><a href="microbiome-community.html#cb245-15" aria-hidden="true" tabindex="-1"></a>breaks <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="at">from =</span> <span class="fu">min</span>(limits), <span class="at">to =</span> <span class="fu">max</span>(limits), <span class="at">by =</span> <span class="fl">0.5</span>)</span>
<span id="cb245-16"><a href="microbiome-community.html#cb245-16" aria-hidden="true" tabindex="-1"></a>colours <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;darkblue&quot;</span>, <span class="st">&quot;blue&quot;</span>, <span class="st">&quot;white&quot;</span>, <span class="st">&quot;red&quot;</span>, <span class="st">&quot;darkred&quot;</span>)</span>
<span id="cb245-17"><a href="microbiome-community.html#cb245-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb245-18"><a href="microbiome-community.html#cb245-18" aria-hidden="true" tabindex="-1"></a>heatmap <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(melted_mat) <span class="sc">+</span> </span>
<span id="cb245-19"><a href="microbiome-community.html#cb245-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_tile</span>(<span class="fu">aes</span>(<span class="at">x =</span> Sample, <span class="at">y =</span> Taxa, <span class="at">fill =</span> clr_z)) <span class="sc">+</span></span>
<span id="cb245-20"><a href="microbiome-community.html#cb245-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb245-21"><a href="microbiome-community.html#cb245-21" aria-hidden="true" tabindex="-1"></a>    <span class="at">axis.title.y=</span><span class="fu">element_blank</span>(),</span>
<span id="cb245-22"><a href="microbiome-community.html#cb245-22" aria-hidden="true" tabindex="-1"></a>    <span class="at">axis.title.x=</span><span class="fu">element_blank</span>(),</span>
<span id="cb245-23"><a href="microbiome-community.html#cb245-23" aria-hidden="true" tabindex="-1"></a>    <span class="at">axis.ticks.y=</span><span class="fu">element_blank</span>(),</span>
<span id="cb245-24"><a href="microbiome-community.html#cb245-24" aria-hidden="true" tabindex="-1"></a>    <span class="at">axis.text.x =</span> <span class="fu">element_text</span>(<span class="at">angle =</span> <span class="dv">90</span>, <span class="at">vjust =</span> <span class="fl">0.5</span>, <span class="at">hjust=</span><span class="dv">1</span>),</span>
<span id="cb245-25"><a href="microbiome-community.html#cb245-25" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb245-26"><a href="microbiome-community.html#cb245-26" aria-hidden="true" tabindex="-1"></a>    <span class="at">plot.margin=</span><span class="fu">margin</span>(<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">0</span>), <span class="co"># removes margins</span></span>
<span id="cb245-27"><a href="microbiome-community.html#cb245-27" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.key.height=</span> <span class="fu">unit</span>(<span class="dv">1</span>, <span class="st">&#39;cm&#39;</span>)</span>
<span id="cb245-28"><a href="microbiome-community.html#cb245-28" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb245-29"><a href="microbiome-community.html#cb245-29" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_gradientn</span>(<span class="at">name =</span> <span class="st">&quot;CLR + Z transform&quot;</span>, </span>
<span id="cb245-30"><a href="microbiome-community.html#cb245-30" aria-hidden="true" tabindex="-1"></a>                       <span class="at">breaks =</span> breaks, </span>
<span id="cb245-31"><a href="microbiome-community.html#cb245-31" aria-hidden="true" tabindex="-1"></a>                       <span class="at">limits =</span> limits, </span>
<span id="cb245-32"><a href="microbiome-community.html#cb245-32" aria-hidden="true" tabindex="-1"></a>                       <span class="at">colours =</span> colours) <span class="sc">+</span> </span>
<span id="cb245-33"><a href="microbiome-community.html#cb245-33" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_discrete</span>(<span class="at">position =</span> <span class="st">&quot;right&quot;</span>)</span>
<span id="cb245-34"><a href="microbiome-community.html#cb245-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb245-35"><a href="microbiome-community.html#cb245-35" aria-hidden="true" tabindex="-1"></a>heatmap</span></code></pre></div>
<p><img src="21_microbiome_community_files/figure-html/more_complex_heatmap4-1.png" width="672" /></p>
<div class="sourceCode" id="cb246"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb246-1"><a href="microbiome-community.html#cb246-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(<span class="sc">!</span><span class="fu">require</span>(patchwork)){</span>
<span id="cb246-2"><a href="microbiome-community.html#cb246-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">install.packages</span>(<span class="st">&quot;patchwork&quot;</span>)</span>
<span id="cb246-3"><a href="microbiome-community.html#cb246-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">library</span>(patchwork)</span>
<span id="cb246-4"><a href="microbiome-community.html#cb246-4" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb246-5"><a href="microbiome-community.html#cb246-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb246-6"><a href="microbiome-community.html#cb246-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Create layout</span></span>
<span id="cb246-7"><a href="microbiome-community.html#cb246-7" aria-hidden="true" tabindex="-1"></a>design <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb246-8"><a href="microbiome-community.html#cb246-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">area</span>(<span class="dv">3</span>, <span class="dv">1</span>, <span class="dv">4</span>, <span class="dv">1</span>),</span>
<span id="cb246-9"><a href="microbiome-community.html#cb246-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">area</span>(<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">1</span>, <span class="dv">3</span>),</span>
<span id="cb246-10"><a href="microbiome-community.html#cb246-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">area</span>(<span class="dv">2</span>, <span class="dv">2</span>, <span class="dv">2</span>, <span class="dv">3</span>),</span>
<span id="cb246-11"><a href="microbiome-community.html#cb246-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">area</span>(<span class="dv">3</span>, <span class="dv">2</span>, <span class="dv">4</span>, <span class="dv">3</span>)</span>
<span id="cb246-12"><a href="microbiome-community.html#cb246-12" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb246-13"><a href="microbiome-community.html#cb246-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb246-14"><a href="microbiome-community.html#cb246-14" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(design)</span></code></pre></div>
<p><img src="21_microbiome_community_files/figure-html/more_complex_heatmap5-1.png" width="672" /></p>
<div class="sourceCode" id="cb247"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb247-1"><a href="microbiome-community.html#cb247-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Combine plots</span></span>
<span id="cb247-2"><a href="microbiome-community.html#cb247-2" aria-hidden="true" tabindex="-1"></a>plot <span class="ot">&lt;-</span> row_annotation <span class="sc">+</span> sample_clusters_annotation <span class="sc">+</span> sample_types_annotation <span class="sc">+</span> heatmap  <span class="sc">+</span></span>
<span id="cb247-3"><a href="microbiome-community.html#cb247-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">plot_layout</span>(<span class="at">design =</span> design, <span class="at">guides =</span> <span class="st">&quot;collect&quot;</span>, <span class="co"># Specify layout, collect legends</span></span>
<span id="cb247-4"><a href="microbiome-community.html#cb247-4" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb247-5"><a href="microbiome-community.html#cb247-5" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Adjust widths and heights to align plots.</span></span>
<span id="cb247-6"><a href="microbiome-community.html#cb247-6" aria-hidden="true" tabindex="-1"></a>                <span class="co"># When annotation plot is larger, it might not fit into its column/row.</span></span>
<span id="cb247-7"><a href="microbiome-community.html#cb247-7" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Then you need to make column/row larger.</span></span>
<span id="cb247-8"><a href="microbiome-community.html#cb247-8" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb247-9"><a href="microbiome-community.html#cb247-9" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Relative widths and heights of each column and row:</span></span>
<span id="cb247-10"><a href="microbiome-community.html#cb247-10" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Currently, the width of the first column is 15 % and the height of</span></span>
<span id="cb247-11"><a href="microbiome-community.html#cb247-11" aria-hidden="true" tabindex="-1"></a>                <span class="co"># first two rows are 30 % the size of others</span></span>
<span id="cb247-12"><a href="microbiome-community.html#cb247-12" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb247-13"><a href="microbiome-community.html#cb247-13" aria-hidden="true" tabindex="-1"></a>                <span class="co"># To get this work most of the times, you can adjust all sizes to be 1, i.e. equal, </span></span>
<span id="cb247-14"><a href="microbiome-community.html#cb247-14" aria-hidden="true" tabindex="-1"></a>                <span class="co"># but then the gaps between plots are larger.</span></span>
<span id="cb247-15"><a href="microbiome-community.html#cb247-15" aria-hidden="true" tabindex="-1"></a>                <span class="at">widths =</span> <span class="fu">c</span>(<span class="fl">0.15</span>, <span class="dv">1</span>, <span class="dv">1</span>),</span>
<span id="cb247-16"><a href="microbiome-community.html#cb247-16" aria-hidden="true" tabindex="-1"></a>                <span class="at">heights =</span> <span class="fu">c</span>(<span class="fl">0.3</span>, <span class="fl">0.3</span>, <span class="dv">1</span>, <span class="dv">1</span>))</span>
<span id="cb247-17"><a href="microbiome-community.html#cb247-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb247-18"><a href="microbiome-community.html#cb247-18" aria-hidden="true" tabindex="-1"></a>plot</span></code></pre></div>
<p><img src="21_microbiome_community_files/figure-html/more_complex_heatmap6-1.png" width="960" /></p>
<div class="sourceCode" id="cb248"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb248-1"><a href="microbiome-community.html#cb248-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create layout</span></span>
<span id="cb248-2"><a href="microbiome-community.html#cb248-2" aria-hidden="true" tabindex="-1"></a>design <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb248-3"><a href="microbiome-community.html#cb248-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">area</span>(<span class="dv">4</span>, <span class="dv">1</span>, <span class="dv">5</span>, <span class="dv">1</span>),</span>
<span id="cb248-4"><a href="microbiome-community.html#cb248-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">area</span>(<span class="dv">4</span>, <span class="dv">2</span>, <span class="dv">5</span>, <span class="dv">2</span>),</span>
<span id="cb248-5"><a href="microbiome-community.html#cb248-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">area</span>(<span class="dv">1</span>, <span class="dv">3</span>, <span class="dv">1</span>, <span class="dv">4</span>),</span>
<span id="cb248-6"><a href="microbiome-community.html#cb248-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">area</span>(<span class="dv">2</span>, <span class="dv">3</span>, <span class="dv">2</span>, <span class="dv">4</span>),</span>
<span id="cb248-7"><a href="microbiome-community.html#cb248-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">area</span>(<span class="dv">3</span>, <span class="dv">3</span>, <span class="dv">3</span>, <span class="dv">4</span>),</span>
<span id="cb248-8"><a href="microbiome-community.html#cb248-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">area</span>(<span class="dv">4</span>, <span class="dv">3</span>, <span class="dv">5</span>, <span class="dv">4</span>)</span>
<span id="cb248-9"><a href="microbiome-community.html#cb248-9" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb248-10"><a href="microbiome-community.html#cb248-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb248-11"><a href="microbiome-community.html#cb248-11" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(design)</span></code></pre></div>
<p><img src="21_microbiome_community_files/figure-html/more_complex_heatmap7-1.png" width="672" /></p>
<div class="sourceCode" id="cb249"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb249-1"><a href="microbiome-community.html#cb249-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Combine plots</span></span>
<span id="cb249-2"><a href="microbiome-community.html#cb249-2" aria-hidden="true" tabindex="-1"></a>plot <span class="ot">&lt;-</span> taxa_tree <span class="sc">+</span> </span>
<span id="cb249-3"><a href="microbiome-community.html#cb249-3" aria-hidden="true" tabindex="-1"></a>  row_annotation <span class="sc">+</span></span>
<span id="cb249-4"><a href="microbiome-community.html#cb249-4" aria-hidden="true" tabindex="-1"></a>  sample_tree <span class="sc">+</span> </span>
<span id="cb249-5"><a href="microbiome-community.html#cb249-5" aria-hidden="true" tabindex="-1"></a>  sample_clusters_annotation <span class="sc">+</span></span>
<span id="cb249-6"><a href="microbiome-community.html#cb249-6" aria-hidden="true" tabindex="-1"></a>  sample_types_annotation <span class="sc">+</span></span>
<span id="cb249-7"><a href="microbiome-community.html#cb249-7" aria-hidden="true" tabindex="-1"></a>  heatmap <span class="sc">+</span></span>
<span id="cb249-8"><a href="microbiome-community.html#cb249-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">plot_layout</span>(<span class="at">design =</span> design, <span class="at">guides =</span> <span class="st">&quot;collect&quot;</span>, <span class="co"># Specify layout, collect legends</span></span>
<span id="cb249-9"><a href="microbiome-community.html#cb249-9" aria-hidden="true" tabindex="-1"></a>                <span class="at">widths =</span> <span class="fu">c</span>(<span class="fl">0.2</span>, <span class="fl">0.15</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>),</span>
<span id="cb249-10"><a href="microbiome-community.html#cb249-10" aria-hidden="true" tabindex="-1"></a>                <span class="at">heights =</span> <span class="fu">c</span>(<span class="fl">0.1</span>, <span class="fl">0.15</span>, <span class="fl">0.15</span>, <span class="fl">0.25</span>, <span class="dv">1</span>, <span class="dv">1</span>))</span>
<span id="cb249-11"><a href="microbiome-community.html#cb249-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb249-12"><a href="microbiome-community.html#cb249-12" aria-hidden="true" tabindex="-1"></a>plot</span></code></pre></div>
<p><img src="21_microbiome_community_files/figure-html/more_complex_heatmap8-1.png" width="960" /></p>
</div>
</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="community-similarity.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="community-typing.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": true,
"facebook": false,
"twitter": true,
"linkedin": true,
"weibo": false,
"instapaper": false,
"vk": false,
"whatsapp": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": null,
"text": null
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": ["OMA.pdf"],
"search": {
"engine": "fuse",
"options": null
},
"toc": {
"collapse": "subsection"
}
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
