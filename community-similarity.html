<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Chapter 8 Community similarity | Orchestrating Microbiome Analysis</title>
  <meta name="description" content="Chapter 8 Community similarity | Orchestrating Microbiome Analysis" />
  <meta name="generator" content="bookdown 0.29 and GitBook 2.6.7" />

  <meta property="og:title" content="Chapter 8 Community similarity | Orchestrating Microbiome Analysis" />
  <meta property="og:type" content="book" />
  
  
  <meta name="github-repo" content="microbiome/OMA" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Chapter 8 Community similarity | Orchestrating Microbiome Analysis" />
  
  
  




  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="community-diversity.html"/>
<link rel="next" href="microbiome-community.html"/>
<script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fuse.js@6.4.6/dist/fuse.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />








<link href="libs/anchor-sections-1.1.0/anchor-sections.css" rel="stylesheet" />
<link href="libs/anchor-sections-1.1.0/anchor-sections-hash.css" rel="stylesheet" />
<script src="libs/anchor-sections-1.1.0/anchor-sections.js"></script>
<script src="libs/kePrint-0.0.1/kePrint.js"></script>
<link href="libs/lightable-0.0.1/lightable.css" rel="stylesheet" />
<script src="libs/htmlwidgets-1.5.4/htmlwidgets.js"></script>
<script src="libs/plotly-binding-4.10.0/plotly.js"></script>
<script src="libs/typedarray-0.1/typedarray.min.js"></script>
<link href="libs/crosstalk-1.2.0/css/crosstalk.min.css" rel="stylesheet" />
<script src="libs/crosstalk-1.2.0/js/crosstalk.min.js"></script>
<link href="libs/plotly-htmlwidgets-css-2.5.1/plotly-htmlwidgets.css" rel="stylesheet" />
<script src="libs/plotly-main-2.5.1/plotly-latest.min.js"></script>


<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

<style type="text/css">
/* Used with Pandoc 2.11+ new --citeproc when CSL is used */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
}
.hanging div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}
</style>

<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">Orchestrating Microbiome Analysis</a></li>

<li class="divider"></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i>Welcome</a></li>
<li class="part"><span><b>I Introduction</b></span></li>
<li class="chapter" data-level="1" data-path="intro.html"><a href="intro.html"><i class="fa fa-check"></i><b>1</b> Introduction</a></li>
<li class="chapter" data-level="2" data-path="containers.html"><a href="containers.html"><i class="fa fa-check"></i><b>2</b> Microbiome Data</a>
<ul>
<li class="chapter" data-level="2.1" data-path="containers.html"><a href="containers.html#data-science-framework"><i class="fa fa-check"></i><b>2.1</b> Data science framework</a></li>
<li class="chapter" data-level="2.2" data-path="containers.html"><a href="containers.html#data-containers"><i class="fa fa-check"></i><b>2.2</b> Data containers</a>
<ul>
<li class="chapter" data-level="2.2.1" data-path="containers.html"><a href="containers.html#assay-data"><i class="fa fa-check"></i><b>2.2.1</b> Assay data</a></li>
<li class="chapter" data-level="2.2.2" data-path="containers.html"><a href="containers.html#coldata"><i class="fa fa-check"></i><b>2.2.2</b> colData</a></li>
<li class="chapter" data-level="2.2.3" data-path="containers.html"><a href="containers.html#rowdata"><i class="fa fa-check"></i><b>2.2.3</b> rowData</a></li>
<li class="chapter" data-level="2.2.4" data-path="containers.html"><a href="containers.html#rowtree"><i class="fa fa-check"></i><b>2.2.4</b> rowTree</a></li>
<li class="chapter" data-level="2.2.5" data-path="containers.html"><a href="containers.html#alternative-experiments"><i class="fa fa-check"></i><b>2.2.5</b> Alternative experiments</a></li>
<li class="chapter" data-level="2.2.6" data-path="containers.html"><a href="containers.html#multiassayexperiments"><i class="fa fa-check"></i><b>2.2.6</b> MultiAssayExperiments</a></li>
</ul></li>
<li class="chapter" data-level="2.3" data-path="containers.html"><a href="containers.html#loading-experimental-microbiome-data"><i class="fa fa-check"></i><b>2.3</b> Loading experimental microbiome data</a>
<ul>
<li class="chapter" data-level="2.3.1" data-path="containers.html"><a href="containers.html#s-workflow"><i class="fa fa-check"></i><b>2.3.1</b> 16S workflow</a></li>
<li class="chapter" data-level="2.3.2" data-path="containers.html"><a href="containers.html#import-from-external-files"><i class="fa fa-check"></i><b>2.3.2</b> Import from external files</a></li>
<li class="chapter" data-level="2.3.3" data-path="containers.html"><a href="containers.html#conversions-between-data-formats-in-r"><i class="fa fa-check"></i><b>2.3.3</b> Conversions between data formats in R</a></li>
</ul></li>
<li class="chapter" data-level="2.4" data-path="containers.html"><a href="containers.html#example-data"><i class="fa fa-check"></i><b>2.4</b> Demonstration data</a>
<ul>
<li class="chapter" data-level="2.4.1" data-path="containers.html"><a href="containers.html#package-data"><i class="fa fa-check"></i><b>2.4.1</b> Package data</a></li>
<li class="chapter" data-level="2.4.2" data-path="containers.html"><a href="containers.html#experimenthub-data"><i class="fa fa-check"></i><b>2.4.2</b> ExperimentHub data</a></li>
<li class="chapter" data-level="2.4.3" data-path="containers.html"><a href="containers.html#other-data-sources"><i class="fa fa-check"></i><b>2.4.3</b> Other data sources</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="containers.html"><a href="containers.html#session-info"><i class="fa fa-check"></i>Session Info</a></li>
</ul></li>
<li class="chapter" data-level="3" data-path="packages.html"><a href="packages.html"><i class="fa fa-check"></i><b>3</b> Packages</a>
<ul>
<li class="chapter" data-level="3.1" data-path="packages.html"><a href="packages.html#package-installation"><i class="fa fa-check"></i><b>3.1</b> Package installation</a></li>
<li class="chapter" data-level="3.2" data-path="packages.html"><a href="packages.html#some-available-packages"><i class="fa fa-check"></i><b>3.2</b> Some available packages</a></li>
<li class="chapter" data-level="" data-path="packages.html"><a href="packages.html#session-info-1"><i class="fa fa-check"></i>Session Info</a></li>
</ul></li>
<li class="part"><span><b>II Focus Topics</b></span></li>
<li class="chapter" data-level="4" data-path="datamanipulation.html"><a href="datamanipulation.html"><i class="fa fa-check"></i><b>4</b> Data Manipulation</a>
<ul>
<li class="chapter" data-level="4.1" data-path="datamanipulation.html"><a href="datamanipulation.html#tidying-and-subsetting"><i class="fa fa-check"></i><b>4.1</b> Tidying and subsetting</a>
<ul>
<li class="chapter" data-level="4.1.1" data-path="datamanipulation.html"><a href="datamanipulation.html#tidy-data"><i class="fa fa-check"></i><b>4.1.1</b> Tidy data</a></li>
<li class="chapter" data-level="4.1.2" data-path="datamanipulation.html"><a href="datamanipulation.html#subsetting"><i class="fa fa-check"></i><b>4.1.2</b> Subsetting</a></li>
<li class="chapter" data-level="4.1.3" data-path="datamanipulation.html"><a href="datamanipulation.html#splitting"><i class="fa fa-check"></i><b>4.1.3</b> Splitting</a></li>
</ul></li>
<li class="chapter" data-level="4.2" data-path="datamanipulation.html"><a href="datamanipulation.html#merge-data"><i class="fa fa-check"></i><b>4.2</b> Merge data</a>
<ul>
<li class="chapter" data-level="4.2.1" data-path="datamanipulation.html"><a href="datamanipulation.html#additional-functions"><i class="fa fa-check"></i><b>4.2.1</b> Additional functions</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="5" data-path="quality-control.html"><a href="quality-control.html"><i class="fa fa-check"></i><b>5</b> Exploration and quality Control</a>
<ul>
<li class="chapter" data-level="5.1" data-path="quality-control.html"><a href="quality-control.html#abundance"><i class="fa fa-check"></i><b>5.1</b> Abundance</a></li>
<li class="chapter" data-level="5.2" data-path="quality-control.html"><a href="quality-control.html#prevalence"><i class="fa fa-check"></i><b>5.2</b> Prevalence</a>
<ul>
<li class="chapter" data-level="5.2.1" data-path="quality-control.html"><a href="quality-control.html#prevalence-analysis"><i class="fa fa-check"></i><b>5.2.1</b> Prevalence analysis</a></li>
<li class="chapter" data-level="5.2.2" data-path="quality-control.html"><a href="quality-control.html#rare-taxa"><i class="fa fa-check"></i><b>5.2.2</b> Rare taxa</a></li>
<li class="chapter" data-level="5.2.3" data-path="quality-control.html"><a href="quality-control.html#plotting-prevalence"><i class="fa fa-check"></i><b>5.2.3</b> Plotting prevalence</a></li>
</ul></li>
<li class="chapter" data-level="5.3" data-path="quality-control.html"><a href="quality-control.html#qc"><i class="fa fa-check"></i><b>5.3</b> Quality control</a>
<ul>
<li class="chapter" data-level="5.3.1" data-path="quality-control.html"><a href="quality-control.html#top-taxa"><i class="fa fa-check"></i><b>5.3.1</b> Top taxa</a></li>
<li class="chapter" data-level="5.3.2" data-path="quality-control.html"><a href="quality-control.html#library-size-read-count"><i class="fa fa-check"></i><b>5.3.2</b> Library size / read count</a></li>
<li class="chapter" data-level="5.3.3" data-path="quality-control.html"><a href="quality-control.html#contaminant-sequences"><i class="fa fa-check"></i><b>5.3.3</b> Contaminant sequences</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="quality-control.html"><a href="quality-control.html#session-info-2"><i class="fa fa-check"></i>Session Info</a></li>
</ul></li>
<li class="chapter" data-level="6" data-path="taxonomic-information.html"><a href="taxonomic-information.html"><i class="fa fa-check"></i><b>6</b> Taxonomic Information</a>
<ul>
<li class="chapter" data-level="6.1" data-path="taxonomic-information.html"><a href="taxonomic-information.html#assigning-taxonomic-information."><i class="fa fa-check"></i><b>6.1</b> Assigning taxonomic information.</a>
<ul>
<li class="chapter" data-level="6.1.1" data-path="taxonomic-information.html"><a href="taxonomic-information.html#dada2"><i class="fa fa-check"></i><b>6.1.1</b> dada2</a></li>
<li class="chapter" data-level="6.1.2" data-path="taxonomic-information.html"><a href="taxonomic-information.html#decipher"><i class="fa fa-check"></i><b>6.1.2</b> DECIPHER</a></li>
</ul></li>
<li class="chapter" data-level="6.2" data-path="taxonomic-information.html"><a href="taxonomic-information.html#functions-to-access-taxonomic-information"><i class="fa fa-check"></i><b>6.2</b> Functions to access taxonomic information</a>
<ul>
<li class="chapter" data-level="6.2.1" data-path="taxonomic-information.html"><a href="taxonomic-information.html#generate-a-taxonomic-tree-on-the-fly"><i class="fa fa-check"></i><b>6.2.1</b> Generate a taxonomic tree on the fly</a></li>
</ul></li>
<li class="chapter" data-level="6.3" data-path="taxonomic-information.html"><a href="taxonomic-information.html#data-agglomeration"><i class="fa fa-check"></i><b>6.3</b> Data agglomeration</a></li>
<li class="chapter" data-level="6.4" data-path="taxonomic-information.html"><a href="taxonomic-information.html#data-transformation"><i class="fa fa-check"></i><b>6.4</b> Data transformation</a></li>
<li class="chapter" data-level="6.5" data-path="taxonomic-information.html"><a href="taxonomic-information.html#pick-specific"><i class="fa fa-check"></i><b>6.5</b> Pick specific</a>
<ul>
<li class="chapter" data-level="6.5.1" data-path="taxonomic-information.html"><a href="taxonomic-information.html#abundances-of-all-taxa-in-specific-sample"><i class="fa fa-check"></i><b>6.5.1</b> Abundances of all taxa in specific sample</a></li>
<li class="chapter" data-level="6.5.2" data-path="taxonomic-information.html"><a href="taxonomic-information.html#abundances-of-specific-taxa-in-all-samples"><i class="fa fa-check"></i><b>6.5.2</b> Abundances of specific taxa in all samples</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="taxonomic-information.html"><a href="taxonomic-information.html#session-info-3"><i class="fa fa-check"></i>Session Info</a></li>
</ul></li>
<li class="chapter" data-level="7" data-path="community-diversity.html"><a href="community-diversity.html"><i class="fa fa-check"></i><b>7</b> Community diversity</a>
<ul>
<li class="chapter" data-level="7.1" data-path="community-diversity.html"><a href="community-diversity.html#estimation"><i class="fa fa-check"></i><b>7.1</b> Estimation</a>
<ul>
<li class="chapter" data-level="7.1.1" data-path="community-diversity.html"><a href="community-diversity.html#richness"><i class="fa fa-check"></i><b>7.1.1</b> Richness</a></li>
<li class="chapter" data-level="7.1.2" data-path="community-diversity.html"><a href="community-diversity.html#estimate-diversity"><i class="fa fa-check"></i><b>7.1.2</b> Diversity</a></li>
<li class="chapter" data-level="7.1.3" data-path="community-diversity.html"><a href="community-diversity.html#faith-diversity"><i class="fa fa-check"></i><b>7.1.3</b> Faith phylogenetic diversity</a></li>
<li class="chapter" data-level="7.1.4" data-path="community-diversity.html"><a href="community-diversity.html#evenness"><i class="fa fa-check"></i><b>7.1.4</b> Evenness</a></li>
<li class="chapter" data-level="7.1.5" data-path="community-diversity.html"><a href="community-diversity.html#dominance"><i class="fa fa-check"></i><b>7.1.5</b> Dominance</a></li>
<li class="chapter" data-level="7.1.6" data-path="community-diversity.html"><a href="community-diversity.html#rarity"><i class="fa fa-check"></i><b>7.1.6</b> Rarity</a></li>
<li class="chapter" data-level="7.1.7" data-path="community-diversity.html"><a href="community-diversity.html#divergence"><i class="fa fa-check"></i><b>7.1.7</b> Divergence</a></li>
</ul></li>
<li class="chapter" data-level="7.2" data-path="community-diversity.html"><a href="community-diversity.html#visualization"><i class="fa fa-check"></i><b>7.2</b> Visualization</a></li>
<li class="chapter" data-level="" data-path="community-diversity.html"><a href="community-diversity.html#session-info-4"><i class="fa fa-check"></i>Session Info</a></li>
</ul></li>
<li class="chapter" data-level="8" data-path="community-similarity.html"><a href="community-similarity.html"><i class="fa fa-check"></i><b>8</b> Community similarity</a>
<ul>
<li class="chapter" data-level="8.1" data-path="community-similarity.html"><a href="community-similarity.html#explained-variance"><i class="fa fa-check"></i><b>8.1</b> Explained variance</a></li>
<li class="chapter" data-level="8.2" data-path="community-similarity.html"><a href="community-similarity.html#community-comparisons-by-beta-diversity-analysis"><i class="fa fa-check"></i><b>8.2</b> Community comparisons by beta diversity analysis</a></li>
<li class="chapter" data-level="8.3" data-path="community-similarity.html"><a href="community-similarity.html#other-ordination-methods"><i class="fa fa-check"></i><b>8.3</b> Other ordination methods</a></li>
<li class="chapter" data-level="8.4" data-path="community-similarity.html"><a href="community-similarity.html#visualizing-the-most-dominant-genus-on-pcoa"><i class="fa fa-check"></i><b>8.4</b> Visualizing the most dominant genus on PCoA</a>
<ul>
<li class="chapter" data-level="8.4.1" data-path="community-similarity.html"><a href="community-similarity.html#testing-differences-in-community-composition-between-sample-groups"><i class="fa fa-check"></i><b>8.4.1</b> Testing differences in community composition between sample groups</a></li>
<li class="chapter" data-level="8.4.2" data-path="community-similarity.html"><a href="community-similarity.html#checking-the-homogeneity-condition"><i class="fa fa-check"></i><b>8.4.2</b> Checking the homogeneity condition</a></li>
</ul></li>
<li class="chapter" data-level="8.5" data-path="community-similarity.html"><a href="community-similarity.html#further-reading"><i class="fa fa-check"></i><b>8.5</b> Further reading</a></li>
<li class="chapter" data-level="" data-path="community-similarity.html"><a href="community-similarity.html#session-info-5"><i class="fa fa-check"></i>Session Info</a></li>
</ul></li>
<li class="chapter" data-level="9" data-path="microbiome-community.html"><a href="microbiome-community.html"><i class="fa fa-check"></i><b>9</b> Community composition</a>
<ul>
<li class="chapter" data-level="9.1" data-path="microbiome-community.html"><a href="microbiome-community.html#visual-composition"><i class="fa fa-check"></i><b>9.1</b> Visualizing taxonomic composition</a>
<ul>
<li class="chapter" data-level="9.1.1" data-path="microbiome-community.html"><a href="microbiome-community.html#composition-barplot"><i class="fa fa-check"></i><b>9.1.1</b> Composition barplot</a></li>
<li class="chapter" data-level="9.1.2" data-path="microbiome-community.html"><a href="microbiome-community.html#composition-heatmap"><i class="fa fa-check"></i><b>9.1.2</b> Composition heatmap</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="microbiome-community.html"><a href="microbiome-community.html#session-info-6"><i class="fa fa-check"></i>Session Info</a></li>
</ul></li>
<li class="chapter" data-level="10" data-path="clustering.html"><a href="clustering.html"><i class="fa fa-check"></i><b>10</b> Community typing (clustering)</a>
<ul>
<li class="chapter" data-level="10.1" data-path="clustering.html"><a href="clustering.html#hiearchical-clustering"><i class="fa fa-check"></i><b>10.1</b> Hiearchical clustering</a></li>
<li class="chapter" data-level="10.2" data-path="clustering.html"><a href="clustering.html#k-means-clustering"><i class="fa fa-check"></i><b>10.2</b> K-means clustering</a></li>
<li class="chapter" data-level="10.3" data-path="clustering.html"><a href="clustering.html#dirichlet-multinomial-mixtures-dmm"><i class="fa fa-check"></i><b>10.3</b> Dirichlet Multinomial Mixtures (DMM)</a>
<ul>
<li class="chapter" data-level="10.3.1" data-path="clustering.html"><a href="clustering.html#pcoa-for-asv-level-data-with-bray-curtis-with-dmm-clusters-shown-with-colors"><i class="fa fa-check"></i><b>10.3.1</b> PCoA for ASV-level data with Bray-Curtis; with DMM clusters shown with colors</a></li>
</ul></li>
<li class="chapter" data-level="10.4" data-path="clustering.html"><a href="clustering.html#community-detection"><i class="fa fa-check"></i><b>10.4</b> Community Detection</a></li>
<li class="chapter" data-level="10.5" data-path="clustering.html"><a href="clustering.html#biclustering"><i class="fa fa-check"></i><b>10.5</b> Biclustering</a>
<ul>
<li class="chapter" data-level="10.5.1" data-path="clustering.html"><a href="clustering.html#taxa-vs-samples"><i class="fa fa-check"></i><b>10.5.1</b> Taxa vs samples</a></li>
<li class="chapter" data-level="10.5.2" data-path="clustering.html"><a href="clustering.html#taxa-vs-biomolecules"><i class="fa fa-check"></i><b>10.5.2</b> Taxa vs biomolecules</a></li>
<li class="chapter" data-level="10.5.3" data-path="clustering.html"><a href="clustering.html#taxa-vs-taxa"><i class="fa fa-check"></i><b>10.5.3</b> Taxa vs taxa</a></li>
</ul></li>
<li class="chapter" data-level="10.6" data-path="clustering.html"><a href="clustering.html#additional-community-typing"><i class="fa fa-check"></i><b>10.6</b> Additional Community Typing</a></li>
</ul></li>
<li class="chapter" data-level="11" data-path="differential-abundance.html"><a href="differential-abundance.html"><i class="fa fa-check"></i><b>11</b> Differential abundance</a>
<ul>
<li class="chapter" data-level="11.1" data-path="differential-abundance.html"><a href="differential-abundance.html#differential-abundance-analysis"><i class="fa fa-check"></i><b>11.1</b> Differential abundance analysis</a>
<ul>
<li class="chapter" data-level="11.1.1" data-path="differential-abundance.html"><a href="differential-abundance.html#examples-and-tools"><i class="fa fa-check"></i><b>11.1.1</b> Examples and tools</a></li>
<li class="chapter" data-level="11.1.2" data-path="differential-abundance.html"><a href="differential-abundance.html#prevalence-filtering"><i class="fa fa-check"></i><b>11.1.2</b> Prevalence Filtering</a></li>
<li class="chapter" data-level="11.1.3" data-path="differential-abundance.html"><a href="differential-abundance.html#aldex2"><i class="fa fa-check"></i><b>11.1.3</b> ALDEx2</a></li>
<li class="chapter" data-level="11.1.4" data-path="differential-abundance.html"><a href="differential-abundance.html#ancom-bc"><i class="fa fa-check"></i><b>11.1.4</b> ANCOM-BC</a></li>
<li class="chapter" data-level="11.1.5" data-path="differential-abundance.html"><a href="differential-abundance.html#maaslin2"><i class="fa fa-check"></i><b>11.1.5</b> MaAsLin2</a></li>
<li class="chapter" data-level="11.1.6" data-path="differential-abundance.html"><a href="differential-abundance.html#linda"><i class="fa fa-check"></i><b>11.1.6</b> LinDA</a></li>
<li class="chapter" data-level="11.1.7" data-path="differential-abundance.html"><a href="differential-abundance.html#comparison-of-the-methods"><i class="fa fa-check"></i><b>11.1.7</b> Comparison of the methods</a></li>
<li class="chapter" data-level="11.1.8" data-path="differential-abundance.html"><a href="differential-abundance.html#confounding-variables"><i class="fa fa-check"></i><b>11.1.8</b> Confounding variables</a></li>
</ul></li>
<li class="chapter" data-level="11.2" data-path="differential-abundance.html"><a href="differential-abundance.html#tree-based-methods"><i class="fa fa-check"></i><b>11.2</b> Tree-based methods</a>
<ul>
<li class="chapter" data-level="11.2.1" data-path="differential-abundance.html"><a href="differential-abundance.html#group-wise-associations-testing-based-on-balances-with-fido"><i class="fa fa-check"></i><b>11.2.1</b> Group-wise associations testing based on balances with fido</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="differential-abundance.html"><a href="differential-abundance.html#session-info-7"><i class="fa fa-check"></i>Session Info</a></li>
</ul></li>
<li class="chapter" data-level="12" data-path="machine_learning.html"><a href="machine_learning.html"><i class="fa fa-check"></i><b>12</b> Machine learning</a>
<ul>
<li class="chapter" data-level="12.1" data-path="machine_learning.html"><a href="machine_learning.html#supervised-machine-learning"><i class="fa fa-check"></i><b>12.1</b> Supervised machine learning</a></li>
<li class="chapter" data-level="12.2" data-path="machine_learning.html"><a href="machine_learning.html#unsupervised-machine-learning"><i class="fa fa-check"></i><b>12.2</b> Unsupervised machine learning</a></li>
<li class="chapter" data-level="" data-path="machine_learning.html"><a href="machine_learning.html#session-info-8"><i class="fa fa-check"></i>Session Info</a></li>
</ul></li>
<li class="chapter" data-level="13" data-path="multi-assay_analyses.html"><a href="multi-assay_analyses.html"><i class="fa fa-check"></i><b>13</b> Multi-assay analyses</a>
<ul>
<li class="chapter" data-level="13.1" data-path="multi-assay_analyses.html"><a href="multi-assay_analyses.html#cross-correlation-analysis"><i class="fa fa-check"></i><b>13.1</b> Cross-correlation Analysis</a></li>
<li class="chapter" data-level="13.2" data-path="multi-assay_analyses.html"><a href="multi-assay_analyses.html#multi-omics-factor-analysis"><i class="fa fa-check"></i><b>13.2</b> Multi-Omics Factor Analysis</a></li>
<li class="chapter" data-level="" data-path="multi-assay_analyses.html"><a href="multi-assay_analyses.html#session-info-9"><i class="fa fa-check"></i>Session Info</a></li>
</ul></li>
<li class="chapter" data-level="14" data-path="viz-chapter.html"><a href="viz-chapter.html"><i class="fa fa-check"></i><b>14</b> Visualization</a>
<ul>
<li class="chapter" data-level="14.1" data-path="viz-chapter.html"><a href="viz-chapter.html#pre-analysis-exploration"><i class="fa fa-check"></i><b>14.1</b> Pre-analysis exploration</a>
<ul>
<li class="chapter" data-level="14.1.1" data-path="viz-chapter.html"><a href="viz-chapter.html#accessing-row-and-column-data"><i class="fa fa-check"></i><b>14.1.1</b> Accessing row and column data</a></li>
<li class="chapter" data-level="14.1.2" data-path="viz-chapter.html"><a href="viz-chapter.html#viewing-abundance-and-prevalence-patterns"><i class="fa fa-check"></i><b>14.1.2</b> Viewing abundance and prevalence patterns</a></li>
</ul></li>
<li class="chapter" data-level="14.2" data-path="viz-chapter.html"><a href="viz-chapter.html#diversity-estimation"><i class="fa fa-check"></i><b>14.2</b> Diversity estimation</a>
<ul>
<li class="chapter" data-level="14.2.1" data-path="viz-chapter.html"><a href="viz-chapter.html#alpha-diversity-with-scatter-violin-and-box-plots"><i class="fa fa-check"></i><b>14.2.1</b> Alpha diversity with scatter, violin and box plots</a></li>
<li class="chapter" data-level="14.2.2" data-path="viz-chapter.html"><a href="viz-chapter.html#beta-diversity-with-shepard-and-coordination-plots"><i class="fa fa-check"></i><b>14.2.2</b> Beta diversity with Shepard and coordination plots</a></li>
</ul></li>
<li class="chapter" data-level="14.3" data-path="viz-chapter.html"><a href="viz-chapter.html#statistical-analysis"><i class="fa fa-check"></i><b>14.3</b> Statistical analysis</a>
<ul>
<li class="chapter" data-level="14.3.1" data-path="viz-chapter.html"><a href="viz-chapter.html#heatmaps"><i class="fa fa-check"></i><b>14.3.1</b> Heatmaps</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="viz-chapter.html"><a href="viz-chapter.html#session-info-10"><i class="fa fa-check"></i>Session Info</a></li>
</ul></li>
<li class="part"><span><b>III Appendix</b></span></li>
<li class="chapter" data-level="15" data-path="resources.html"><a href="resources.html"><i class="fa fa-check"></i><b>15</b> Resources</a>
<ul>
<li class="chapter" data-level="15.1" data-path="resources.html"><a href="resources.html#data-containers-1"><i class="fa fa-check"></i><b>15.1</b> Data containers</a>
<ul>
<li class="chapter" data-level="15.1.1" data-path="resources.html"><a href="resources.html#resources-for-treesummarizedexperiment"><i class="fa fa-check"></i><b>15.1.1</b> Resources for TreeSummarizedExperiment</a></li>
<li class="chapter" data-level="15.1.2" data-path="resources.html"><a href="resources.html#other-relevant-containers"><i class="fa fa-check"></i><b>15.1.2</b> Other relevant containers</a></li>
<li class="chapter" data-level="15.1.3" data-path="resources.html"><a href="resources.html#alternative-containers-for-microbiome-data"><i class="fa fa-check"></i><b>15.1.3</b> Alternative containers for microbiome data</a></li>
<li class="chapter" data-level="15.1.4" data-path="resources.html"><a href="resources.html#resources-for-phyloseq"><i class="fa fa-check"></i><b>15.1.4</b> Resources for phyloseq</a></li>
</ul></li>
<li class="chapter" data-level="15.2" data-path="resources.html"><a href="resources.html#r-programming-resources"><i class="fa fa-check"></i><b>15.2</b> R programming resources</a>
<ul>
<li class="chapter" data-level="15.2.1" data-path="resources.html"><a href="resources.html#bioc_intro"><i class="fa fa-check"></i><b>15.2.1</b> Bioconductor Classes</a></li>
</ul></li>
<li class="chapter" data-level="15.3" data-path="resources.html"><a href="resources.html#reproducible-reporting-with-rmarkdown"><i class="fa fa-check"></i><b>15.3</b> Reproducible reporting with Rmarkdown</a></li>
</ul></li>
<li class="chapter" data-level="16" data-path="extras.html"><a href="extras.html"><i class="fa fa-check"></i><b>16</b> Extra material</a>
<ul>
<li class="chapter" data-level="16.1" data-path="extras.html"><a href="extras.html#interactive-3d-plots"><i class="fa fa-check"></i><b>16.1</b> Interactive 3D Plots</a></li>
<li class="chapter" data-level="16.2" data-path="extras.html"><a href="extras.html#permanova-comparison"><i class="fa fa-check"></i><b>16.2</b> PERMANOVA comparison</a></li>
</ul></li>
<li class="chapter" data-level="17" data-path="acknowledgments.html"><a href="acknowledgments.html"><i class="fa fa-check"></i><b>17</b> Acknowledgments</a></li>
<li class="chapter" data-level="18" data-path="exercises.html"><a href="exercises.html"><i class="fa fa-check"></i><b>18</b> Exercises</a>
<ul>
<li class="chapter" data-level="18.1" data-path="exercises.html"><a href="exercises.html#workflows"><i class="fa fa-check"></i><b>18.1</b> Workflows</a>
<ul>
<li class="chapter" data-level="18.1.1" data-path="exercises.html"><a href="exercises.html#reproducible-reporting"><i class="fa fa-check"></i><b>18.1.1</b> Reproducible reporting</a></li>
</ul></li>
<li class="chapter" data-level="18.2" data-path="exercises.html"><a href="exercises.html#data-containers-2"><i class="fa fa-check"></i><b>18.2</b> Data containers</a>
<ul>
<li class="chapter" data-level="18.2.1" data-path="exercises.html"><a href="exercises.html#treesummarizedexperiment-data-exploration"><i class="fa fa-check"></i><b>18.2.1</b> TreeSummarizedExperiment data exploration</a></li>
<li class="chapter" data-level="18.2.2" data-path="exercises.html"><a href="exercises.html#treesummarizedexperiment-treese-data-import"><i class="fa fa-check"></i><b>18.2.2</b> TreeSummarizedExperiment (TreeSE) data import</a></li>
<li class="chapter" data-level="18.2.3" data-path="exercises.html"><a href="exercises.html#introduction-to-multiassayexperient-mae"><i class="fa fa-check"></i><b>18.2.3</b> Introduction to MultiAssayExperient (MAE)</a></li>
</ul></li>
<li class="chapter" data-level="18.3" data-path="exercises.html"><a href="exercises.html#data-manipulation"><i class="fa fa-check"></i><b>18.3</b> Data manipulation</a>
<ul>
<li class="chapter" data-level="18.3.1" data-path="exercises.html"><a href="exercises.html#prevalent-and-core-features"><i class="fa fa-check"></i><b>18.3.1</b> Prevalent and core features</a></li>
<li class="chapter" data-level="18.3.2" data-path="exercises.html"><a href="exercises.html#taxonomic-levels"><i class="fa fa-check"></i><b>18.3.2</b> Taxonomic levels</a></li>
</ul></li>
<li class="chapter" data-level="18.4" data-path="exercises.html"><a href="exercises.html#differential-abundance-1"><i class="fa fa-check"></i><b>18.4</b> Differential abundance</a>
<ul>
<li class="chapter" data-level="18.4.1" data-path="exercises.html"><a href="exercises.html#univariate-analyses"><i class="fa fa-check"></i><b>18.4.1</b> Univariate analyses</a></li>
<li class="chapter" data-level="18.4.2" data-path="exercises.html"><a href="exercises.html#differential-abundance-analysis-1"><i class="fa fa-check"></i><b>18.4.2</b> Differential abundance analysis</a></li>
</ul></li>
<li class="chapter" data-level="18.5" data-path="exercises.html"><a href="exercises.html#alpha-diversity"><i class="fa fa-check"></i><b>18.5</b> Alpha diversity</a>
<ul>
<li class="chapter" data-level="18.5.1" data-path="exercises.html"><a href="exercises.html#alpha-diversity-basics"><i class="fa fa-check"></i><b>18.5.1</b> Alpha diversity basics</a></li>
<li class="chapter" data-level="18.5.2" data-path="exercises.html"><a href="exercises.html#alpha-diversity-extra"><i class="fa fa-check"></i><b>18.5.2</b> Alpha diversity extra</a></li>
</ul></li>
<li class="chapter" data-level="18.6" data-path="exercises.html"><a href="exercises.html#community-composition"><i class="fa fa-check"></i><b>18.6</b> Community composition</a>
<ul>
<li class="chapter" data-level="18.6.1" data-path="exercises.html"><a href="exercises.html#beta-diversity-basics"><i class="fa fa-check"></i><b>18.6.1</b> Beta diversity basics</a></li>
<li class="chapter" data-level="18.6.2" data-path="exercises.html"><a href="exercises.html#beta-diversity-extra"><i class="fa fa-check"></i><b>18.6.2</b> Beta diversity extra</a></li>
</ul></li>
<li class="chapter" data-level="18.7" data-path="exercises.html"><a href="exercises.html#visualization-1"><i class="fa fa-check"></i><b>18.7</b> Visualization</a>
<ul>
<li class="chapter" data-level="18.7.1" data-path="exercises.html"><a href="exercises.html#multivariate-ordination"><i class="fa fa-check"></i><b>18.7.1</b> Multivariate ordination</a></li>
<li class="chapter" data-level="18.7.2" data-path="exercises.html"><a href="exercises.html#heatmap-visualization"><i class="fa fa-check"></i><b>18.7.2</b> Heatmap visualization</a></li>
</ul></li>
<li class="chapter" data-level="18.8" data-path="exercises.html"><a href="exercises.html#multiomics"><i class="fa fa-check"></i><b>18.8</b> Multiomics</a>
<ul>
<li class="chapter" data-level="18.8.1" data-path="exercises.html"><a href="exercises.html#introduction-to-multiomics"><i class="fa fa-check"></i><b>18.8.1</b> Introduction to multiomics</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="" data-path="bibliography.html"><a href="bibliography.html"><i class="fa fa-check"></i>Bibliography</a></li>
<li class="divider"></li>
<li><a href="https://github.com/rstudio/bookdown" target="blank">Published with bookdown</a></li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Orchestrating Microbiome Analysis</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="community-similarity" class="section level1 hasAnchor" number="8">
<h1><span class="header-section-number">Chapter 8</span> Community similarity<a href="community-similarity.html#community-similarity" class="anchor-section" aria-label="Anchor link to header"></a></h1>
<p>Where alpha diversity focuses on community variation within a
community (sample), beta diversity quantifies (dis-)similarites
between communities (samples). Some of the most popular beta diversity
measures in microbiome research include Bray-Curtis index (for
compositional data), Jaccard index (for presence / absence data,
ignoring abundance information), Aitchison distance (Euclidean
distance for clr transformed abundances, aiming to avoid the
compositionality bias), and the Unifrac distances (that take into
account the phylogenetic tree information). Only some of the commonly
used beta diversity measures are actual <em>distances</em>; this is a
mathematically well-defined concept and many ecological beta diversity
measures, such as Bray-Curtis index, are not proper distances.
Therefore, the term dissimilarity or beta diversity is commonly used.</p>
<p>Technically, beta diversities are usually represented as <code>dist</code>
objects, which contain triangular data describing the distance between
each pair of samples. These distances can be further subjected to
ordination. Ordination is a common concept in ecology that aims to
reduce the dimensionality of the data for further evaluation or
visualization. Ordination techniques aim to capture as much of
essential information in the data as possible in a lower dimensional
representation. Dimension reduction is bound to loose information but
the common ordination techniques aim to preserve relevant information
of sample similarities in an optimal way, which is defined in
different ways by different methods. [TODO add references and/or link
to ordination chapter instead?]</p>
<p>Some of the most common ordination methods in microbiome research
include Principal Component Analysis (PCA), metric and non-metric
multi-dimensional scaling (MDS, NMDS), The MDS methods are also known
as Principal Coordinates Analysis (PCoA). Other recently popular
techniques include t-SNE and UMAP.</p>
<div id="explained-variance" class="section level2 hasAnchor" number="8.1">
<h2><span class="header-section-number">8.1</span> Explained variance<a href="community-similarity.html#explained-variance" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>The percentage of explained variance is typically shown for PCA
ordination plots. This quantifies the proportion of overall variance
in the data that is captured by the PCA axes, or how well the
ordination axes reflect the original distances.</p>
<p>Sometimes a similar measure is shown for MDS/PCoA. The interpretation
is generally different, however, and hence we do not recommend using
it. PCA is a special case of PCoA with Euclidean distances. With
non-Euclidean dissimilarities PCoA uses a trick where the pointwise
dissimilarities are first cast into similarities in a Euclidean space
(with some information loss i.e. stress) and then projected to the
maximal variance axes. In this case, the maximal variance axes do not
directly reflect the correspondence of the projected distances and
original distances, as they do for PCA.</p>
<p>In typical use cases, we would like to know how well the ordination
reflects the original similarity structures; then the quantity of
interest is the so-called “stress” function, which measures the
difference in pairwise similarities between the data points in the
original (high-dimensional) vs. projected (low-dimensional) space.</p>
<p>Hence, we propose that for PCoA and other ordination methods, users
would report relative stress (varies in the unit interval; the smaller
the better). This can be calculated as shown below. For further
examples, check the <a href="https://www.huber.embl.de/users/klaus/Teaching/statisticalMethods-lab.pdf">note from Huber
lab</a>.</p>
<div class="sourceCode" id="cb218"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb218-1"><a href="community-similarity.html#cb218-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Example data</span></span>
<span id="cb218-2"><a href="community-similarity.html#cb218-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(mia)</span>
<span id="cb218-3"><a href="community-similarity.html#cb218-3" aria-hidden="true" tabindex="-1"></a><span class="fu">data</span>(GlobalPatterns, <span class="at">package=</span><span class="st">&quot;mia&quot;</span>)</span>
<span id="cb218-4"><a href="community-similarity.html#cb218-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb218-5"><a href="community-similarity.html#cb218-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Data matrix (features x samples)</span></span>
<span id="cb218-6"><a href="community-similarity.html#cb218-6" aria-hidden="true" tabindex="-1"></a>tse <span class="ot">&lt;-</span> GlobalPatterns</span>
<span id="cb218-7"><a href="community-similarity.html#cb218-7" aria-hidden="true" tabindex="-1"></a>tse <span class="ot">&lt;-</span> <span class="fu">transformCounts</span>(tse, <span class="at">method =</span> <span class="st">&quot;relabundance&quot;</span>)</span>
<span id="cb218-8"><a href="community-similarity.html#cb218-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb218-9"><a href="community-similarity.html#cb218-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Add group information Feces yes/no</span></span>
<span id="cb218-10"><a href="community-similarity.html#cb218-10" aria-hidden="true" tabindex="-1"></a><span class="fu">colData</span>(tse)<span class="sc">$</span>Group <span class="ot">&lt;-</span> <span class="fu">colData</span>(tse)<span class="sc">$</span>SampleType<span class="sc">==</span><span class="st">&quot;Feces&quot;</span></span>
<span id="cb218-11"><a href="community-similarity.html#cb218-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb218-12"><a href="community-similarity.html#cb218-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Quantify dissimilarities in the original feature space</span></span>
<span id="cb218-13"><a href="community-similarity.html#cb218-13" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(vegan)</span>
<span id="cb218-14"><a href="community-similarity.html#cb218-14" aria-hidden="true" tabindex="-1"></a>x <span class="ot">&lt;-</span> <span class="fu">assay</span>(tse, <span class="st">&quot;relabundance&quot;</span>) <span class="co"># Pick relabunance assay separately</span></span>
<span id="cb218-15"><a href="community-similarity.html#cb218-15" aria-hidden="true" tabindex="-1"></a>d0 <span class="ot">&lt;-</span> <span class="fu">as.matrix</span>(<span class="fu">vegdist</span>(<span class="fu">t</span>(x), <span class="st">&quot;bray&quot;</span>))</span>
<span id="cb218-16"><a href="community-similarity.html#cb218-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb218-17"><a href="community-similarity.html#cb218-17" aria-hidden="true" tabindex="-1"></a><span class="co"># PCoA Ordination</span></span>
<span id="cb218-18"><a href="community-similarity.html#cb218-18" aria-hidden="true" tabindex="-1"></a>pcoa <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(<span class="fu">cmdscale</span>(d0, <span class="at">k =</span> <span class="dv">2</span>))</span>
<span id="cb218-19"><a href="community-similarity.html#cb218-19" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(pcoa) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;PCoA1&quot;</span>, <span class="st">&quot;PCoA2&quot;</span>)</span>
<span id="cb218-20"><a href="community-similarity.html#cb218-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb218-21"><a href="community-similarity.html#cb218-21" aria-hidden="true" tabindex="-1"></a><span class="co"># Quantify dissimilarities in the ordination space</span></span>
<span id="cb218-22"><a href="community-similarity.html#cb218-22" aria-hidden="true" tabindex="-1"></a>dp <span class="ot">&lt;-</span> <span class="fu">as.matrix</span>(<span class="fu">dist</span>(pcoa))</span>
<span id="cb218-23"><a href="community-similarity.html#cb218-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb218-24"><a href="community-similarity.html#cb218-24" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate stress i.e. relative difference in the original and</span></span>
<span id="cb218-25"><a href="community-similarity.html#cb218-25" aria-hidden="true" tabindex="-1"></a><span class="co"># projected dissimilarities</span></span>
<span id="cb218-26"><a href="community-similarity.html#cb218-26" aria-hidden="true" tabindex="-1"></a>stress <span class="ot">&lt;-</span> <span class="fu">sum</span>((dp <span class="sc">-</span> d0)<span class="sc">^</span><span class="dv">2</span>)<span class="sc">/</span><span class="fu">sum</span>(d0<span class="sc">^</span><span class="dv">2</span>)</span></code></pre></div>
<p>Shepard plot visualizes the original versus projected (ordination)
dissimilarities between the data points:</p>
<div class="sourceCode" id="cb219"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb219-1"><a href="community-similarity.html#cb219-1" aria-hidden="true" tabindex="-1"></a>ord <span class="ot">&lt;-</span> <span class="fu">order</span>(<span class="fu">as.vector</span>(d0))</span>
<span id="cb219-2"><a href="community-similarity.html#cb219-2" aria-hidden="true" tabindex="-1"></a>df <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">d0 =</span> <span class="fu">as.vector</span>(d0)[ord],</span>
<span id="cb219-3"><a href="community-similarity.html#cb219-3" aria-hidden="true" tabindex="-1"></a>                  <span class="at">dmds =</span> <span class="fu">as.vector</span>(dp)[ord])</span>
<span id="cb219-4"><a href="community-similarity.html#cb219-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb219-5"><a href="community-similarity.html#cb219-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb219-6"><a href="community-similarity.html#cb219-6" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> d0, <span class="at">y =</span> dmds), <span class="at">data=</span>df) <span class="sc">+</span> </span>
<span id="cb219-7"><a href="community-similarity.html#cb219-7" aria-hidden="true" tabindex="-1"></a>       <span class="fu">geom_smooth</span>() <span class="sc">+</span></span>
<span id="cb219-8"><a href="community-similarity.html#cb219-8" aria-hidden="true" tabindex="-1"></a>       <span class="fu">geom_point</span>() <span class="sc">+</span>       </span>
<span id="cb219-9"><a href="community-similarity.html#cb219-9" aria-hidden="true" tabindex="-1"></a>       <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">&quot;Shepard plot&quot;</span>,</span>
<span id="cb219-10"><a href="community-similarity.html#cb219-10" aria-hidden="true" tabindex="-1"></a>       <span class="at">x =</span> <span class="st">&quot;Original distance&quot;</span>,</span>
<span id="cb219-11"><a href="community-similarity.html#cb219-11" aria-hidden="true" tabindex="-1"></a>       <span class="at">y =</span> <span class="st">&quot;MDS distance&quot;</span>,       </span>
<span id="cb219-12"><a href="community-similarity.html#cb219-12" aria-hidden="true" tabindex="-1"></a>            <span class="at">subtitle =</span> <span class="fu">paste</span>(<span class="st">&quot;Stress:&quot;</span>, <span class="fu">round</span>(stress, <span class="dv">2</span>))) <span class="sc">+</span></span>
<span id="cb219-13"><a href="community-similarity.html#cb219-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>()</span></code></pre></div>
<p><img src="20_beta_diversity_files/figure-html/shepard-1.png" width="3000" /></p>
</div>
<div id="community-comparisons-by-beta-diversity-analysis" class="section level2 hasAnchor" number="8.2">
<h2><span class="header-section-number">8.2</span> Community comparisons by beta diversity analysis<a href="community-similarity.html#community-comparisons-by-beta-diversity-analysis" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>A typical comparison of community composition starts with a visual
comparison of the groups on a 2D ordination.</p>
<p>Then we estimate relative abundances and MDS ordination based on
Bray-Curtis (BC) dissimilarity between the groups, and visualize the
results.</p>
<p>In the following examples dissimilarities are calculated by
functions supplied to the <code>FUN</code> argument. This function can be defined by
the user. It must return a <code>dist</code> function, which can then be used to
calculate reduced dimensions either via ordination methods (such as MDS
or NMDS), and the results can be stored in the <code>reducedDim</code>.</p>
<p>This entire process is wrapped in the <code>runMDS</code> and <code>runNMDS</code>
functions.</p>
<div class="sourceCode" id="cb220"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb220-1"><a href="community-similarity.html#cb220-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(scater)</span>
<span id="cb220-2"><a href="community-similarity.html#cb220-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb220-3"><a href="community-similarity.html#cb220-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Bray-Curtis is usually applied to relative abundances</span></span>
<span id="cb220-4"><a href="community-similarity.html#cb220-4" aria-hidden="true" tabindex="-1"></a>tse <span class="ot">&lt;-</span> <span class="fu">transformSamples</span>(tse, <span class="at">method =</span> <span class="st">&quot;relabundance&quot;</span>)</span>
<span id="cb220-5"><a href="community-similarity.html#cb220-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Perform PCoA</span></span>
<span id="cb220-6"><a href="community-similarity.html#cb220-6" aria-hidden="true" tabindex="-1"></a>tse <span class="ot">&lt;-</span> <span class="fu">runMDS</span>(tse, <span class="at">FUN =</span> vegan<span class="sc">::</span>vegdist, <span class="at">method =</span> <span class="st">&quot;bray&quot;</span>, <span class="at">name =</span> <span class="st">&quot;PCoA_BC&quot;</span>, <span class="at">exprs_values =</span> <span class="st">&quot;relabundance&quot;</span>)</span></code></pre></div>
<p>Sample similarities can be visualized on a lower-dimensional display
(typically 2D) using the <code>plotReducedDim</code> function in the <code>scater</code>
package. This provides also further tools to incorporate additional
information using variations in color, shape or size. Are there
visible differences between the groups?</p>
<div class="sourceCode" id="cb221"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb221-1"><a href="community-similarity.html#cb221-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create ggplot object</span></span>
<span id="cb221-2"><a href="community-similarity.html#cb221-2" aria-hidden="true" tabindex="-1"></a>p <span class="ot">&lt;-</span> <span class="fu">plotReducedDim</span>(tse, <span class="st">&quot;PCoA_BC&quot;</span>, <span class="at">colour_by =</span> <span class="st">&quot;Group&quot;</span>)</span>
<span id="cb221-3"><a href="community-similarity.html#cb221-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb221-4"><a href="community-similarity.html#cb221-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Add explained variance for each axis</span></span>
<span id="cb221-5"><a href="community-similarity.html#cb221-5" aria-hidden="true" tabindex="-1"></a>e <span class="ot">&lt;-</span> <span class="fu">attr</span>(<span class="fu">reducedDim</span>(tse, <span class="st">&quot;PCoA_BC&quot;</span>), <span class="st">&quot;eig&quot;</span>);</span>
<span id="cb221-6"><a href="community-similarity.html#cb221-6" aria-hidden="true" tabindex="-1"></a>rel_eig <span class="ot">&lt;-</span> e<span class="sc">/</span><span class="fu">sum</span>(e[e<span class="sc">&gt;</span><span class="dv">0</span>])          </span>
<span id="cb221-7"><a href="community-similarity.html#cb221-7" aria-hidden="true" tabindex="-1"></a>p <span class="ot">&lt;-</span> p <span class="sc">+</span> <span class="fu">labs</span>(<span class="at">x =</span> <span class="fu">paste</span>(<span class="st">&quot;PCoA 1 (&quot;</span>, <span class="fu">round</span>(<span class="dv">100</span> <span class="sc">*</span> rel_eig[[<span class="dv">1</span>]],<span class="dv">1</span>), <span class="st">&quot;%&quot;</span>, <span class="st">&quot;)&quot;</span>, <span class="at">sep =</span> <span class="st">&quot;&quot;</span>),</span>
<span id="cb221-8"><a href="community-similarity.html#cb221-8" aria-hidden="true" tabindex="-1"></a>              <span class="at">y =</span> <span class="fu">paste</span>(<span class="st">&quot;PCoA 2 (&quot;</span>, <span class="fu">round</span>(<span class="dv">100</span> <span class="sc">*</span> rel_eig[[<span class="dv">2</span>]],<span class="dv">1</span>), <span class="st">&quot;%&quot;</span>, <span class="st">&quot;)&quot;</span>, <span class="at">sep =</span> <span class="st">&quot;&quot;</span>))</span>
<span id="cb221-9"><a href="community-similarity.html#cb221-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb221-10"><a href="community-similarity.html#cb221-10" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(p)</span></code></pre></div>
<div class="figure"><span style="display:block;" id="fig:plot-mds-bray-curtis"></span>
<img src="20_beta_diversity_files/figure-html/plot-mds-bray-curtis-1.png" alt="MDS plot based on the Bray-Curtis distances on the GlobalPattern dataset." width="3000" />
<p class="caption">
Figure 8.1: MDS plot based on the Bray-Curtis distances on the GlobalPattern dataset.
</p>
</div>
<p>With additional tools from the <code>ggplot2</code> universe, comparisons can be
performed informing on the applicability to visualize sample similarities in a
meaningful way.</p>
<div class="sourceCode" id="cb222"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb222-1"><a href="community-similarity.html#cb222-1" aria-hidden="true" tabindex="-1"></a>tse <span class="ot">&lt;-</span> <span class="fu">runMDS</span>(tse, <span class="at">FUN =</span> vegan<span class="sc">::</span>vegdist, <span class="at">name =</span> <span class="st">&quot;MDS_euclidean&quot;</span>,</span>
<span id="cb222-2"><a href="community-similarity.html#cb222-2" aria-hidden="true" tabindex="-1"></a>             <span class="at">method =</span> <span class="st">&quot;euclidean&quot;</span>, <span class="at">exprs_values =</span> <span class="st">&quot;counts&quot;</span>)</span>
<span id="cb222-3"><a href="community-similarity.html#cb222-3" aria-hidden="true" tabindex="-1"></a>tse <span class="ot">&lt;-</span> <span class="fu">runNMDS</span>(tse, <span class="at">FUN =</span> vegan<span class="sc">::</span>vegdist, <span class="at">name =</span> <span class="st">&quot;NMDS_BC&quot;</span>)</span></code></pre></div>
<pre><code>## initial  value 47.733208 
## iter   5 value 33.853364
## iter  10 value 32.891200
## final  value 32.823570 
## converged</code></pre>
<div class="sourceCode" id="cb224"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb224-1"><a href="community-similarity.html#cb224-1" aria-hidden="true" tabindex="-1"></a>tse <span class="ot">&lt;-</span> <span class="fu">runNMDS</span>(tse, <span class="at">FUN =</span> vegan<span class="sc">::</span>vegdist, <span class="at">name =</span> <span class="st">&quot;NMDS_euclidean&quot;</span>,</span>
<span id="cb224-2"><a href="community-similarity.html#cb224-2" aria-hidden="true" tabindex="-1"></a>               <span class="at">method =</span> <span class="st">&quot;euclidean&quot;</span>)</span></code></pre></div>
<pre><code>## initial  value 31.882673 
## final  value 31.882673 
## converged</code></pre>
<div class="sourceCode" id="cb226"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb226-1"><a href="community-similarity.html#cb226-1" aria-hidden="true" tabindex="-1"></a>plots <span class="ot">&lt;-</span> <span class="fu">lapply</span>(<span class="fu">c</span>(<span class="st">&quot;PCoA_BC&quot;</span>, <span class="st">&quot;MDS_euclidean&quot;</span>, <span class="st">&quot;NMDS_BC&quot;</span>, <span class="st">&quot;NMDS_euclidean&quot;</span>),</span>
<span id="cb226-2"><a href="community-similarity.html#cb226-2" aria-hidden="true" tabindex="-1"></a>                plotReducedDim,</span>
<span id="cb226-3"><a href="community-similarity.html#cb226-3" aria-hidden="true" tabindex="-1"></a>                <span class="at">object =</span> tse,</span>
<span id="cb226-4"><a href="community-similarity.html#cb226-4" aria-hidden="true" tabindex="-1"></a>                <span class="at">colour_by =</span> <span class="st">&quot;Group&quot;</span>)</span>
<span id="cb226-5"><a href="community-similarity.html#cb226-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb226-6"><a href="community-similarity.html#cb226-6" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(patchwork)</span>
<span id="cb226-7"><a href="community-similarity.html#cb226-7" aria-hidden="true" tabindex="-1"></a>plots[[<span class="dv">1</span>]] <span class="sc">+</span> plots[[<span class="dv">2</span>]] <span class="sc">+</span> plots[[<span class="dv">3</span>]] <span class="sc">+</span> plots[[<span class="dv">4</span>]] <span class="sc">+</span></span>
<span id="cb226-8"><a href="community-similarity.html#cb226-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">plot_layout</span>(<span class="at">guides =</span> <span class="st">&quot;collect&quot;</span>)</span></code></pre></div>
<div class="figure"><span style="display:block;" id="fig:plot-mds-nmds-comparison"></span>
<img src="20_beta_diversity_files/figure-html/plot-mds-nmds-comparison-1.png" alt="Comparison of MDS and NMDS plots based on the Bray-Curtis or euclidean distances on the GlobalPattern dataset." width="3000" />
<p class="caption">
Figure 8.2: Comparison of MDS and NMDS plots based on the Bray-Curtis or euclidean distances on the GlobalPattern dataset.
</p>
</div>
<p>The <em>Unifrac</em> method is a special case, as it requires data on the
relationship of features in form on a <code>phylo</code> tree. <code>calculateUnifrac</code>
performs the calculation to return a <code>dist</code> object, which can again be
used within <code>runMDS</code>.</p>
<div class="sourceCode" id="cb227"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb227-1"><a href="community-similarity.html#cb227-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(scater)</span>
<span id="cb227-2"><a href="community-similarity.html#cb227-2" aria-hidden="true" tabindex="-1"></a>tse <span class="ot">&lt;-</span> <span class="fu">runMDS</span>(tse, <span class="at">FUN =</span> mia<span class="sc">::</span>calculateUnifrac, <span class="at">name =</span> <span class="st">&quot;Unifrac&quot;</span>,</span>
<span id="cb227-3"><a href="community-similarity.html#cb227-3" aria-hidden="true" tabindex="-1"></a>              <span class="at">tree =</span> <span class="fu">rowTree</span>(tse),</span>
<span id="cb227-4"><a href="community-similarity.html#cb227-4" aria-hidden="true" tabindex="-1"></a>              <span class="at">ntop =</span> <span class="fu">nrow</span>(tse),</span>
<span id="cb227-5"><a href="community-similarity.html#cb227-5" aria-hidden="true" tabindex="-1"></a>             <span class="at">exprs_values =</span> <span class="st">&quot;counts&quot;</span>)</span></code></pre></div>
<div class="sourceCode" id="cb228"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb228-1"><a href="community-similarity.html#cb228-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plotReducedDim</span>(tse, <span class="st">&quot;Unifrac&quot;</span>, <span class="at">colour_by =</span> <span class="st">&quot;Group&quot;</span>)</span></code></pre></div>
<div class="figure"><span style="display:block;" id="fig:plot-unifrac"></span>
<img src="20_beta_diversity_files/figure-html/plot-unifrac-1.png" alt="Unifrac distances scaled by MDS of the GlobalPattern dataset." width="3000" />
<p class="caption">
Figure 8.3: Unifrac distances scaled by MDS of the GlobalPattern dataset.
</p>
</div>
</div>
<div id="other-ordination-methods" class="section level2 hasAnchor" number="8.3">
<h2><span class="header-section-number">8.3</span> Other ordination methods<a href="community-similarity.html#other-ordination-methods" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>Other dimension reduction methods, such as <code>PCA</code>, <code>t-SNE</code> and <code>UMAP</code> are
inherited directly from the <code>scater</code> package.</p>
<div class="sourceCode" id="cb229"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb229-1"><a href="community-similarity.html#cb229-1" aria-hidden="true" tabindex="-1"></a>tse <span class="ot">&lt;-</span> <span class="fu">runPCA</span>(tse, <span class="at">name =</span> <span class="st">&quot;PCA&quot;</span>, <span class="at">exprs_values =</span> <span class="st">&quot;counts&quot;</span>, <span class="at">ncomponents =</span> <span class="dv">10</span>)</span></code></pre></div>
<div class="sourceCode" id="cb230"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb230-1"><a href="community-similarity.html#cb230-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plotReducedDim</span>(tse, <span class="st">&quot;PCA&quot;</span>, <span class="at">colour_by =</span> <span class="st">&quot;Group&quot;</span>)</span></code></pre></div>
<div class="figure"><span style="display:block;" id="fig:plot-pca"></span>
<img src="20_beta_diversity_files/figure-html/plot-pca-1.png" alt="PCA plot on the GlobalPatterns data set containing sample from different sources." width="3000" />
<p class="caption">
Figure 8.4: PCA plot on the GlobalPatterns data set containing sample from different sources.
</p>
</div>
<p>As mentioned before, applicability of the different methods depends on your
sample set.</p>
<p>FIXME: let us switch to UMAP for the examples?</p>
<div class="sourceCode" id="cb231"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb231-1"><a href="community-similarity.html#cb231-1" aria-hidden="true" tabindex="-1"></a>tse <span class="ot">&lt;-</span> <span class="fu">runTSNE</span>(tse, <span class="at">name =</span> <span class="st">&quot;TSNE&quot;</span>, <span class="at">exprs_values =</span> <span class="st">&quot;counts&quot;</span>, <span class="at">ncomponents =</span> <span class="dv">3</span>)</span></code></pre></div>
<div class="sourceCode" id="cb232"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb232-1"><a href="community-similarity.html#cb232-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plotReducedDim</span>(tse, <span class="st">&quot;TSNE&quot;</span>, <span class="at">colour_by =</span> <span class="st">&quot;Group&quot;</span>, <span class="at">ncomponents =</span> <span class="fu">c</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>))</span></code></pre></div>
<div class="figure"><span style="display:block;" id="fig:plot-tsne"></span>
<img src="20_beta_diversity_files/figure-html/plot-tsne-1.png" alt="t-SNE plot on the GlobalPatterns data set containing sample from different sources." width="3000" />
<p class="caption">
Figure 8.5: t-SNE plot on the GlobalPatterns data set containing sample from different sources.
</p>
</div>
<p>As a final note, <code>mia</code> provides functions for the evaluation of additional dissimilarity indices, such as:
* <code>calculateJSD</code>, <code>runJSD</code> (Jensen-Shannon divergence)
* <code>calculateNMDS</code>, <code>plotNMDS</code> (non-metric multi-dimensional scaling)
* <code>calculateCCA</code>, <code>runCCA</code> (Canonical Correspondence Analysis)
* <code>calculateRDA</code>, <code>runRDA</code> (Redundancy Analysis)
* <code>calculateOverlap</code>, <code>runOverlap</code> ()
* <code>calculateDPCoA</code>, <code>runDPCoA</code> (Double Principal Coordinate Analysis)</p>
<p>Redundancy analysis is similar to PCA, however, it takes into account covariates.
It aims to maximize the variance in respect of covariates. The results shows how much
each covariate affects.</p>
<div class="sourceCode" id="cb233"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb233-1"><a href="community-similarity.html#cb233-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Load required packages</span></span>
<span id="cb233-2"><a href="community-similarity.html#cb233-2" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(<span class="sc">!</span><span class="fu">require</span>(<span class="st">&quot;vegan&quot;</span>)){</span>
<span id="cb233-3"><a href="community-similarity.html#cb233-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">install.packages</span>(<span class="st">&quot;vegan&quot;</span>)</span>
<span id="cb233-4"><a href="community-similarity.html#cb233-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">library</span>(<span class="st">&quot;vegan&quot;</span>)</span>
<span id="cb233-5"><a href="community-similarity.html#cb233-5" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb233-6"><a href="community-similarity.html#cb233-6" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(<span class="sc">!</span><span class="fu">require</span>(<span class="st">&quot;stringr&quot;</span>)){</span>
<span id="cb233-7"><a href="community-similarity.html#cb233-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">install.packages</span>(<span class="st">&quot;stringr&quot;</span>)</span>
<span id="cb233-8"><a href="community-similarity.html#cb233-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">library</span>(<span class="st">&quot;stringr&quot;</span>)</span>
<span id="cb233-9"><a href="community-similarity.html#cb233-9" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb233-10"><a href="community-similarity.html#cb233-10" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(<span class="sc">!</span><span class="fu">require</span>(<span class="st">&quot;knitr&quot;</span>)){</span>
<span id="cb233-11"><a href="community-similarity.html#cb233-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">install.packages</span>(<span class="st">&quot;knitr&quot;</span>)</span>
<span id="cb233-12"><a href="community-similarity.html#cb233-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">library</span>(<span class="st">&quot;knitr&quot;</span>)</span>
<span id="cb233-13"><a href="community-similarity.html#cb233-13" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb233-14"><a href="community-similarity.html#cb233-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Load data</span></span>
<span id="cb233-15"><a href="community-similarity.html#cb233-15" aria-hidden="true" tabindex="-1"></a><span class="fu">data</span>(enterotype)</span>
<span id="cb233-16"><a href="community-similarity.html#cb233-16" aria-hidden="true" tabindex="-1"></a><span class="co"># Covariates that are being analyzed</span></span>
<span id="cb233-17"><a href="community-similarity.html#cb233-17" aria-hidden="true" tabindex="-1"></a>variable_names <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;ClinicalStatus&quot;</span>, <span class="st">&quot;Gender&quot;</span>, <span class="st">&quot;Age&quot;</span>)</span>
<span id="cb233-18"><a href="community-similarity.html#cb233-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb233-19"><a href="community-similarity.html#cb233-19" aria-hidden="true" tabindex="-1"></a><span class="co"># Apply relative transform</span></span>
<span id="cb233-20"><a href="community-similarity.html#cb233-20" aria-hidden="true" tabindex="-1"></a>enterotype <span class="ot">&lt;-</span> <span class="fu">transformSamples</span>(enterotype, <span class="at">method =</span> <span class="st">&quot;relabundance&quot;</span>)</span>
<span id="cb233-21"><a href="community-similarity.html#cb233-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb233-22"><a href="community-similarity.html#cb233-22" aria-hidden="true" tabindex="-1"></a><span class="co"># Get assay</span></span>
<span id="cb233-23"><a href="community-similarity.html#cb233-23" aria-hidden="true" tabindex="-1"></a>assay <span class="ot">&lt;-</span> <span class="fu">t</span>(<span class="fu">assay</span>(enterotype, <span class="st">&quot;relabundance&quot;</span>))</span>
<span id="cb233-24"><a href="community-similarity.html#cb233-24" aria-hidden="true" tabindex="-1"></a><span class="co"># Get colData</span></span>
<span id="cb233-25"><a href="community-similarity.html#cb233-25" aria-hidden="true" tabindex="-1"></a>coldata <span class="ot">&lt;-</span> <span class="fu">colData</span>(enterotype)</span>
<span id="cb233-26"><a href="community-similarity.html#cb233-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb233-27"><a href="community-similarity.html#cb233-27" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a formula</span></span>
<span id="cb233-28"><a href="community-similarity.html#cb233-28" aria-hidden="true" tabindex="-1"></a>formula <span class="ot">&lt;-</span> <span class="fu">as.formula</span>(<span class="fu">paste0</span>(<span class="st">&quot;assay ~ &quot;</span>, <span class="fu">str_c</span>(variable_names, <span class="at">collapse =</span> <span class="st">&quot; + &quot;</span>)) )</span>
<span id="cb233-29"><a href="community-similarity.html#cb233-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb233-30"><a href="community-similarity.html#cb233-30" aria-hidden="true" tabindex="-1"></a><span class="co"># # Perform RDA</span></span>
<span id="cb233-31"><a href="community-similarity.html#cb233-31" aria-hidden="true" tabindex="-1"></a>rda <span class="ot">&lt;-</span> <span class="fu">rda</span>(formula, <span class="at">data =</span> coldata, <span class="at">scale =</span> <span class="cn">TRUE</span>, <span class="at">na.action =</span> na.exclude)</span>
<span id="cb233-32"><a href="community-similarity.html#cb233-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb233-33"><a href="community-similarity.html#cb233-33" aria-hidden="true" tabindex="-1"></a><span class="co"># Initialize list for p-values</span></span>
<span id="cb233-34"><a href="community-similarity.html#cb233-34" aria-hidden="true" tabindex="-1"></a>rda_info <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb233-35"><a href="community-similarity.html#cb233-35" aria-hidden="true" tabindex="-1"></a><span class="co"># Name for storing the result</span></span>
<span id="cb233-36"><a href="community-similarity.html#cb233-36" aria-hidden="true" tabindex="-1"></a>variable_name <span class="ot">&lt;-</span> <span class="st">&quot;all&quot;</span></span>
<span id="cb233-37"><a href="community-similarity.html#cb233-37" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate and store p-value, and other information</span></span>
<span id="cb233-38"><a href="community-similarity.html#cb233-38" aria-hidden="true" tabindex="-1"></a>rda_info[[variable_name]] <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="at">constrained =</span> rda<span class="sc">$</span>CCA<span class="sc">$</span>tot.chi, </span>
<span id="cb233-39"><a href="community-similarity.html#cb233-39" aria-hidden="true" tabindex="-1"></a>                               <span class="at">unconstrainded =</span> rda<span class="sc">$</span>CA<span class="sc">$</span>tot.chi, </span>
<span id="cb233-40"><a href="community-similarity.html#cb233-40" aria-hidden="true" tabindex="-1"></a>                               <span class="at">proportion =</span> rda<span class="sc">$</span>CCA<span class="sc">$</span>tot.chi<span class="sc">/</span>rda<span class="sc">$</span>CA<span class="sc">$</span>tot.chi, </span>
<span id="cb233-41"><a href="community-similarity.html#cb233-41" aria-hidden="true" tabindex="-1"></a>                               <span class="at">p_value =</span> <span class="fu">anova.cca</span>(rda)[<span class="st">&quot;Model&quot;</span>, <span class="st">&quot;Pr(&gt;F)&quot;</span>] )</span>
<span id="cb233-42"><a href="community-similarity.html#cb233-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb233-43"><a href="community-similarity.html#cb233-43" aria-hidden="true" tabindex="-1"></a><span class="co"># Loop through variables</span></span>
<span id="cb233-44"><a href="community-similarity.html#cb233-44" aria-hidden="true" tabindex="-1"></a>permutations <span class="ot">&lt;-</span> <span class="dv">999</span></span>
<span id="cb233-45"><a href="community-similarity.html#cb233-45" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>( variable_name <span class="cf">in</span> variable_names ){</span>
<span id="cb233-46"><a href="community-similarity.html#cb233-46" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create a formula</span></span>
<span id="cb233-47"><a href="community-similarity.html#cb233-47" aria-hidden="true" tabindex="-1"></a>    formula <span class="ot">&lt;-</span> <span class="fu">as.formula</span>(<span class="fu">paste0</span>(<span class="st">&quot;assay ~ &quot;</span>, variable_name) )</span>
<span id="cb233-48"><a href="community-similarity.html#cb233-48" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Perform RDA</span></span>
<span id="cb233-49"><a href="community-similarity.html#cb233-49" aria-hidden="true" tabindex="-1"></a>    rda_temp <span class="ot">&lt;-</span> <span class="fu">rda</span>(formula, <span class="at">data =</span> coldata, <span class="at">scale =</span> <span class="cn">TRUE</span>, <span class="at">na.action =</span> na.exclude)</span>
<span id="cb233-50"><a href="community-similarity.html#cb233-50" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Add Info to list</span></span>
<span id="cb233-51"><a href="community-similarity.html#cb233-51" aria-hidden="true" tabindex="-1"></a>    rda_info[[variable_name]] <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="at">constrained =</span> rda_temp<span class="sc">$</span>CCA<span class="sc">$</span>tot.chi, </span>
<span id="cb233-52"><a href="community-similarity.html#cb233-52" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">unconstrainded =</span> rda_temp<span class="sc">$</span>CA<span class="sc">$</span>tot.chi, </span>
<span id="cb233-53"><a href="community-similarity.html#cb233-53" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">proportion =</span> rda_temp<span class="sc">$</span>CCA<span class="sc">$</span>tot.chi<span class="sc">/</span>rda<span class="sc">$</span>CA<span class="sc">$</span>tot.chi, </span>
<span id="cb233-54"><a href="community-similarity.html#cb233-54" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">p_value =</span> <span class="fu">anova.cca</span>(rda_temp, <span class="at">permutations =</span> permutations</span>
<span id="cb233-55"><a href="community-similarity.html#cb233-55" aria-hidden="true" tabindex="-1"></a>                                                       )[<span class="st">&quot;Model&quot;</span>, <span class="st">&quot;Pr(&gt;F)&quot;</span>] )</span>
<span id="cb233-56"><a href="community-similarity.html#cb233-56" aria-hidden="true" tabindex="-1"></a>}  </span>
<span id="cb233-57"><a href="community-similarity.html#cb233-57" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert into data.frame</span></span>
<span id="cb233-58"><a href="community-similarity.html#cb233-58" aria-hidden="true" tabindex="-1"></a>rda_info <span class="ot">&lt;-</span> <span class="fu">t</span>(<span class="fu">as.data.frame</span>(rda_info))</span>
<span id="cb233-59"><a href="community-similarity.html#cb233-59" aria-hidden="true" tabindex="-1"></a>rda_info_clean <span class="ot">&lt;-</span> rda_info</span>
<span id="cb233-60"><a href="community-similarity.html#cb233-60" aria-hidden="true" tabindex="-1"></a><span class="co"># Adjust names</span></span>
<span id="cb233-61"><a href="community-similarity.html#cb233-61" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(rda_info_clean) <span class="ot">&lt;-</span> </span>
<span id="cb233-62"><a href="community-similarity.html#cb233-62" aria-hidden="true" tabindex="-1"></a>    <span class="fu">c</span>(<span class="st">&quot;Explained by variables&quot;</span>, <span class="st">&quot;Unexplained by variables&quot;</span>, <span class="st">&quot;Proportion expl by vars&quot;</span>, </span>
<span id="cb233-63"><a href="community-similarity.html#cb233-63" aria-hidden="true" tabindex="-1"></a>      <span class="fu">paste0</span>(<span class="st">&quot;P-value (PERMANOVA &quot;</span>, permutations, <span class="st">&quot; permutations)&quot;</span>) )</span>
<span id="cb233-64"><a href="community-similarity.html#cb233-64" aria-hidden="true" tabindex="-1"></a><span class="co"># Print info</span></span>
<span id="cb233-65"><a href="community-similarity.html#cb233-65" aria-hidden="true" tabindex="-1"></a><span class="fu">kable</span>(rda_info_clean)</span></code></pre></div>
<table>
<colgroup>
<col width="12%" />
<col width="18%" />
<col width="20%" />
<col width="19%" />
<col width="29%" />
</colgroup>
<thead>
<tr class="header">
<th align="left"></th>
<th align="right">Explained by variables</th>
<th align="right">Unexplained by variables</th>
<th align="right">Proportion expl by vars</th>
<th align="right">P-value (PERMANOVA 999 permutations)</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">all</td>
<td align="right">35.30</td>
<td align="right">191.7</td>
<td align="right">0.1842</td>
<td align="right">0.650</td>
</tr>
<tr class="even">
<td align="left">ClinicalStatus</td>
<td align="right">19.08</td>
<td align="right">209.9</td>
<td align="right">0.0996</td>
<td align="right">0.828</td>
</tr>
<tr class="odd">
<td align="left">Gender</td>
<td align="right">5.31</td>
<td align="right">223.7</td>
<td align="right">0.0277</td>
<td align="right">0.923</td>
</tr>
<tr class="even">
<td align="left">Age</td>
<td align="right">10.59</td>
<td align="right">216.4</td>
<td align="right">0.0552</td>
<td align="right">0.001</td>
</tr>
</tbody>
</table>
<div class="sourceCode" id="cb234"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb234-1"><a href="community-similarity.html#cb234-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Load ggord for plotting</span></span>
<span id="cb234-2"><a href="community-similarity.html#cb234-2" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(<span class="sc">!</span><span class="fu">require</span>(<span class="st">&quot;ggord&quot;</span>)){</span>
<span id="cb234-3"><a href="community-similarity.html#cb234-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(<span class="sc">!</span><span class="fu">require</span>(<span class="st">&quot;devtools&quot;</span>)){</span>
<span id="cb234-4"><a href="community-similarity.html#cb234-4" aria-hidden="true" tabindex="-1"></a>        <span class="fu">install.packages</span>(<span class="st">&quot;devtools&quot;</span>)</span>
<span id="cb234-5"><a href="community-similarity.html#cb234-5" aria-hidden="true" tabindex="-1"></a>        <span class="fu">library</span>(<span class="st">&quot;devtools&quot;</span>)</span>
<span id="cb234-6"><a href="community-similarity.html#cb234-6" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb234-7"><a href="community-similarity.html#cb234-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">install_github</span>(<span class="st">&quot;https://github.com/fawda123/ggord/&quot;</span>)</span>
<span id="cb234-8"><a href="community-similarity.html#cb234-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">library</span>(<span class="st">&quot;ggord&quot;</span>)</span>
<span id="cb234-9"><a href="community-similarity.html#cb234-9" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb234-10"><a href="community-similarity.html#cb234-10" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(<span class="sc">!</span><span class="fu">require</span>(<span class="st">&quot;ggplot2&quot;</span>)){</span>
<span id="cb234-11"><a href="community-similarity.html#cb234-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">install.packages</span>(<span class="st">&quot;ggplot2&quot;</span>)</span>
<span id="cb234-12"><a href="community-similarity.html#cb234-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">library</span>(<span class="st">&quot;ggplot2&quot;</span>)</span>
<span id="cb234-13"><a href="community-similarity.html#cb234-13" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb234-14"><a href="community-similarity.html#cb234-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Since na.exclude was used, if there were rows missing information, they were </span></span>
<span id="cb234-15"><a href="community-similarity.html#cb234-15" aria-hidden="true" tabindex="-1"></a><span class="co"># dropped off. Subset coldata so that it matches with rda.</span></span>
<span id="cb234-16"><a href="community-similarity.html#cb234-16" aria-hidden="true" tabindex="-1"></a>coldata <span class="ot">&lt;-</span> coldata[ <span class="fu">rownames</span>(rda<span class="sc">$</span>CCA<span class="sc">$</span>wa), ]</span>
<span id="cb234-17"><a href="community-similarity.html#cb234-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb234-18"><a href="community-similarity.html#cb234-18" aria-hidden="true" tabindex="-1"></a><span class="co"># Adjust names</span></span>
<span id="cb234-19"><a href="community-similarity.html#cb234-19" aria-hidden="true" tabindex="-1"></a><span class="co"># Get labels of vectors</span></span>
<span id="cb234-20"><a href="community-similarity.html#cb234-20" aria-hidden="true" tabindex="-1"></a>vec_lab_old <span class="ot">&lt;-</span> <span class="fu">rownames</span>(rda<span class="sc">$</span>CCA<span class="sc">$</span>biplot)</span>
<span id="cb234-21"><a href="community-similarity.html#cb234-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb234-22"><a href="community-similarity.html#cb234-22" aria-hidden="true" tabindex="-1"></a><span class="co"># Loop through vector labels</span></span>
<span id="cb234-23"><a href="community-similarity.html#cb234-23" aria-hidden="true" tabindex="-1"></a>vec_lab <span class="ot">&lt;-</span> <span class="fu">sapply</span>(vec_lab_old, <span class="at">FUN =</span> <span class="cf">function</span>(name){</span>
<span id="cb234-24"><a href="community-similarity.html#cb234-24" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Get the variable name</span></span>
<span id="cb234-25"><a href="community-similarity.html#cb234-25" aria-hidden="true" tabindex="-1"></a>    variable_name <span class="ot">&lt;-</span> variable_names[ <span class="fu">str_detect</span>(name, variable_names) ]</span>
<span id="cb234-26"><a href="community-similarity.html#cb234-26" aria-hidden="true" tabindex="-1"></a>    <span class="co"># If the vector label includes also group name</span></span>
<span id="cb234-27"><a href="community-similarity.html#cb234-27" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>( <span class="sc">!</span><span class="fu">any</span>(name <span class="sc">%in%</span> variable_names) ){</span>
<span id="cb234-28"><a href="community-similarity.html#cb234-28" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Get the group names</span></span>
<span id="cb234-29"><a href="community-similarity.html#cb234-29" aria-hidden="true" tabindex="-1"></a>        group_name <span class="ot">&lt;-</span> <span class="fu">unique</span>( coldata[[variable_name]] )[ </span>
<span id="cb234-30"><a href="community-similarity.html#cb234-30" aria-hidden="true" tabindex="-1"></a>        <span class="fu">which</span>( <span class="fu">paste0</span>(variable_name, <span class="fu">unique</span>( coldata[[variable_name]] )) <span class="sc">==</span> name ) ]</span>
<span id="cb234-31"><a href="community-similarity.html#cb234-31" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Modify vector so that group is separated from variable name</span></span>
<span id="cb234-32"><a href="community-similarity.html#cb234-32" aria-hidden="true" tabindex="-1"></a>        new_name <span class="ot">&lt;-</span> <span class="fu">paste0</span>(variable_name, <span class="st">&quot; \U2012 &quot;</span>, group_name)</span>
<span id="cb234-33"><a href="community-similarity.html#cb234-33" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span>{</span>
<span id="cb234-34"><a href="community-similarity.html#cb234-34" aria-hidden="true" tabindex="-1"></a>        new_name <span class="ot">&lt;-</span> name</span>
<span id="cb234-35"><a href="community-similarity.html#cb234-35" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb234-36"><a href="community-similarity.html#cb234-36" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Add percentage how much this variable explains, and p-value</span></span>
<span id="cb234-37"><a href="community-similarity.html#cb234-37" aria-hidden="true" tabindex="-1"></a>    new_name <span class="ot">&lt;-</span> <span class="fu">expr</span>(<span class="fu">paste</span>(<span class="sc">!!</span>new_name, <span class="st">&quot; (&quot;</span>, </span>
<span id="cb234-38"><a href="community-similarity.html#cb234-38" aria-hidden="true" tabindex="-1"></a>                           <span class="sc">!!</span><span class="fu">format</span>(<span class="fu">round</span>( rda_info[variable_name, <span class="st">&quot;proportion&quot;</span>]<span class="sc">*</span><span class="dv">100</span>, <span class="dv">1</span>), <span class="at">nsmall =</span> <span class="dv">1</span>), </span>
<span id="cb234-39"><a href="community-similarity.html#cb234-39" aria-hidden="true" tabindex="-1"></a>                           <span class="st">&quot;%, &quot;</span>,<span class="fu">italic</span>(<span class="st">&quot;P&quot;</span>), <span class="st">&quot; = &quot;</span>, </span>
<span id="cb234-40"><a href="community-similarity.html#cb234-40" aria-hidden="true" tabindex="-1"></a>                           <span class="sc">!!</span><span class="fu">gsub</span>(<span class="st">&quot;0</span><span class="sc">\\</span><span class="st">.&quot;</span>,<span class="st">&quot;</span><span class="sc">\\</span><span class="st">.&quot;</span>, <span class="fu">format</span>(<span class="fu">round</span>( rda_info[variable_name, <span class="st">&quot;p_value&quot;</span>], <span class="dv">3</span>), </span>
<span id="cb234-41"><a href="community-similarity.html#cb234-41" aria-hidden="true" tabindex="-1"></a>                                                       <span class="at">nsmall =</span> <span class="dv">3</span>)), <span class="st">&quot;)&quot;</span>))</span>
<span id="cb234-42"><a href="community-similarity.html#cb234-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb234-43"><a href="community-similarity.html#cb234-43" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(new_name)</span>
<span id="cb234-44"><a href="community-similarity.html#cb234-44" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb234-45"><a href="community-similarity.html#cb234-45" aria-hidden="true" tabindex="-1"></a><span class="co"># Add names</span></span>
<span id="cb234-46"><a href="community-similarity.html#cb234-46" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(vec_lab) <span class="ot">&lt;-</span> vec_lab_old</span>
<span id="cb234-47"><a href="community-similarity.html#cb234-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb234-48"><a href="community-similarity.html#cb234-48" aria-hidden="true" tabindex="-1"></a><span class="co"># Create labels for axis</span></span>
<span id="cb234-49"><a href="community-similarity.html#cb234-49" aria-hidden="true" tabindex="-1"></a>xlab <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">&quot;RDA1 (&quot;</span>, <span class="fu">format</span>(<span class="fu">round</span>( rda<span class="sc">$</span>CCA<span class="sc">$</span>eig[[<span class="dv">1</span>]]<span class="sc">/</span>rda<span class="sc">$</span>CCA<span class="sc">$</span>tot.chi<span class="sc">*</span><span class="dv">100</span>, <span class="dv">1</span>), <span class="at">nsmall =</span> <span class="dv">1</span> ), <span class="st">&quot;%)&quot;</span>)</span>
<span id="cb234-50"><a href="community-similarity.html#cb234-50" aria-hidden="true" tabindex="-1"></a>ylab <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">&quot;RDA2 (&quot;</span>, <span class="fu">format</span>(<span class="fu">round</span>( rda<span class="sc">$</span>CCA<span class="sc">$</span>eig[[<span class="dv">2</span>]]<span class="sc">/</span>rda<span class="sc">$</span>CCA<span class="sc">$</span>tot.chi<span class="sc">*</span><span class="dv">100</span>, <span class="dv">1</span>), <span class="at">nsmall =</span> <span class="dv">1</span> ), <span class="st">&quot;%)&quot;</span>)</span>
<span id="cb234-51"><a href="community-similarity.html#cb234-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb234-52"><a href="community-similarity.html#cb234-52" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a plot        </span></span>
<span id="cb234-53"><a href="community-similarity.html#cb234-53" aria-hidden="true" tabindex="-1"></a>plot <span class="ot">&lt;-</span> <span class="fu">ggord</span>(rda, <span class="at">grp_in =</span> coldata[[<span class="st">&quot;ClinicalStatus&quot;</span>]], <span class="at">vec_lab =</span> vec_lab,</span>
<span id="cb234-54"><a href="community-similarity.html#cb234-54" aria-hidden="true" tabindex="-1"></a>              <span class="at">alpha =</span> <span class="fl">0.5</span>,</span>
<span id="cb234-55"><a href="community-similarity.html#cb234-55" aria-hidden="true" tabindex="-1"></a>              <span class="at">size =</span> <span class="dv">4</span>, <span class="at">addsize =</span> <span class="sc">-</span><span class="dv">4</span>,</span>
<span id="cb234-56"><a href="community-similarity.html#cb234-56" aria-hidden="true" tabindex="-1"></a>              <span class="co">#ext= 0.7, </span></span>
<span id="cb234-57"><a href="community-similarity.html#cb234-57" aria-hidden="true" tabindex="-1"></a>              <span class="at">txt =</span> <span class="fl">3.5</span>, <span class="at">repel =</span> <span class="cn">TRUE</span>, </span>
<span id="cb234-58"><a href="community-similarity.html#cb234-58" aria-hidden="true" tabindex="-1"></a>              <span class="co">#coord_fix = FALSE</span></span>
<span id="cb234-59"><a href="community-similarity.html#cb234-59" aria-hidden="true" tabindex="-1"></a>          ) <span class="sc">+</span> </span>
<span id="cb234-60"><a href="community-similarity.html#cb234-60" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Adjust titles and labels</span></span>
<span id="cb234-61"><a href="community-similarity.html#cb234-61" aria-hidden="true" tabindex="-1"></a>    <span class="fu">guides</span>(<span class="at">colour =</span> <span class="fu">guide_legend</span>(<span class="st">&quot;ClinicalStatus&quot;</span>),</span>
<span id="cb234-62"><a href="community-similarity.html#cb234-62" aria-hidden="true" tabindex="-1"></a>           <span class="at">fill =</span> <span class="fu">guide_legend</span>(<span class="st">&quot;ClinicalStatus&quot;</span>),</span>
<span id="cb234-63"><a href="community-similarity.html#cb234-63" aria-hidden="true" tabindex="-1"></a>           <span class="at">group =</span> <span class="fu">guide_legend</span>(<span class="st">&quot;ClinicalStatus&quot;</span>),</span>
<span id="cb234-64"><a href="community-similarity.html#cb234-64" aria-hidden="true" tabindex="-1"></a>           <span class="at">shape =</span> <span class="fu">guide_legend</span>(<span class="st">&quot;ClinicalStatus&quot;</span>),</span>
<span id="cb234-65"><a href="community-similarity.html#cb234-65" aria-hidden="true" tabindex="-1"></a>           <span class="at">x =</span> <span class="fu">guide_axis</span>(xlab),</span>
<span id="cb234-66"><a href="community-similarity.html#cb234-66" aria-hidden="true" tabindex="-1"></a>           <span class="at">y =</span> <span class="fu">guide_axis</span>(ylab)) <span class="sc">+</span></span>
<span id="cb234-67"><a href="community-similarity.html#cb234-67" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>( <span class="at">axis.title =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">10</span>) )</span>
<span id="cb234-68"><a href="community-similarity.html#cb234-68" aria-hidden="true" tabindex="-1"></a>plot</span></code></pre></div>
<p><img src="20_beta_diversity_files/figure-html/microbiome_RDA2-1.png" width="3000" /></p>
<p>From RDA plot, we can see that only age has significant affect on microbial profile.</p>
</div>
<div id="visualizing-the-most-dominant-genus-on-pcoa" class="section level2 hasAnchor" number="8.4">
<h2><span class="header-section-number">8.4</span> Visualizing the most dominant genus on PCoA<a href="community-similarity.html#visualizing-the-most-dominant-genus-on-pcoa" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>In this section we visualize most dominant genus on PCoA. A similar visualization was proposed in <a href="https://www.nature.com/articles/s41467-021-22962-y">Taxonomic signatures of cause-specific mortality risk in human gut microbiome</a>, Salosensaari et al. (2021).</p>
<p>Let us agglomerate the data at a Genus level and getting the dominant taxa per sample.</p>
<div class="sourceCode" id="cb235"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb235-1"><a href="community-similarity.html#cb235-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Agglomerate to genus level</span></span>
<span id="cb235-2"><a href="community-similarity.html#cb235-2" aria-hidden="true" tabindex="-1"></a>tse_Genus <span class="ot">&lt;-</span> <span class="fu">agglomerateByRank</span>(tse, <span class="at">rank=</span><span class="st">&quot;Genus&quot;</span>)</span>
<span id="cb235-3"><a href="community-similarity.html#cb235-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert to relative abundances</span></span>
<span id="cb235-4"><a href="community-similarity.html#cb235-4" aria-hidden="true" tabindex="-1"></a>tse_Genus <span class="ot">&lt;-</span> <span class="fu">transformSamples</span>(tse, <span class="at">method =</span> <span class="st">&quot;relabundance&quot;</span>, <span class="at">assay_name=</span><span class="st">&quot;counts&quot;</span>)</span>
<span id="cb235-5"><a href="community-similarity.html#cb235-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Add info on dominant genus per sample</span></span>
<span id="cb235-6"><a href="community-similarity.html#cb235-6" aria-hidden="true" tabindex="-1"></a>tse_Genus <span class="ot">&lt;-</span> <span class="fu">addPerSampleDominantTaxa</span>(tse_Genus, <span class="at">assay_name=</span><span class="st">&quot;relabundance&quot;</span>, <span class="at">name =</span> <span class="st">&quot;dominant_taxa&quot;</span>)</span></code></pre></div>
<p>Performing PCoA with Bray-Curtis dissimilarity.</p>
<div class="sourceCode" id="cb236"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb236-1"><a href="community-similarity.html#cb236-1" aria-hidden="true" tabindex="-1"></a>tse_Genus <span class="ot">&lt;-</span> <span class="fu">runMDS</span>(tse_Genus, <span class="at">FUN =</span> vegan<span class="sc">::</span>vegdist,</span>
<span id="cb236-2"><a href="community-similarity.html#cb236-2" aria-hidden="true" tabindex="-1"></a>              <span class="at">name =</span> <span class="st">&quot;PCoA_BC&quot;</span>, <span class="at">exprs_values =</span> <span class="st">&quot;relabundance&quot;</span>)</span></code></pre></div>
<p>Getting top taxa and visualizing the abundance on PCoA.</p>
<div class="sourceCode" id="cb237"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb237-1"><a href="community-similarity.html#cb237-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Getting the top taxa</span></span>
<span id="cb237-2"><a href="community-similarity.html#cb237-2" aria-hidden="true" tabindex="-1"></a>top_taxa <span class="ot">&lt;-</span> <span class="fu">getTopTaxa</span>(tse_Genus,<span class="at">top =</span> <span class="dv">6</span>, <span class="at">assay_name =</span> <span class="st">&quot;relabundance&quot;</span>)</span>
<span id="cb237-3"><a href="community-similarity.html#cb237-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb237-4"><a href="community-similarity.html#cb237-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Naming all the rest of non top-taxa as &quot;Other&quot;</span></span>
<span id="cb237-5"><a href="community-similarity.html#cb237-5" aria-hidden="true" tabindex="-1"></a>most_abundant <span class="ot">&lt;-</span> <span class="fu">lapply</span>(<span class="fu">colData</span>(tse_Genus)<span class="sc">$</span>dominant_taxa,</span>
<span id="cb237-6"><a href="community-similarity.html#cb237-6" aria-hidden="true" tabindex="-1"></a>                   <span class="cf">function</span>(x){<span class="cf">if</span> (x <span class="sc">%in%</span> top_taxa) {x} <span class="cf">else</span> {<span class="st">&quot;Other&quot;</span>}})</span>
<span id="cb237-7"><a href="community-similarity.html#cb237-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb237-8"><a href="community-similarity.html#cb237-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Storing the previous results as a new column within colData</span></span>
<span id="cb237-9"><a href="community-similarity.html#cb237-9" aria-hidden="true" tabindex="-1"></a><span class="fu">colData</span>(tse_Genus)<span class="sc">$</span>most_abundant <span class="ot">&lt;-</span> <span class="fu">as.character</span>(most_abundant)</span>
<span id="cb237-10"><a href="community-similarity.html#cb237-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb237-11"><a href="community-similarity.html#cb237-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculating percentage of the most abundant</span></span>
<span id="cb237-12"><a href="community-similarity.html#cb237-12" aria-hidden="true" tabindex="-1"></a>most_abundant_freq <span class="ot">&lt;-</span> <span class="fu">table</span>(<span class="fu">as.character</span>(most_abundant))</span>
<span id="cb237-13"><a href="community-similarity.html#cb237-13" aria-hidden="true" tabindex="-1"></a>most_abundant_percent <span class="ot">&lt;-</span> <span class="fu">round</span>(most_abundant_freq<span class="sc">/</span><span class="fu">sum</span>(most_abundant_freq)<span class="sc">*</span><span class="dv">100</span>, <span class="dv">1</span>)</span>
<span id="cb237-14"><a href="community-similarity.html#cb237-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb237-15"><a href="community-similarity.html#cb237-15" aria-hidden="true" tabindex="-1"></a><span class="co"># Retrieving the explained variance</span></span>
<span id="cb237-16"><a href="community-similarity.html#cb237-16" aria-hidden="true" tabindex="-1"></a>e <span class="ot">&lt;-</span> <span class="fu">attr</span>(<span class="fu">reducedDim</span>(tse_Genus, <span class="st">&quot;PCoA_BC&quot;</span>), <span class="st">&quot;eig&quot;</span>);</span>
<span id="cb237-17"><a href="community-similarity.html#cb237-17" aria-hidden="true" tabindex="-1"></a>var_explained <span class="ot">&lt;-</span> e<span class="sc">/</span><span class="fu">sum</span>(e[e<span class="sc">&gt;</span><span class="dv">0</span>])<span class="sc">*</span><span class="dv">100</span></span>
<span id="cb237-18"><a href="community-similarity.html#cb237-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb237-19"><a href="community-similarity.html#cb237-19" aria-hidden="true" tabindex="-1"></a><span class="co"># Visualization</span></span>
<span id="cb237-20"><a href="community-similarity.html#cb237-20" aria-hidden="true" tabindex="-1"></a>plot <span class="ot">&lt;-</span><span class="fu">plotReducedDim</span>(tse_Genus,<span class="st">&quot;PCoA_BC&quot;</span>, <span class="at">colour_by =</span> <span class="st">&quot;most_abundant&quot;</span>) <span class="sc">+</span></span>
<span id="cb237-21"><a href="community-similarity.html#cb237-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_colour_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">&quot;black&quot;</span>, <span class="st">&quot;blue&quot;</span>, <span class="st">&quot;lightblue&quot;</span>, <span class="st">&quot;darkgray&quot;</span>, <span class="st">&quot;magenta&quot;</span>, <span class="st">&quot;darkgreen&quot;</span>, <span class="st">&quot;red&quot;</span>),</span>
<span id="cb237-22"><a href="community-similarity.html#cb237-22" aria-hidden="true" tabindex="-1"></a>                      <span class="at">labels=</span><span class="fu">paste0</span>(<span class="fu">names</span>(most_abundant_percent),<span class="st">&quot;(&quot;</span>,most_abundant_percent,<span class="st">&quot;%)&quot;</span>))<span class="sc">+</span></span>
<span id="cb237-23"><a href="community-similarity.html#cb237-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x=</span><span class="fu">paste</span>(<span class="st">&quot;PC 1 (&quot;</span>,<span class="fu">round</span>(var_explained[<span class="dv">1</span>],<span class="dv">1</span>),<span class="st">&quot;%)&quot;</span>),</span>
<span id="cb237-24"><a href="community-similarity.html#cb237-24" aria-hidden="true" tabindex="-1"></a>       <span class="at">y=</span><span class="fu">paste</span>(<span class="st">&quot;PC 2 (&quot;</span>,<span class="fu">round</span>(var_explained[<span class="dv">2</span>],<span class="dv">1</span>),<span class="st">&quot;%)&quot;</span>),</span>
<span id="cb237-25"><a href="community-similarity.html#cb237-25" aria-hidden="true" tabindex="-1"></a>       <span class="at">color=</span><span class="st">&quot;&quot;</span>)</span>
<span id="cb237-26"><a href="community-similarity.html#cb237-26" aria-hidden="true" tabindex="-1"></a>plot</span></code></pre></div>
<p><img src="20_beta_diversity_files/figure-html/unnamed-chunk-7-1.png" width="3000" /></p>
<p>Note: A 3D interactive version of the earlier plot can be found from <a href="https://microbiome.github.io/OMA/interactive-3d-plots.html">here</a>.</p>
<p>Similarly let’s visualize and compare the sub-population.</p>
<div class="sourceCode" id="cb238"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb238-1"><a href="community-similarity.html#cb238-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculating the frequencies and percentages for both categories</span></span>
<span id="cb238-2"><a href="community-similarity.html#cb238-2" aria-hidden="true" tabindex="-1"></a>freq_TRUE <span class="ot">&lt;-</span> <span class="fu">table</span>(<span class="fu">as.character</span>(most_abundant[<span class="fu">colData</span>(tse_Genus)<span class="sc">$</span>Group<span class="sc">==</span><span class="cn">TRUE</span>]))</span>
<span id="cb238-3"><a href="community-similarity.html#cb238-3" aria-hidden="true" tabindex="-1"></a>freq_FALSE <span class="ot">&lt;-</span> <span class="fu">table</span>(<span class="fu">as.character</span>(most_abundant[<span class="fu">colData</span>(tse_Genus)<span class="sc">$</span>Group<span class="sc">==</span><span class="cn">FALSE</span>]))</span>
<span id="cb238-4"><a href="community-similarity.html#cb238-4" aria-hidden="true" tabindex="-1"></a>percent_TRUE <span class="ot">&lt;-</span> <span class="fu">round</span>(freq_TRUE<span class="sc">/</span><span class="fu">sum</span>(freq_TRUE)<span class="sc">*</span><span class="dv">100</span>, <span class="dv">1</span>)</span>
<span id="cb238-5"><a href="community-similarity.html#cb238-5" aria-hidden="true" tabindex="-1"></a>percent_FALSE <span class="ot">&lt;-</span> <span class="fu">round</span>(freq_FALSE<span class="sc">/</span><span class="fu">sum</span>(freq_FALSE)<span class="sc">*</span><span class="dv">100</span>, <span class="dv">1</span>)</span>
<span id="cb238-6"><a href="community-similarity.html#cb238-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb238-7"><a href="community-similarity.html#cb238-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Visualization</span></span>
<span id="cb238-8"><a href="community-similarity.html#cb238-8" aria-hidden="true" tabindex="-1"></a><span class="fu">plotReducedDim</span>(tse_Genus[,<span class="fu">colData</span>(tse_Genus)<span class="sc">$</span>Group<span class="sc">==</span><span class="cn">TRUE</span>],</span>
<span id="cb238-9"><a href="community-similarity.html#cb238-9" aria-hidden="true" tabindex="-1"></a>                          <span class="st">&quot;PCoA_BC&quot;</span>, <span class="at">colour_by =</span> <span class="st">&quot;most_abundant&quot;</span>) <span class="sc">+</span></span>
<span id="cb238-10"><a href="community-similarity.html#cb238-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_colour_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">&quot;black&quot;</span>, <span class="st">&quot;blue&quot;</span>, <span class="st">&quot;lightblue&quot;</span>, <span class="st">&quot;darkgray&quot;</span>, <span class="st">&quot;magenta&quot;</span>, <span class="st">&quot;darkgreen&quot;</span>, <span class="st">&quot;red&quot;</span>),</span>
<span id="cb238-11"><a href="community-similarity.html#cb238-11" aria-hidden="true" tabindex="-1"></a>                      <span class="at">labels=</span><span class="fu">paste0</span>(<span class="fu">names</span>(percent_TRUE),<span class="st">&quot;(&quot;</span>,percent_TRUE,<span class="st">&quot;%)&quot;</span>))<span class="sc">+</span></span>
<span id="cb238-12"><a href="community-similarity.html#cb238-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x=</span><span class="fu">paste</span>(<span class="st">&quot;PC 1 (&quot;</span>,<span class="fu">round</span>(var_explained[<span class="dv">1</span>],<span class="dv">1</span>),<span class="st">&quot;%)&quot;</span>),</span>
<span id="cb238-13"><a href="community-similarity.html#cb238-13" aria-hidden="true" tabindex="-1"></a>       <span class="at">y=</span><span class="fu">paste</span>(<span class="st">&quot;PC 2 (&quot;</span>,<span class="fu">round</span>(var_explained[<span class="dv">2</span>],<span class="dv">1</span>),<span class="st">&quot;%)&quot;</span>),</span>
<span id="cb238-14"><a href="community-similarity.html#cb238-14" aria-hidden="true" tabindex="-1"></a>       <span class="at">title =</span> <span class="st">&quot;Group = TRUE&quot;</span>, <span class="at">color=</span><span class="st">&quot;&quot;</span>)</span></code></pre></div>
<p><img src="20_beta_diversity_files/figure-html/unnamed-chunk-8-1.png" width="3000" /></p>
<div class="sourceCode" id="cb239"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb239-1"><a href="community-similarity.html#cb239-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plotReducedDim</span>(tse_Genus[,<span class="fu">colData</span>(tse_Genus)<span class="sc">$</span>Group<span class="sc">==</span><span class="cn">FALSE</span>],</span>
<span id="cb239-2"><a href="community-similarity.html#cb239-2" aria-hidden="true" tabindex="-1"></a>                          <span class="st">&quot;PCoA_BC&quot;</span>, <span class="at">colour_by =</span> <span class="st">&quot;most_abundant&quot;</span>) <span class="sc">+</span></span>
<span id="cb239-3"><a href="community-similarity.html#cb239-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_colour_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">&quot;black&quot;</span>, <span class="st">&quot;blue&quot;</span>, <span class="st">&quot;lightblue&quot;</span>, <span class="st">&quot;darkgray&quot;</span>, <span class="st">&quot;magenta&quot;</span>, <span class="st">&quot;darkgreen&quot;</span>, <span class="st">&quot;red&quot;</span>),</span>
<span id="cb239-4"><a href="community-similarity.html#cb239-4" aria-hidden="true" tabindex="-1"></a>                      <span class="at">labels=</span><span class="fu">paste0</span>(<span class="fu">names</span>(percent_FALSE),<span class="st">&quot;(&quot;</span>,percent_FALSE,<span class="st">&quot;%)&quot;</span>))<span class="sc">+</span></span>
<span id="cb239-5"><a href="community-similarity.html#cb239-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x=</span><span class="fu">paste</span>(<span class="st">&quot;PC 1 (&quot;</span>,<span class="fu">round</span>(var_explained[<span class="dv">1</span>],<span class="dv">1</span>),<span class="st">&quot;%)&quot;</span>),</span>
<span id="cb239-6"><a href="community-similarity.html#cb239-6" aria-hidden="true" tabindex="-1"></a>       <span class="at">y=</span><span class="fu">paste</span>(<span class="st">&quot;PC 2 (&quot;</span>,<span class="fu">round</span>(var_explained[<span class="dv">2</span>],<span class="dv">1</span>),<span class="st">&quot;%)&quot;</span>),</span>
<span id="cb239-7"><a href="community-similarity.html#cb239-7" aria-hidden="true" tabindex="-1"></a>       <span class="at">title =</span> <span class="st">&quot;Group = FALSE&quot;</span>, <span class="at">color=</span><span class="st">&quot;&quot;</span>)</span></code></pre></div>
<p><img src="20_beta_diversity_files/figure-html/unnamed-chunk-8-2.png" width="3000" /></p>
<div id="testing-differences-in-community-composition-between-sample-groups" class="section level3 hasAnchor" number="8.4.1">
<h3><span class="header-section-number">8.4.1</span> Testing differences in community composition between sample groups<a href="community-similarity.html#testing-differences-in-community-composition-between-sample-groups" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>The permutational analysis of variance (PERMANOVA) <span class="citation">(<a href="#ref-Anderson2001" role="doc-biblioref">Anderson 2001</a>)</span> is
a widely used non-parametric multivariate method that can be used to
estimate the actual statistical significance of differences in the
observed community composition between two groups of
samples.</p>
<p>PERMANOVA evaluates the hypothesis that the centroids and dispersion
of the community are equivalent between the compared groups. A small
p-value indicates that the compared groups have, on average, a
different community composition.</p>
<p>This method is implemented in the <code>vegan</code> package in the function
<a href="https://www.rdocumentation.org/packages/vegan/versions/2.4-2/topics/adonis"><code>adonis2</code></a>.</p>
<p><strong>Note:</strong></p>
<p>It is recommended to <code>by = "margin"</code>. It specifies that each variable’s marginal
effect is analyzed individually.</p>
<p>When <code>by = "terms"</code> (the default) the order of variables matters;
each variable is analyzed sequentially, and the result is different when more than 1 variable is
introduced and their order is differs. (Check <a href="https://microbiome.github.io/OMA/extras.html#permanova-comparison">comparison</a>)</p>
<p>We can perform PERMANOVA with <code>adonis2</code> function or by first performing distance-based
redundancy analysis (dbRDA), and then applying permutational test for result of
redundancy analysis. Advantage of the latter approach is that by doing so we can get
coefficients: how much each taxa affect to the result.</p>
<div class="sourceCode" id="cb240"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb240-1"><a href="community-similarity.html#cb240-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>( <span class="sc">!</span><span class="fu">require</span>(vegan) ){</span>
<span id="cb240-2"><a href="community-similarity.html#cb240-2" aria-hidden="true" tabindex="-1"></a>    BiocManager<span class="sc">::</span><span class="fu">install</span>(<span class="st">&quot;vegan&quot;</span>)</span>
<span id="cb240-3"><a href="community-similarity.html#cb240-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">library</span>(<span class="st">&quot;vegan&quot;</span>)</span>
<span id="cb240-4"><a href="community-similarity.html#cb240-4" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb240-5"><a href="community-similarity.html#cb240-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Agglomerate data to Species level</span></span>
<span id="cb240-6"><a href="community-similarity.html#cb240-6" aria-hidden="true" tabindex="-1"></a>tse <span class="ot">&lt;-</span> <span class="fu">agglomerateByRank</span>(tse, <span class="at">rank =</span> <span class="st">&quot;Species&quot;</span>)</span>
<span id="cb240-7"><a href="community-similarity.html#cb240-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb240-8"><a href="community-similarity.html#cb240-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Set seed for reproducibility</span></span>
<span id="cb240-9"><a href="community-similarity.html#cb240-9" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">1576</span>)</span>
<span id="cb240-10"><a href="community-similarity.html#cb240-10" aria-hidden="true" tabindex="-1"></a><span class="co"># We choose 99 random permutations. Consider applying more (999 or 9999) in your</span></span>
<span id="cb240-11"><a href="community-similarity.html#cb240-11" aria-hidden="true" tabindex="-1"></a><span class="co"># analysis. </span></span>
<span id="cb240-12"><a href="community-similarity.html#cb240-12" aria-hidden="true" tabindex="-1"></a>permanova <span class="ot">&lt;-</span> <span class="fu">adonis2</span>(<span class="fu">t</span>(<span class="fu">assay</span>(tse,<span class="st">&quot;relabundance&quot;</span>)) <span class="sc">~</span> Group,</span>
<span id="cb240-13"><a href="community-similarity.html#cb240-13" aria-hidden="true" tabindex="-1"></a>                     <span class="at">by =</span> <span class="st">&quot;margin&quot;</span>, <span class="co"># each term (here only &#39;Group&#39;) analyzed individually</span></span>
<span id="cb240-14"><a href="community-similarity.html#cb240-14" aria-hidden="true" tabindex="-1"></a>                     <span class="at">data =</span> <span class="fu">colData</span>(tse),</span>
<span id="cb240-15"><a href="community-similarity.html#cb240-15" aria-hidden="true" tabindex="-1"></a>                     <span class="at">method =</span> <span class="st">&quot;euclidean&quot;</span>,</span>
<span id="cb240-16"><a href="community-similarity.html#cb240-16" aria-hidden="true" tabindex="-1"></a>                     <span class="at">permutations =</span> <span class="dv">99</span>)</span>
<span id="cb240-17"><a href="community-similarity.html#cb240-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb240-18"><a href="community-similarity.html#cb240-18" aria-hidden="true" tabindex="-1"></a><span class="co"># Set seed for reproducibility</span></span>
<span id="cb240-19"><a href="community-similarity.html#cb240-19" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">1576</span>)</span>
<span id="cb240-20"><a href="community-similarity.html#cb240-20" aria-hidden="true" tabindex="-1"></a><span class="co"># Perform dbRDA</span></span>
<span id="cb240-21"><a href="community-similarity.html#cb240-21" aria-hidden="true" tabindex="-1"></a>dbrda <span class="ot">&lt;-</span> <span class="fu">dbrda</span>(<span class="fu">t</span>(<span class="fu">assay</span>(tse,<span class="st">&quot;relabundance&quot;</span>)) <span class="sc">~</span> Group, </span>
<span id="cb240-22"><a href="community-similarity.html#cb240-22" aria-hidden="true" tabindex="-1"></a>               <span class="at">data =</span> <span class="fu">colData</span>(tse))</span>
<span id="cb240-23"><a href="community-similarity.html#cb240-23" aria-hidden="true" tabindex="-1"></a><span class="co"># Perform permutational analysis</span></span>
<span id="cb240-24"><a href="community-similarity.html#cb240-24" aria-hidden="true" tabindex="-1"></a>permanova2 <span class="ot">&lt;-</span> <span class="fu">anova.cca</span>(dbrda,</span>
<span id="cb240-25"><a href="community-similarity.html#cb240-25" aria-hidden="true" tabindex="-1"></a>                        <span class="at">by =</span> <span class="st">&quot;margin&quot;</span>, <span class="co"># each term (here only &#39;Group&#39;) analyzed individually</span></span>
<span id="cb240-26"><a href="community-similarity.html#cb240-26" aria-hidden="true" tabindex="-1"></a>                        <span class="at">method =</span> <span class="st">&quot;euclidean&quot;</span>,</span>
<span id="cb240-27"><a href="community-similarity.html#cb240-27" aria-hidden="true" tabindex="-1"></a>                        <span class="at">permutations =</span> <span class="dv">99</span>)</span>
<span id="cb240-28"><a href="community-similarity.html#cb240-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb240-29"><a href="community-similarity.html#cb240-29" aria-hidden="true" tabindex="-1"></a><span class="co"># Get p-values</span></span>
<span id="cb240-30"><a href="community-similarity.html#cb240-30" aria-hidden="true" tabindex="-1"></a>p_values <span class="ot">&lt;-</span> <span class="fu">c</span>( permanova[<span class="st">&quot;Group&quot;</span>, <span class="st">&quot;Pr(&gt;F)&quot;</span>], permanova2[<span class="st">&quot;Group&quot;</span>, <span class="st">&quot;Pr(&gt;F)&quot;</span>] )</span>
<span id="cb240-31"><a href="community-similarity.html#cb240-31" aria-hidden="true" tabindex="-1"></a>p_values <span class="ot">&lt;-</span><span class="fu">as.data.frame</span>(p_values)</span>
<span id="cb240-32"><a href="community-similarity.html#cb240-32" aria-hidden="true" tabindex="-1"></a><span class="fu">rownames</span>(p_values) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;adonis2&quot;</span>, <span class="st">&quot;dbRDA+anova.cca&quot;</span>)</span>
<span id="cb240-33"><a href="community-similarity.html#cb240-33" aria-hidden="true" tabindex="-1"></a>p_values</span></code></pre></div>
<pre><code>##                 p_values
## adonis2             0.02
## dbRDA+anova.cca     0.02</code></pre>
<p>As we can see, the community composition is significantly different
between the groups (p &lt; 0.05), and these two methods give equal p-values.</p>
<p>Let us visualize the model coefficients for species that exhibit the
largest differences between the groups. This gives some insights into
how the groups tend to differ from each other in terms of community
composition.</p>
<div class="sourceCode" id="cb242"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb242-1"><a href="community-similarity.html#cb242-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Add taxa info</span></span>
<span id="cb242-2"><a href="community-similarity.html#cb242-2" aria-hidden="true" tabindex="-1"></a><span class="fu">sppscores</span>(dbrda) <span class="ot">&lt;-</span> <span class="fu">t</span>(<span class="fu">assay</span>(tse,<span class="st">&quot;relabundance&quot;</span>))</span>
<span id="cb242-3"><a href="community-similarity.html#cb242-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Get coefficients</span></span>
<span id="cb242-4"><a href="community-similarity.html#cb242-4" aria-hidden="true" tabindex="-1"></a>coef <span class="ot">&lt;-</span> dbrda<span class="sc">$</span>CCA<span class="sc">$</span>v</span>
<span id="cb242-5"><a href="community-similarity.html#cb242-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Get the taxa with biggest weights</span></span>
<span id="cb242-6"><a href="community-similarity.html#cb242-6" aria-hidden="true" tabindex="-1"></a>top.coef <span class="ot">&lt;-</span> <span class="fu">head</span>( coef[<span class="fu">rev</span>(<span class="fu">order</span>(<span class="fu">abs</span>(coef))), , <span class="at">drop =</span> <span class="cn">FALSE</span>], <span class="dv">20</span>)</span>
<span id="cb242-7"><a href="community-similarity.html#cb242-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Sort weights in increasing order</span></span>
<span id="cb242-8"><a href="community-similarity.html#cb242-8" aria-hidden="true" tabindex="-1"></a>top.coef <span class="ot">&lt;-</span> top.coef[ <span class="fu">order</span>(top.coef), ]</span>
<span id="cb242-9"><a href="community-similarity.html#cb242-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Get top names</span></span>
<span id="cb242-10"><a href="community-similarity.html#cb242-10" aria-hidden="true" tabindex="-1"></a>top_names <span class="ot">&lt;-</span> <span class="fu">names</span>(top.coef)[ <span class="fu">order</span>(<span class="fu">abs</span>(top.coef), <span class="at">decreasing =</span> <span class="cn">TRUE</span>) ]</span></code></pre></div>
<div class="sourceCode" id="cb243"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb243-1"><a href="community-similarity.html#cb243-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="fu">data.frame</span>(<span class="at">x =</span> top.coef,</span>
<span id="cb243-2"><a href="community-similarity.html#cb243-2" aria-hidden="true" tabindex="-1"></a>                  <span class="at">y =</span> <span class="fu">factor</span>(<span class="fu">names</span>(top.coef),</span>
<span id="cb243-3"><a href="community-similarity.html#cb243-3" aria-hidden="true" tabindex="-1"></a>                                      <span class="fu">unique</span>(<span class="fu">names</span>(top.coef)))),</span>
<span id="cb243-4"><a href="community-similarity.html#cb243-4" aria-hidden="true" tabindex="-1"></a>        <span class="fu">aes</span>(<span class="at">x =</span> x, <span class="at">y =</span> y)) <span class="sc">+</span></span>
<span id="cb243-5"><a href="community-similarity.html#cb243-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_bar</span>(<span class="at">stat=</span><span class="st">&quot;identity&quot;</span>) <span class="sc">+</span></span>
<span id="cb243-6"><a href="community-similarity.html#cb243-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">x=</span><span class="st">&quot;&quot;</span>,<span class="at">y=</span><span class="st">&quot;&quot;</span>,<span class="at">title=</span><span class="st">&quot;Top Taxa&quot;</span>) <span class="sc">+</span></span>
<span id="cb243-7"><a href="community-similarity.html#cb243-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_bw</span>()</span></code></pre></div>
<p><img src="20_beta_diversity_files/figure-html/plot-top-coef-anova-1.png" width="3000" /></p>
<p>In the above example, the largest differences between the two groups
can be attributed to <em>Genus:Bacteroides</em> (elevated in the first
group) and <em>Family:Ruminococcaceae</em> (elevated in the second
group), and many other co-varying species.</p>
</div>
<div id="checking-the-homogeneity-condition" class="section level3 hasAnchor" number="8.4.2">
<h3><span class="header-section-number">8.4.2</span> Checking the homogeneity condition<a href="community-similarity.html#checking-the-homogeneity-condition" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>It is important to note that the application of PERMANOVA assumes
homogeneous group dispersions (variances). This can be tested with the
PERMDISP2 method <span class="citation">(<a href="#ref-Anderson2006" role="doc-biblioref">Anderson 2006</a>)</span> by using the same assay and distance
method than in PERMANOVA.</p>
<div class="sourceCode" id="cb244"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb244-1"><a href="community-similarity.html#cb244-1" aria-hidden="true" tabindex="-1"></a><span class="fu">anova</span>( <span class="fu">betadisper</span>(<span class="fu">vegdist</span>(<span class="fu">t</span>(<span class="fu">assay</span>(tse, <span class="st">&quot;counts&quot;</span>))), <span class="fu">colData</span>(tse)<span class="sc">$</span>Group) )</span></code></pre></div>
<pre><code>## Analysis of Variance Table
## 
## Response: Distances
##           Df Sum Sq Mean Sq F value  Pr(&gt;F)    
## Groups     1 0.2385  0.2385     103 3.6e-10 ***
## Residuals 24 0.0554  0.0023                    
## ---
## Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1</code></pre>
<p>If the groups have similar dispersion, PERMANOVA can be seen as an
appropriate choice for comparing community compositions.</p>
</div>
</div>
<div id="further-reading" class="section level2 hasAnchor" number="8.5">
<h2><span class="header-section-number">8.5</span> Further reading<a href="community-similarity.html#further-reading" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<ul>
<li><p><a href="http://bioconductor.org/books/release/OSCA/clustering.html">How to extract information from clusters</a></p></li>
<li><p>Chapter <a href="clustering.html#clustering">10</a> on community typing</p></li>
</ul>
</div>
<div id="session-info-5" class="section level2 unnumbered hasAnchor">
<h2>Session Info<a href="community-similarity.html#session-info-5" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<button class="rebook-collapse">
View session info
</button>
<div class="rebook-content">
<pre><code>R version 4.2.1 (2022-06-23)
Platform: x86_64-pc-linux-gnu (64-bit)
Running under: Ubuntu 20.04.4 LTS

Matrix products: default
BLAS:   /usr/lib/x86_64-linux-gnu/openblas-pthread/libblas.so.3
LAPACK: /usr/lib/x86_64-linux-gnu/openblas-pthread/liblapack.so.3

locale:
 [1] LC_CTYPE=en_US.UTF-8       LC_NUMERIC=C              
 [3] LC_TIME=en_US.UTF-8        LC_COLLATE=en_US.UTF-8    
 [5] LC_MONETARY=en_US.UTF-8    LC_MESSAGES=en_US.UTF-8   
 [7] LC_PAPER=en_US.UTF-8       LC_NAME=C                 
 [9] LC_ADDRESS=C               LC_TELEPHONE=C            
[11] LC_MEASUREMENT=en_US.UTF-8 LC_IDENTIFICATION=C       

attached base packages:
[1] stats4    stats     graphics  grDevices utils     datasets  methods  
[8] base     

other attached packages:
 [1] ggord_1.1.7                    knitr_1.40                    
 [3] stringr_1.4.1                  patchwork_1.1.2               
 [5] scater_1.24.0                  scuttle_1.6.3                 
 [7] ggplot2_3.3.6                  vegan_2.6-2                   
 [9] lattice_0.20-45                permute_0.9-7                 
[11] mia_1.5.16                     MultiAssayExperiment_1.22.0   
[13] TreeSummarizedExperiment_2.1.4 Biostrings_2.64.1             
[15] XVector_0.36.0                 SingleCellExperiment_1.18.1   
[17] SummarizedExperiment_1.26.1    Biobase_2.56.0                
[19] GenomicRanges_1.48.0           GenomeInfoDb_1.32.4           
[21] IRanges_2.30.1                 S4Vectors_0.34.0              
[23] BiocGenerics_0.42.0            MatrixGenerics_1.8.1          
[25] matrixStats_0.62.0-9003        BiocStyle_2.24.0              
[27] rebook_1.6.0                  

loaded via a namespace (and not attached):
 [1] Rtsne_0.16                  ggbeeswarm_0.6.0           
 [3] colorspace_2.0-3            BiocNeighbors_1.14.0       
 [5] farver_2.1.1                ggrepel_0.9.1              
 [7] bit64_4.0.5                 fansi_1.0.3                
 [9] decontam_1.16.0             splines_4.2.1              
[11] codetools_0.2-18            sparseMatrixStats_1.8.0    
[13] cachem_1.0.6                jsonlite_1.8.2             
[15] cluster_2.1.4               graph_1.74.0               
[17] BiocManager_1.30.18         compiler_4.2.1             
[19] assertthat_0.2.1            Matrix_1.5-1               
[21] fastmap_1.1.0               lazyeval_0.2.2             
[23] cli_3.4.1                   BiocSingular_1.12.0        
[25] htmltools_0.5.3             tools_4.2.1                
[27] rsvd_1.0.5                  gtable_0.3.1               
[29] glue_1.6.2                  GenomeInfoDbData_1.2.8     
[31] reshape2_1.4.4              dplyr_1.0.10               
[33] Rcpp_1.0.9                  jquerylib_0.1.4            
[35] vctrs_0.4.2                 ape_5.6-2                  
[37] nlme_3.1-159                DECIPHER_2.24.0            
[39] DelayedMatrixStats_1.18.1   xfun_0.33                  
[41] beachmat_2.12.0             lifecycle_1.0.2            
[43] irlba_2.3.5.1               XML_3.99-0.11              
[45] zlibbioc_1.42.0             MASS_7.3-58.1              
[47] scales_1.2.1                parallel_4.2.1             
[49] yaml_2.3.5                  memoise_2.0.1              
[51] gridExtra_2.3               yulab.utils_0.0.5          
[53] sass_0.4.2                  stringi_1.7.8              
[55] RSQLite_2.2.18              highr_0.9                  
[57] ScaledMatrix_1.4.1          tidytree_0.4.1             
[59] filelock_1.0.2              BiocParallel_1.30.3        
[61] rlang_1.0.6                 pkgconfig_2.0.3            
[63] bitops_1.0-7                evaluate_0.16              
[65] purrr_0.3.4                 labeling_0.4.2             
[67] treeio_1.20.2               CodeDepends_0.6.5          
[69] cowplot_1.1.1               bit_4.0.4                  
[71] tidyselect_1.1.2            plyr_1.8.7                 
[73] magrittr_2.0.3              bookdown_0.29              
[75] R6_2.5.1                    generics_0.1.3             
[77] DelayedArray_0.22.0         DBI_1.1.3                  
[79] withr_2.5.0                 mgcv_1.8-40                
[81] pillar_1.8.1                RCurl_1.98-1.9             
[83] tibble_3.1.8                dir.expiry_1.4.0           
[85] crayon_1.5.2                utf8_1.2.2                 
[87] rmarkdown_2.16              viridis_0.6.2              
[89] grid_4.2.1                  blob_1.2.3                 
[91] digest_0.6.29               tidyr_1.2.1                
[93] munsell_0.5.0               DirichletMultinomial_1.38.0
[95] beeswarm_0.4.0              viridisLite_0.4.1          
[97] vipor_0.4.5                 bslib_0.4.0                </code></pre>
</div>

</div>
</div>
<h3>Bibliography<a href="bibliography.html#bibliography" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<div id="refs" class="references csl-bib-body hanging-indent">
<div id="ref-Anderson2001" class="csl-entry">
Anderson, Marti J. 2001. <span>“A New Method for Non-Parametric Multivariate Analysis of Variance.”</span> <em>Austral Ecology</em> 26 (1): 32–46. <a href="https://doi.org/10.1111/j.1442-9993.2001.01070.pp.x">https://doi.org/10.1111/j.1442-9993.2001.01070.pp.x</a>.
</div>
<div id="ref-Anderson2006" class="csl-entry">
———. 2006. <span>“Distance-Based Tests for Homogeneity of Multivariate Dispersions.”</span> <em>Biometrics</em> 62: 245–53. <a href="https://doi.org/10.1111/j.1541-0420.2005.00440.x">https://doi.org/10.1111/j.1541-0420.2005.00440.x</a>.
</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="community-diversity.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="microbiome-community.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": true,
"facebook": false,
"twitter": true,
"linkedin": true,
"weibo": false,
"instapaper": false,
"vk": false,
"whatsapp": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": null,
"text": null
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": ["OMA.pdf"],
"search": {
"engine": "fuse",
"options": null
},
"toc": {
"collapse": "subsection"
}
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.9/latest.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
